name: Preflight - GCP capacity
description: Ensure at least one healthy verified GCP agent exists by requesting billed capacity via the control plane

inputs:
  control_plane_url:
    description: EasyEnclave control plane URL
    required: false
    default: "https://app.easyenclave.com"
  node_size:
    description: Agent node_size to provision (e.g. tiny)
    required: false
    default: "tiny"
  wait_seconds:
    description: Seconds to wait for agent registration
    required: false
    default: "900"

  # Billing-backed capacity request credentials.
  billing_account_id:
    description: Billing deployer account_id used for capacity purchases
    required: false
    default: ""
  billing_api_key:
    description: Billing account API key (Authorization Bearer)
    required: false
    default: ""
  billing_months:
    description: Number of months to purchase for requested warm capacity
    required: false
    default: "1"

  # Preferred CP dispatch target. If empty, first entry from gcp_zone is used.
  gcp_datacenter:
    description: Datacenter label to request from control plane (e.g. gcp:us-central1-a)
    required: false
    default: ""

  # Optional launcher fulfillment (CI datacenter-manager).
  # If these are provided and no GCP capacity exists, the action will provision a CVM on GCP
  # by claiming the CP's launch order (scripts/capacity_launcher_worker.py).
  # NOTE: Intel API keys are no longer required on agents; the control plane mints ITA
  # tokens from quote_b64 when configured. Retained as a deprecated input for callers.
  intel_api_key:
    description: Deprecated (ignored)
    required: false
    default: ""

  # Deprecated legacy inputs retained for compatibility with existing workflow callers.
  gcp_project_id:
    description: GCP project ID (required to provision from CI)
    required: false
    default: ""
  gcp_wif_provider:
    description: Deprecated (ignored)
    required: false
    default: ""
  gcp_wif_service_account:
    description: Deprecated (ignored)
    required: false
    default: ""
  gcp_service_account_key:
    description: GCP service account JSON key (required to provision from CI)
    required: false
    default: ""
  gcp_zone:
    description: Comma-separated zones; first entry is used as default dispatch target
    required: false
    default: "us-central1-a,us-central1-b,us-central1-c,us-central1-f,us-east4-a,us-west1-b"
  gcp_region:
    description: Deprecated (ignored)
    required: false
    default: ""
  gcp_machine_type:
    description: Deprecated (ignored)
    required: false
    default: ""
  gcp_boot_disk_size:
    description: Deprecated (ignored)
    required: false
    default: ""

outputs:
  gcp_eligible_agents:
    description: Count of eligible verified healthy GCP agents after preflight
    value: ${{ steps.final.outputs.gcp_eligible_agents }}
  gcp_provisioned:
    description: Whether the action attempted provisioning (true/false)
    value: ${{ steps.final.outputs.gcp_provisioned }}

runs:
  using: composite
  steps:
    - name: Resolve billing capacity credentials
      id: billing
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        BILLING_ACCOUNT_ID: ${{ inputs.billing_account_id }}
        BILLING_API_KEY: ${{ inputs.billing_api_key }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
      run: |
        set -euo pipefail
        account_id="$(echo "${BILLING_ACCOUNT_ID:-}" | xargs)"
        api_key="$(echo "${BILLING_API_KEY:-}" | xargs)"

        create_account() {
          local account_name body http_code resp
          account_name="ci-gcp-preflight-${GITHUB_RUN_ID:-local}-${GITHUB_RUN_ATTEMPT:-1}-$(date +%s)"
          body="$(mktemp)"
          http_code="$(
            curl -sS -o "$body" -w "%{http_code}" \
              -X POST "$CP_URL/api/v1/accounts" \
              -H "Content-Type: application/json" \
              -d "$(jq -cn --arg name "$account_name" '{name: $name, account_type: "deployer"}')" \
              || echo 000
          )"
          resp="$(cat "$body")"
          rm -f "$body"
          if [ "$http_code" -ge 400 ]; then
            detail="$(echo "$resp" | jq -r '.detail // empty' 2>/dev/null || true)"
            echo "::error::Failed to create deployer billing account (HTTP $http_code): ${detail:-$resp}"
            exit 1
          fi
          account_id="$(echo "$resp" | jq -r '.account_id // empty')"
          api_key="$(echo "$resp" | jq -r '.api_key // empty')"
          if [ -z "$account_id" ] || [ -z "$api_key" ]; then
            echo "::error::Control plane did not return billing account credentials"
            exit 1
          fi
          echo "Created transient deployer billing account: $account_id"
        }

        if [ -n "$account_id" ] && [ -n "$api_key" ]; then
          probe_body="$(mktemp)"
          probe_code="$(
            curl -sS -o "$probe_body" -w "%{http_code}" \
              -H "Authorization: Bearer ${api_key}" \
              -H "Accept: application/json" \
              "$CP_URL/api/v1/accounts/${account_id}" \
              || echo 000
          )"
          if [ "$probe_code" -ge 400 ]; then
            probe_resp="$(cat "$probe_body")"
            probe_detail="$(echo "$probe_resp" | jq -r '.detail // empty' 2>/dev/null || true)"
            echo "::warning::Provided billing credentials are invalid for this control plane (HTTP $probe_code): ${probe_detail:-$probe_resp}"
            echo "::warning::Creating transient deployer billing account for this run."
            create_account
          else
            echo "Using provided billing account for GCP preflight capacity request."
          fi
          rm -f "$probe_body"
        else
          echo "::warning::billing_account_id or billing_api_key not provided; creating transient deployer billing account."
          create_account
        fi

        echo "::add-mask::${api_key}"
        echo "billing_account_id=${account_id}" >> "$GITHUB_OUTPUT"
        echo "billing_api_key=${api_key}" >> "$GITHUB_OUTPUT"

    - name: Precheck - healthy verified GCP agents
      id: precheck
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        NODE_SIZE: ${{ inputs.node_size }}
      run: |
        set -euo pipefail
        agents="$(curl -sSf -H 'Accept: application/json' "$CP_URL/api/v1/agents")"
        count="$(
          echo "${agents:-}" | jq --arg ns "${NODE_SIZE:-}" '
            [.agents[]
              | (.datacenter // "" | ascii_downcase) as $dc
              | (.status // "" | ascii_downcase) as $st
              | select(.verified == true
                and (.health_status // "" | ascii_downcase) == "healthy"
                and (if ($ns | length) > 0 then ((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase)) else true end)
                and ($st == "undeployed" or ($st == "deployed" and ((.deployed_app // "") | test("^measuring-enclave") | not)))
                and ($dc | startswith("gcp:") or $dc == "gcp"))
            ] | length
          ' 2>/dev/null || echo 0
        )"

        echo "gcp_eligible_agents=$count" >> "$GITHUB_OUTPUT"

        if [ "$count" -gt 0 ]; then
          echo "Found $count eligible GCP agents."
          echo "need_provision=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "need_provision=true" >> "$GITHUB_OUTPUT"
        echo "::warning::No healthy verified GCP agents available; requesting control-plane capacity dispatch."

    - name: Request control-plane GCP capacity dispatch
      if: steps.precheck.outputs.need_provision == 'true'
      id: dispatch
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        BILLING_ACCOUNT_ID: ${{ steps.billing.outputs.billing_account_id }}
        BILLING_API_KEY: ${{ steps.billing.outputs.billing_api_key }}
        BILLING_MONTHS: ${{ inputs.billing_months }}
        NODE_SIZE: ${{ inputs.node_size }}
        GCP_DATACENTER: ${{ inputs.gcp_datacenter }}
        GCP_ZONE: ${{ inputs.gcp_zone }}
      run: |
        set -euo pipefail
        if [ -z "${BILLING_ACCOUNT_ID:-}" ] || [ -z "${BILLING_API_KEY:-}" ]; then
          echo "::error::Missing billing credentials for capacity purchase."
          exit 1
        fi
        if ! echo "${BILLING_MONTHS:-1}" | grep -Eq '^[1-9][0-9]*$'; then
          echo "::error::Invalid billing_months='${BILLING_MONTHS:-}'. Expected integer >= 1."
          exit 1
        fi

        target_dc="$(echo "${GCP_DATACENTER:-}" | tr '[:upper:]' '[:lower:]' | xargs)"
        if [ -z "$target_dc" ]; then
          first_zone="$(echo "${GCP_ZONE:-}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d' | head -n1)"
          first_zone="$(echo "$first_zone" | tr '[:upper:]' '[:lower:]')"
          if [ -n "$first_zone" ]; then
            case "$first_zone" in
              gcp:*)
                target_dc="$first_zone"
                ;;
              *)
                target_dc="gcp:$first_zone"
                ;;
            esac
          else
            target_dc="gcp"
          fi
        fi

        payload="$(jq -cn \
          --arg dc "$target_dc" \
          --arg ns "${NODE_SIZE:-}" \
          --argjson months "${BILLING_MONTHS:-1}" \
          --arg reason "deploy-example-gcp-preflight-${GITHUB_RUN_ID:-local}-${GITHUB_RUN_ATTEMPT:-1}" \
          '{
            datacenter: $dc,
            node_size: $ns,
            min_warm_count: 1,
            months: $months,
            reason: $reason
          }'
        )"

        # Cloudflare may temporarily return 530/1033 when the tunnel flaps. Retry briefly.
        resp=""
        http_code="000"
        for attempt in $(seq 1 20); do
          body="$(mktemp)"
          http_code="$(
            curl -sS -o "$body" -w "%{http_code}" \
              -X POST "$CP_URL/api/v1/accounts/${BILLING_ACCOUNT_ID}/capacity/request" \
              -H "Authorization: Bearer ${BILLING_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "$payload" || echo 000
          )"
          resp="$(cat "$body")"
          rm -f "$body"

          if [ "$http_code" = "530" ]; then
            echo "::warning::Control plane temporarily unavailable (HTTP 530). Retrying ($attempt/20)..."
            sleep 3
            continue
          fi
          if [ "$http_code" = "000" ] || [ "$http_code" -ge 500 ]; then
            echo "::warning::Control plane request failed (HTTP ${http_code}). Retrying ($attempt/20)..."
            sleep 3
            continue
          fi
          break
        done

        if [ "$http_code" -ge 400 ]; then
          if [ "$http_code" = "404" ]; then
            echo "::error::Control plane is missing billing capacity endpoint /api/v1/accounts/{account_id}/capacity/request. Deploy a newer control plane first."
            echo "::error::Response: ${resp:-empty}"
            exit 1
          fi
          detail="$(echo "$resp" | jq -r '.detail // empty' 2>/dev/null || true)"
          echo "::error::Control-plane dispatch request failed (HTTP $http_code): ${detail:-$resp}"
          exit 1
        fi

        shortfall="$(echo "$resp" | jq -r '.capacity.targets[0].shortfall // 0' 2>/dev/null || echo 0)"
        dispatched="$(echo "$resp" | jq -r '.capacity.dispatches[0].dispatched // false' 2>/dev/null || echo false)"
        detail="$(echo "$resp" | jq -r '.capacity.dispatches[0].detail // empty' 2>/dev/null || true)"
        status_code="$(echo "$resp" | jq -r '.capacity.dispatches[0].status_code // empty' 2>/dev/null || true)"
        tx_id="$(echo "$resp" | jq -r '.transaction_id // empty' 2>/dev/null || true)"
        charged="$(echo "$resp" | jq -r '.charged_amount_usd // 0' 2>/dev/null || echo 0)"
        simulated="$(echo "$resp" | jq -r '.simulated_payment // false' 2>/dev/null || echo false)"

        echo "target_datacenter=$target_dc" >> "$GITHUB_OUTPUT"
        echo "provisioned=$dispatched" >> "$GITHUB_OUTPUT"
        if [ -n "$tx_id" ]; then
          echo "transaction_id=$tx_id" >> "$GITHUB_OUTPUT"
        fi

        if [ "${shortfall:-0}" -gt 0 ] && [ "$dispatched" != "true" ]; then
          echo "::error::Control plane reported shortfall=$shortfall but did not dispatch provisioning."
          if [ -n "$detail" ]; then
            echo "::error::$detail"
          fi
          if [ -n "$status_code" ]; then
            echo "::error::Dispatch status_code=$status_code"
          fi
          exit 1
        fi

        echo "Capacity request accepted: datacenter='$target_dc' node_size='${NODE_SIZE:-}' shortfall=$shortfall dispatched=$dispatched tx_id=${tx_id:-none} charged=${charged} simulated=${simulated}"

    # NOTE: provisioning is now expected to happen inside the control plane (datacenter-manager),
    # not in GitHub Actions. The action only dispatches and waits.

    - name: Bootstrap trusted MRTD for GCP agents (admin, CI-only)
      if: steps.precheck.outputs.need_provision == 'true'
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        NODE_SIZE: ${{ inputs.node_size }}
        WAIT_SECONDS: ${{ inputs.wait_seconds }}
      run: |
        set -euo pipefail

        # Wait for the freshly-provisioned VM to register as an unverified agent.
        # This avoids a race where the CI launcher fulfills the order but the VM
        # hasn't completed cloud-init / launcher startup yet.
        deadline=$(( $(date +%s) + ${WAIT_SECONDS:-900} ))
        mrtd=""
        while :; do
          agents="$(curl -sS -H 'Accept: application/json' "$CP_URL/api/v1/agents" || true)"
          if [ -z "${agents:-}" ]; then
            echo "::warning::Control plane temporarily unavailable while waiting for GCP agent registration; retrying..."
            sleep 10
            continue
          fi

          # If capacity is already eligible, no need to bootstrap trust.
          eligible="$(
            echo "${agents:-}" | jq --arg ns "${NODE_SIZE:-}" '
              [.agents[]
                | (.datacenter // "" | ascii_downcase) as $dc
                | (.status // "" | ascii_downcase) as $st
                | select(.verified == true
                  and (.health_status // "" | ascii_downcase) == "healthy"
                  and (if ($ns | length) > 0 then ((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase)) else true end)
                  and ($st == "undeployed" or ($st == "deployed" and ((.deployed_app // "") | test("^measuring-enclave") | not)))
                  and (($dc | startswith("gcp:")) or ($dc == "gcp")))
              ] | length
            ' 2>/dev/null || echo 0
          )"
          if [ "${eligible:-0}" -gt 0 ]; then
            echo "Eligible GCP capacity already available; skipping trust bootstrap."
            exit 0
          fi

          # Pick the first unverified GCP agent for this size that reported an MRTD.
          mrtd="$(
            echo "$agents" | jq -r --arg ns "${NODE_SIZE:-}" '
              [.agents[]
                | select(.verified == false)
                | (.datacenter // "" | ascii_downcase) as $dc
                | select(($dc | startswith("gcp:")) or ($dc == "gcp"))
                | select((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase))
                | select((.mrtd // "") | length > 0)
                | .mrtd
              ][0] // empty
            ' 2>/dev/null || true
          )"
          if [ -n "${mrtd:-}" ]; then
            break
          fi

          now="$(date +%s)"
          if [ "$now" -ge "$deadline" ]; then
            echo "::error::Timed out waiting for a newly-provisioned GCP agent to register with an MRTD (node_size='${NODE_SIZE:-}')."
            echo "Observed GCP agents (debug):"
            echo "$agents" | jq -r --arg ns "${NODE_SIZE:-}" '
              [.agents[]
                | (.datacenter // "" | ascii_downcase) as $dc
                | select(($dc | startswith("gcp:")) or ($dc == "gcp"))
                | (if ($ns|length)>0 then select((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase)) else . end)
                | {
                    agent_id,
                    vm_name,
                    node_size,
                    datacenter,
                    verified,
                    health_status,
                    status,
                    deployed_app,
                    mrtd_present: ((.mrtd // "") | length > 0)
                  }
              ]'
            exit 1
          fi
          sleep 10
        done

        if ! echo "$mrtd" | grep -Eq '^[0-9a-fA-F]{96}$'; then
          echo "::warning::Agent reported invalid MRTD format; skipping trust bootstrap."
          exit 0
        fi
        mrtd="$(echo "$mrtd" | tr '[:upper:]' '[:lower:]')"

        trusted="$(curl -sS -H 'Accept: application/json' "$CP_URL/api/v1/trusted-mrtds" | jq -r --arg m "$mrtd" '[.trusted_mrtds[] | select(.mrtd == $m)] | length' 2>/dev/null || echo 0)"
        if [ "${trusted:-0}" -gt 0 ]; then
          echo "MRTD already trusted: ${mrtd:0:16}..."
          exit 0
        fi

        methods="$(curl -sS -H 'Accept: application/json' "$CP_URL/auth/methods" || true)"
        password_enabled="$(echo "${methods:-}" | jq -r '.password // false' 2>/dev/null || echo false)"
        generated_pw="$(echo "${methods:-}" | jq -r '.generated_password // empty' 2>/dev/null || true)"
        if [ "$password_enabled" != "true" ] || [ -z "${generated_pw:-}" ]; then
          echo "::warning::Cannot bootstrap trust: password login disabled or generated_password not available."
          exit 0
        fi

        # Login to obtain admin token.
        login_payload="$(jq -cn --arg p "$generated_pw" '{password: $p}')"
        admin_token="$(curl -sS -X POST "$CP_URL/admin/login" -H 'Content-Type: application/json' -d "$login_payload" | jq -r '.token // empty' 2>/dev/null || true)"
        if [ -z "${admin_token:-}" ]; then
          echo "::warning::Admin login failed; skipping trust bootstrap."
          exit 0
        fi
        echo "::add-mask::${admin_token}"

        # Add baseline.
        add_payload="$(jq -cn --arg m "$mrtd" --arg note "ci:gcp:${NODE_SIZE:-}" '{mrtd: $m, type: "agent", note: $note}')"
        http_code="000"
        resp=""
        for attempt in $(seq 1 10); do
          tmp="$(mktemp)"
          http_code="$(
            curl -sS -o "$tmp" -w "%{http_code}" \
              -X POST "$CP_URL/api/v1/admin/trusted-mrtds" \
              -H "Authorization: Bearer ${admin_token}" \
              -H 'Content-Type: application/json' \
              -d "$add_payload" || echo 000
          )"
          resp="$(cat "$tmp")"
          rm -f "$tmp"
          if [ "$http_code" = "530" ] || [ "$http_code" = "000" ] || [ "$http_code" -ge 500 ]; then
            echo "::warning::Trust baseline request failed (HTTP ${http_code}); retrying ($attempt/10)..."
            sleep 3
            continue
          fi
          break
        done
        if [ "$http_code" -ge 400 ]; then
          detail="$(echo "$resp" | jq -r '.detail // empty' 2>/dev/null || true)"
          echo "::warning::Failed to add trusted MRTD (HTTP $http_code): ${detail:-$resp}"
          exit 0
        fi

        echo "Added trusted MRTD baseline for GCP: ${mrtd:0:16}..."

    - name: Wait for eligible GCP capacity after dispatch
      if: steps.precheck.outputs.need_provision == 'true'
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        NODE_SIZE: ${{ inputs.node_size }}
        WAIT_SECONDS: ${{ inputs.wait_seconds }}
      run: |
        set -euo pipefail

        deadline=$(( $(date +%s) + ${WAIT_SECONDS:-900} ))
        while :; do
          agents="$(curl -sS -H 'Accept: application/json' "$CP_URL/api/v1/agents" || true)"
          if [ -z "${agents:-}" ]; then
            echo "::warning::Control plane temporarily unavailable while waiting for capacity; retrying..."
            sleep 10
            continue
          fi
          count="$(
            echo "${agents:-}" | jq --arg ns "${NODE_SIZE:-}" '
              [.agents[]
                | (.datacenter // "" | ascii_downcase) as $dc
                | (.status // "" | ascii_downcase) as $st
                | select(.verified == true
                  and (.health_status // "" | ascii_downcase) == "healthy"
                  and (if ($ns | length) > 0 then ((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase)) else true end)
                  and ($st == "undeployed" or ($st == "deployed" and ((.deployed_app // "") | test("^measuring-enclave") | not)))
                  and ($dc | startswith("gcp:") or $dc == "gcp"))
              ] | length
            ' 2>/dev/null || echo 0
          )"
          if [ "$count" -gt 0 ]; then
            echo "Eligible GCP capacity is now available: $count"
            exit 0
          fi
          now="$(date +%s)"
          if [ "$now" -ge "$deadline" ]; then
            echo "::error::Timed out waiting for eligible GCP capacity after dispatch."
            echo "Observed GCP agents (debug):"
            echo "$agents" | jq -r --arg ns "${NODE_SIZE:-}" '
              [.agents[]
                | (.datacenter // "" | ascii_downcase) as $dc
                | select(($dc | startswith("gcp:")) or ($dc == "gcp"))
                | (if ($ns|length)>0 then select((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase)) else . end)
                | {
                    agent_id,
                    vm_name,
                    node_size,
                    datacenter,
                    verified,
                    health_status,
                    status,
                    deployed_app,
                    mrtd_present: ((.mrtd // "") | length > 0)
                  }
              ]'
            exit 1
          fi
          sleep 10
        done

    - name: Final check - healthy verified GCP agents
      id: final
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        NODE_SIZE: ${{ inputs.node_size }}
        PROVISIONED: ${{ steps.dispatch.outputs.provisioned }}
      run: |
        set -euo pipefail
        agents="$(curl -sSf -H 'Accept: application/json' "$CP_URL/api/v1/agents")"
        count="$(
          echo "${agents:-}" | jq --arg ns "${NODE_SIZE:-}" '
            [.agents[]
              | (.datacenter // "" | ascii_downcase) as $dc
              | (.status // "" | ascii_downcase) as $st
              | select(.verified == true
                and (.health_status // "" | ascii_downcase) == "healthy"
                and (if ($ns | length) > 0 then ((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase)) else true end)
                and ($st == "undeployed" or ($st == "deployed" and ((.deployed_app // "") | test("^measuring-enclave") | not)))
                and ($dc | startswith("gcp:") or $dc == "gcp"))
            ] | length
          ' 2>/dev/null || echo 0
        )"

        echo "gcp_eligible_agents=$count" >> "$GITHUB_OUTPUT"
        provisioned="${PROVISIONED:-false}"
        if [ -z "$provisioned" ]; then
          provisioned="false"
        fi
        echo "gcp_provisioned=$provisioned" >> "$GITHUB_OUTPUT"

        if [ "$count" -le 0 ]; then
          echo "::error::No eligible verified GCP agents available."
          echo "::error::Control-plane dispatch either failed or no provisioner fulfilled the request."
          exit 1
        fi
        echo "Found $count eligible verified GCP agents."
