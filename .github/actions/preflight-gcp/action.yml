name: Preflight - GCP capacity
description: Ensure at least one healthy verified GCP agent exists by requesting billed capacity via the control plane

inputs:
  control_plane_url:
    description: EasyEnclave control plane URL
    required: false
    default: "https://app.easyenclave.com"
  node_size:
    description: Agent node_size to provision (e.g. tiny)
    required: false
    default: "tiny"
  wait_seconds:
    description: Seconds to wait for agent registration
    required: false
    default: "900"

  # Billing-backed capacity request credentials.
  billing_account_id:
    description: Billing deployer account_id used for capacity purchases
    required: false
    default: ""
  billing_api_key:
    description: Billing account API key (Authorization Bearer)
    required: false
    default: ""
  billing_months:
    description: Number of months to purchase for requested warm capacity
    required: false
    default: "1"

  # Preferred CP dispatch target. If empty, first entry from gcp_zone is used.
  gcp_datacenter:
    description: Datacenter label to request from control plane (e.g. gcp:us-central1-a)
    required: false
    default: ""

  # Optional launcher fulfillment (CI datacenter-manager).
  # If these are provided and no GCP capacity exists, the action will provision a CVM on GCP
  # by claiming the CP's launch order (scripts/capacity_launcher_worker.py).
  intel_api_key:
    description: Intel Trust Authority API key used by provisioned VMs to attest/register
    required: false
    default: ""

  # Deprecated legacy inputs retained for compatibility with existing workflow callers.
  gcp_project_id:
    description: GCP project ID (required to provision from CI)
    required: false
    default: ""
  gcp_wif_provider:
    description: Deprecated (ignored)
    required: false
    default: ""
  gcp_wif_service_account:
    description: Deprecated (ignored)
    required: false
    default: ""
  gcp_service_account_key:
    description: GCP service account JSON key (required to provision from CI)
    required: false
    default: ""
  gcp_zone:
    description: Comma-separated zones; first entry is used as default dispatch target
    required: false
    default: "us-central1-a,us-central1-b,us-central1-c,us-central1-f,us-east4-a,us-west1-b"
  gcp_region:
    description: Deprecated (ignored)
    required: false
    default: ""
  gcp_machine_type:
    description: Deprecated (ignored)
    required: false
    default: ""
  gcp_boot_disk_size:
    description: Deprecated (ignored)
    required: false
    default: ""

outputs:
  gcp_eligible_agents:
    description: Count of eligible verified healthy GCP agents after preflight
    value: ${{ steps.final.outputs.gcp_eligible_agents }}
  gcp_provisioned:
    description: Whether the action attempted provisioning (true/false)
    value: ${{ steps.final.outputs.gcp_provisioned }}

runs:
  using: composite
  steps:
    - name: Resolve billing capacity credentials
      id: billing
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        BILLING_ACCOUNT_ID: ${{ inputs.billing_account_id }}
        BILLING_API_KEY: ${{ inputs.billing_api_key }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
      run: |
        set -euo pipefail
        account_id="$(echo "${BILLING_ACCOUNT_ID:-}" | xargs)"
        api_key="$(echo "${BILLING_API_KEY:-}" | xargs)"

        create_account() {
          local account_name body http_code resp
          account_name="ci-gcp-preflight-${GITHUB_RUN_ID:-local}-${GITHUB_RUN_ATTEMPT:-1}-$(date +%s)"
          body="$(mktemp)"
          http_code="$(
            curl -sS -o "$body" -w "%{http_code}" \
              -X POST "$CP_URL/api/v1/accounts" \
              -H "Content-Type: application/json" \
              -d "$(jq -cn --arg name "$account_name" '{name: $name, account_type: "deployer"}')" \
              || echo 000
          )"
          resp="$(cat "$body")"
          rm -f "$body"
          if [ "$http_code" -ge 400 ]; then
            detail="$(echo "$resp" | jq -r '.detail // empty' 2>/dev/null || true)"
            echo "::error::Failed to create deployer billing account (HTTP $http_code): ${detail:-$resp}"
            exit 1
          fi
          account_id="$(echo "$resp" | jq -r '.account_id // empty')"
          api_key="$(echo "$resp" | jq -r '.api_key // empty')"
          if [ -z "$account_id" ] || [ -z "$api_key" ]; then
            echo "::error::Control plane did not return billing account credentials"
            exit 1
          fi
          echo "Created transient deployer billing account: $account_id"
        }

        if [ -n "$account_id" ] && [ -n "$api_key" ]; then
          probe_body="$(mktemp)"
          probe_code="$(
            curl -sS -o "$probe_body" -w "%{http_code}" \
              -H "Authorization: Bearer ${api_key}" \
              -H "Accept: application/json" \
              "$CP_URL/api/v1/accounts/${account_id}" \
              || echo 000
          )"
          if [ "$probe_code" -ge 400 ]; then
            probe_resp="$(cat "$probe_body")"
            probe_detail="$(echo "$probe_resp" | jq -r '.detail // empty' 2>/dev/null || true)"
            echo "::warning::Provided billing credentials are invalid for this control plane (HTTP $probe_code): ${probe_detail:-$probe_resp}"
            echo "::warning::Creating transient deployer billing account for this run."
            create_account
          else
            echo "Using provided billing account for GCP preflight capacity request."
          fi
          rm -f "$probe_body"
        else
          echo "::warning::billing_account_id or billing_api_key not provided; creating transient deployer billing account."
          create_account
        fi

        echo "::add-mask::${api_key}"
        echo "billing_account_id=${account_id}" >> "$GITHUB_OUTPUT"
        echo "billing_api_key=${api_key}" >> "$GITHUB_OUTPUT"

    - name: Precheck - healthy verified GCP agents
      id: precheck
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        NODE_SIZE: ${{ inputs.node_size }}
      run: |
        set -euo pipefail
        agents="$(curl -sSf -H 'Accept: application/json' "$CP_URL/api/v1/agents")"
        count="$(
          echo "${agents:-}" | jq --arg ns "${NODE_SIZE:-}" '
            [.agents[]
              | (.datacenter // "" | ascii_downcase) as $dc
              | (.status // "" | ascii_downcase) as $st
              | select(.verified == true
                and (.health_status // "" | ascii_downcase) == "healthy"
                and (if ($ns | length) > 0 then ((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase)) else true end)
                and ($st == "undeployed" or ($st == "deployed" and ((.deployed_app // "") | test("^measuring-enclave") | not)))
                and ($dc | startswith("gcp:") or $dc == "gcp"))
            ] | length
          ' 2>/dev/null || echo 0
        )"

        echo "gcp_eligible_agents=$count" >> "$GITHUB_OUTPUT"

        if [ "$count" -gt 0 ]; then
          echo "Found $count eligible GCP agents."
          echo "need_provision=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "need_provision=true" >> "$GITHUB_OUTPUT"
        echo "::warning::No healthy verified GCP agents available; requesting control-plane capacity dispatch."

    - name: Request control-plane GCP capacity dispatch
      if: steps.precheck.outputs.need_provision == 'true'
      id: dispatch
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        BILLING_ACCOUNT_ID: ${{ steps.billing.outputs.billing_account_id }}
        BILLING_API_KEY: ${{ steps.billing.outputs.billing_api_key }}
        BILLING_MONTHS: ${{ inputs.billing_months }}
        NODE_SIZE: ${{ inputs.node_size }}
        GCP_DATACENTER: ${{ inputs.gcp_datacenter }}
        GCP_ZONE: ${{ inputs.gcp_zone }}
      run: |
        set -euo pipefail
        if [ -z "${BILLING_ACCOUNT_ID:-}" ] || [ -z "${BILLING_API_KEY:-}" ]; then
          echo "::error::Missing billing credentials for capacity purchase."
          exit 1
        fi
        if ! echo "${BILLING_MONTHS:-1}" | grep -Eq '^[1-9][0-9]*$'; then
          echo "::error::Invalid billing_months='${BILLING_MONTHS:-}'. Expected integer >= 1."
          exit 1
        fi

        target_dc="$(echo "${GCP_DATACENTER:-}" | tr '[:upper:]' '[:lower:]' | xargs)"
        if [ -z "$target_dc" ]; then
          first_zone="$(echo "${GCP_ZONE:-}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d' | head -n1)"
          first_zone="$(echo "$first_zone" | tr '[:upper:]' '[:lower:]')"
          if [ -n "$first_zone" ]; then
            case "$first_zone" in
              gcp:*)
                target_dc="$first_zone"
                ;;
              *)
                target_dc="gcp:$first_zone"
                ;;
            esac
          else
            target_dc="gcp"
          fi
        fi

        payload="$(jq -cn \
          --arg dc "$target_dc" \
          --arg ns "${NODE_SIZE:-}" \
          --argjson months "${BILLING_MONTHS:-1}" \
          --arg reason "deploy-example-gcp-preflight-${GITHUB_RUN_ID:-local}-${GITHUB_RUN_ATTEMPT:-1}" \
          '{
            datacenter: $dc,
            node_size: $ns,
            min_warm_count: 1,
            months: $months,
            reason: $reason
          }'
        )"

        body="$(mktemp)"
        http_code="$(
          curl -sS -o "$body" -w "%{http_code}" \
            -X POST "$CP_URL/api/v1/accounts/${BILLING_ACCOUNT_ID}/capacity/request" \
            -H "Authorization: Bearer ${BILLING_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$payload" || echo 000
        )"
        resp="$(cat "$body")"
        rm -f "$body"

        if [ "$http_code" -ge 400 ]; then
          if [ "$http_code" = "404" ]; then
            echo "::error::Control plane is missing billing capacity endpoint /api/v1/accounts/{account_id}/capacity/request. Deploy a newer control plane first."
            echo "::error::Response: ${resp:-empty}"
            exit 1
          fi
          detail="$(echo "$resp" | jq -r '.detail // empty' 2>/dev/null || true)"
          echo "::error::Control-plane dispatch request failed (HTTP $http_code): ${detail:-$resp}"
          exit 1
        fi

        shortfall="$(echo "$resp" | jq -r '.capacity.targets[0].shortfall // 0' 2>/dev/null || echo 0)"
        dispatched="$(echo "$resp" | jq -r '.capacity.dispatches[0].dispatched // false' 2>/dev/null || echo false)"
        detail="$(echo "$resp" | jq -r '.capacity.dispatches[0].detail // empty' 2>/dev/null || true)"
        status_code="$(echo "$resp" | jq -r '.capacity.dispatches[0].status_code // empty' 2>/dev/null || true)"
        tx_id="$(echo "$resp" | jq -r '.transaction_id // empty' 2>/dev/null || true)"
        charged="$(echo "$resp" | jq -r '.charged_amount_usd // 0' 2>/dev/null || echo 0)"
        simulated="$(echo "$resp" | jq -r '.simulated_payment // false' 2>/dev/null || echo false)"

        echo "target_datacenter=$target_dc" >> "$GITHUB_OUTPUT"
        echo "provisioned=$dispatched" >> "$GITHUB_OUTPUT"
        if [ -n "$tx_id" ]; then
          echo "transaction_id=$tx_id" >> "$GITHUB_OUTPUT"
        fi

        if [ "${shortfall:-0}" -gt 0 ] && [ "$dispatched" != "true" ]; then
          echo "::error::Control plane reported shortfall=$shortfall but did not dispatch provisioning."
          if [ -n "$detail" ]; then
            echo "::error::$detail"
          fi
          if [ -n "$status_code" ]; then
            echo "::error::Dispatch status_code=$status_code"
          fi
          exit 1
        fi

        echo "Capacity request accepted: datacenter='$target_dc' node_size='${NODE_SIZE:-}' shortfall=$shortfall dispatched=$dispatched tx_id=${tx_id:-none} charged=${charged} simulated=${simulated}"

    - name: Auth to Google Cloud (for launcher fulfillment)
      if: steps.precheck.outputs.need_provision == 'true' && inputs.gcp_project_id != '' && inputs.gcp_service_account_key != '' && inputs.intel_api_key != ''
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ inputs.gcp_service_account_key }}

    - name: Set up gcloud (for launcher fulfillment)
      if: steps.precheck.outputs.need_provision == 'true' && inputs.gcp_project_id != '' && inputs.gcp_service_account_key != '' && inputs.intel_api_key != ''
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ inputs.gcp_project_id }}

    - name: Fulfill GCP capacity launch order (CI launcher)
      if: steps.precheck.outputs.need_provision == 'true' && inputs.gcp_project_id != '' && inputs.gcp_service_account_key != '' && inputs.intel_api_key != ''
      id: fulfill
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        INTEL_API_KEY: ${{ inputs.intel_api_key }}
        GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
        TARGET_DC: ${{ steps.dispatch.outputs.target_datacenter }}
        NODE_SIZE: ${{ inputs.node_size }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
      run: |
        set -euo pipefail

        if [ -z "${TARGET_DC:-}" ]; then
          echo "::error::Missing dispatch target datacenter output"
          exit 1
        fi
        if [ -z "${INTEL_API_KEY:-}" ]; then
          echo "::error::Missing intel_api_key input (required for provisioning a registering agent)."
          exit 1
        fi
        if [ -z "${GCP_PROJECT_ID:-}" ]; then
          echo "::error::Missing gcp_project_id input (required for provisioning)."
          exit 1
        fi

        # Create a transient launcher account to claim launch orders.
        account_name="ci-launcher-${GITHUB_RUN_ID:-local}-${GITHUB_RUN_ATTEMPT:-1}-$(date +%s)"
        body="$(mktemp)"
        http_code="$(
          curl -sS -o "$body" -w "%{http_code}" \
            -X POST "$CP_URL/api/v1/accounts" \
            -H "Content-Type: application/json" \
            -d "$(jq -cn --arg name "$account_name" '{name: $name, account_type: "launcher"}')" \
            || echo 000
        )"
        resp="$(cat "$body")"
        rm -f "$body"
        if [ "$http_code" -ge 400 ]; then
          detail="$(echo "$resp" | jq -r '.detail // empty' 2>/dev/null || true)"
          echo "::error::Failed to create launcher account (HTTP $http_code): ${detail:-$resp}"
          exit 1
        fi
        launcher_key="$(echo "$resp" | jq -r '.api_key // empty')"
        if [ -z "$launcher_key" ]; then
          echo "::error::Control plane did not return launcher API key"
          exit 1
        fi
        echo "::add-mask::${launcher_key}"

        # Claim and fulfill exactly one order for this pool. This is intentionally minimal:
        # the control plane remains source-of-truth for dispatch decisions and accounting.
        python3 scripts/capacity_launcher_worker.py \
          --cp-url "$CP_URL" \
          --launcher-api-key "$launcher_key" \
          --intel-api-key "$INTEL_API_KEY" \
          --providers gcp \
          --datacenter "$TARGET_DC" \
          --node-size "${NODE_SIZE:-}" \
          --gcp-project "$GCP_PROJECT_ID" \
          --one-shot

        echo "fulfilled=true" >> "$GITHUB_OUTPUT"

    - name: Wait for eligible GCP capacity after dispatch
      if: steps.precheck.outputs.need_provision == 'true'
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        NODE_SIZE: ${{ inputs.node_size }}
        WAIT_SECONDS: ${{ inputs.wait_seconds }}
      run: |
        set -euo pipefail

        deadline=$(( $(date +%s) + ${WAIT_SECONDS:-900} ))
        while :; do
          agents="$(curl -sSf -H 'Accept: application/json' "$CP_URL/api/v1/agents")"
          count="$(
            echo "${agents:-}" | jq --arg ns "${NODE_SIZE:-}" '
              [.agents[]
                | (.datacenter // "" | ascii_downcase) as $dc
                | (.status // "" | ascii_downcase) as $st
                | select(.verified == true
                  and (.health_status // "" | ascii_downcase) == "healthy"
                  and (if ($ns | length) > 0 then ((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase)) else true end)
                  and ($st == "undeployed" or ($st == "deployed" and ((.deployed_app // "") | test("^measuring-enclave") | not)))
                  and ($dc | startswith("gcp:") or $dc == "gcp"))
              ] | length
            ' 2>/dev/null || echo 0
          )"
          if [ "$count" -gt 0 ]; then
            echo "Eligible GCP capacity is now available: $count"
            exit 0
          fi
          now="$(date +%s)"
          if [ "$now" -ge "$deadline" ]; then
            echo "::error::Timed out waiting for eligible GCP capacity after dispatch."
            exit 1
          fi
          sleep 10
        done

    - name: Final check - healthy verified GCP agents
      id: final
      shell: bash
      env:
        CP_URL: ${{ inputs.control_plane_url }}
        NODE_SIZE: ${{ inputs.node_size }}
        PROVISIONED: ${{ steps.dispatch.outputs.provisioned }}
      run: |
        set -euo pipefail
        agents="$(curl -sSf -H 'Accept: application/json' "$CP_URL/api/v1/agents")"
        count="$(
          echo "${agents:-}" | jq --arg ns "${NODE_SIZE:-}" '
            [.agents[]
              | (.datacenter // "" | ascii_downcase) as $dc
              | (.status // "" | ascii_downcase) as $st
              | select(.verified == true
                and (.health_status // "" | ascii_downcase) == "healthy"
                and (if ($ns | length) > 0 then ((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase)) else true end)
                and ($st == "undeployed" or ($st == "deployed" and ((.deployed_app // "") | test("^measuring-enclave") | not)))
                and ($dc | startswith("gcp:") or $dc == "gcp"))
            ] | length
          ' 2>/dev/null || echo 0
        )"

        echo "gcp_eligible_agents=$count" >> "$GITHUB_OUTPUT"
        provisioned="${PROVISIONED:-false}"
        if [ -z "$provisioned" ]; then
          provisioned="false"
        fi
        echo "gcp_provisioned=$provisioned" >> "$GITHUB_OUTPUT"

        if [ "$count" -le 0 ]; then
          echo "::error::No eligible verified GCP agents available."
          echo "::error::Control-plane dispatch either failed or no provisioner fulfilled the request."
          exit 1
        fi
        echo "Found $count eligible verified GCP agents."
