# Builtin Deploy Examples (Baremetal)
#
# Canonical baremetal example workflow:
# - hello-tdx on tiny
# - private-llm on llm (OpenAI-compatible smoke test)

name: Builtin Deploy Examples (Baremetal)

on:
  workflow_call:
    inputs:
      cp_url:
        required: false
        type: string
        default: "https://app.easyenclave.com"
      cp_expected_git_sha:
        required: false
        type: string
        default: ""
      source_ref:
        required: false
        type: string
        default: ""
  workflow_dispatch:
    inputs:
      cp_url:
        description: "Control plane URL"
        required: false
        default: "https://app.easyenclave.com"
      cp_expected_git_sha:
        description: "Expected control-plane git SHA from /health (optional)"
        required: false
        default: ""
      source_ref:
        description: "Git ref to checkout"
        required: false
        default: ""

concurrency:
  group: easyenclave-deploy-examples-baremetal
  cancel-in-progress: true

env:
  CP_URL: ${{ inputs.cp_url || github.event.inputs.cp_url || 'https://app.easyenclave.com' }}
  CP_EXPECTED_GIT_SHA: ${{ inputs.cp_expected_git_sha || github.event.inputs.cp_expected_git_sha || '' }}

jobs:
  wait-control-plane:
    name: Wait for control plane
    runs-on: [self-hosted, tdx]
    steps:
      - name: Wait for control plane health
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for $CP_URL/health"
          deadline=$(( $(date +%s) + 1200 ))
          while :; do
            body="$(curl -fsS "$CP_URL/health" 2>/dev/null || true)"
            if [ -z "${body:-}" ]; then
              now="$(date +%s)"
              if [ "$now" -ge "$deadline" ]; then
                echo "::error::Timed out waiting for control plane health"
                exit 1
              fi
              sleep 5
              continue
            fi

            if [ -z "${CP_EXPECTED_GIT_SHA:-}" ]; then
              echo "Control plane healthy (git_sha check skipped)"
              break
            fi

            sha="$(echo "${body:-}" | jq -r '.git_sha // empty' 2>/dev/null || true)"
            if [ -n "${sha:-}" ] && [ "$sha" = "$CP_EXPECTED_GIT_SHA" ]; then
              echo "Control plane ready: git_sha=$sha"
              break
            fi

            now="$(date +%s)"
            if [ "$now" -ge "$deadline" ]; then
              echo "::error::Timed out waiting for control plane git_sha=$CP_EXPECTED_GIT_SHA"
              echo "Last /health:"
              echo "${body:-<empty>}"
              exit 1
            fi
            sleep 5
          done

  register-apps:
    name: Register builtin apps
    runs-on: [self-hosted, tdx]
    needs: [wait-control-plane]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_ref || github.event.inputs.source_ref || github.sha }}

      - name: Register hello-tdx
        uses: ./.github/actions/register-app
        with:
          name: hello-tdx
          description: "Hello TDX - Example app demonstrating TDX attestation"
          control_plane_url: ${{ env.CP_URL }}

      - name: Register private-llm
        uses: ./.github/actions/register-app
        with:
          name: private-llm
          description: "Private LLM - Ollama running in a TDX enclave"
          control_plane_url: ${{ env.CP_URL }}

  ensure-baremetal-capacity:
    name: Ensure baremetal capacity (tiny + llm)
    runs-on: [self-hosted, tdx]
    needs: [register-apps]
    permissions:
      contents: read
    env:
      ITA_API_KEY: ${{ secrets.INTEL_API_KEY }}
      CP_ADMIN_TOKEN: ${{ secrets.CP_ADMIN_TOKEN }}
      CP_ADMIN_PASSWORD: ${{ secrets.CP_ADMIN_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_ref || github.event.inputs.source_ref || github.sha }}

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          for v in ITA_API_KEY CP_ADMIN_PASSWORD; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Missing required secret/env: $v"
              exit 1
            fi
          done

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Build verity artifacts (required for tdx_cli vm new)
        shell: bash
        run: |
          set -euo pipefail
          cd infra/image
          nix develop --command make build

      - name: Cleanup stale CI LLM VMs (best effort)
        shell: bash
        run: |
          set -euo pipefail
          bash ./scripts/cleanup_ci_llm_vms.sh || true

      - name: Trust measured llm baseline
        shell: bash
        run: |
          set -euo pipefail

          admin_token="${CP_ADMIN_TOKEN:-}"
          if [ -z "${admin_token:-}" ]; then
            payload="$(jq -cn --arg p "${CP_ADMIN_PASSWORD}" '{password: $p}')"
            admin_token="$(curl -sS -X POST "$CP_URL/admin/login" -H 'Content-Type: application/json' -d "$payload" | jq -r '.token // empty' 2>/dev/null || true)"
          fi
          if [ -z "${admin_token:-}" ]; then
            echo "::error::Failed to resolve control-plane admin token"
            exit 1
          fi

          measurements="$(python3 infra/tdx_cli.py vm measure --size llm --json)"
          mrtd="$(echo "$measurements" | jq -r '.mrtd // empty')"
          if ! echo "$mrtd" | grep -Eq '^[0-9a-f]{96}$'; then
            echo "::error::Failed to measure valid llm baseline MRTD"
            echo "$measurements" | head -c 2000 || true
            exit 1
          fi

          already="$(curl -sS -H 'Accept: application/json' "$CP_URL/api/v1/trusted-mrtds" | jq -r --arg m "$mrtd" '[.trusted_mrtds[] | select((.mrtd // "") == $m)] | length' 2>/dev/null || echo 0)"
          if [ "${already:-0}" -gt 0 ]; then
            echo "LLM baseline already trusted: ${mrtd:0:16}..."
            exit 0
          fi

          payload="$(jq -cn --arg m "$mrtd" --arg note "builtin-examples llm baseline" '{mrtd:$m, type:"agent", note:$note}')"
          code="$(curl -sS -o /tmp/trust-mrtd.json -w '%{http_code}' -X POST "$CP_URL/api/v1/admin/trusted-mrtds" -H "Authorization: Bearer ${admin_token}" -H 'Content-Type: application/json' -d "$payload" || true)"
          if [ "$code" -ge 400 ]; then
            echo "::error::Failed to trust llm MRTD (HTTP $code): $(cat /tmp/trust-mrtd.json)"
            exit 1
          fi
          echo "Trusted measured llm baseline MRTD: ${mrtd:0:16}..."

      - name: Ensure deployable baremetal tiny + llm agents exist
        shell: bash
        run: |
          set -euo pipefail
          ita_key="${ITA_API_KEY:-${INTEL_API_KEY:-}}"
          if [ -z "${ita_key:-}" ]; then
            echo "::error::Missing ITA_API_KEY (Intel Trust Authority API key); cannot boot agents."
            exit 1
          fi

          count_deployable() {
            local size="$1"
            curl -sSf "$CP_URL/api/v1/agents" | jq -r --arg ns "$size" '
              [.agents[]
                | select(.verified == true)
                | select((.health_status // "" | ascii_downcase) == "healthy")
                | select(((.status // "" | ascii_downcase) == "undeployed" or (.status // "" | ascii_downcase) == "deployed"))
                | select((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase))
                | select((.datacenter // "" | ascii_downcase) == "baremetal:github-runner")
                | select(((.deployed_app // "") | startswith("measuring-enclave")) | not)
              ] | length'
          }

          ensure_capacity() {
            local size="$1"
            local required="$2"
            local max_boots="${3:-3}"
            local boots=0

            local count
            count="$(count_deployable "$size" || echo 0)"
            echo "Deployable baremetal $size candidates: $count (required: $required)"

            while [ "${count:-0}" -lt "$required" ]; do
              boots=$((boots + 1))
              if [ "$boots" -gt "$max_boots" ]; then
                echo "::error::Exceeded max $size boot attempts ($max_boots)"
                curl -sSf "$CP_URL/api/v1/agents" | jq -r --arg ns "$size" '
                  [.agents[] | select((.node_size // "" | ascii_downcase) == ($ns | ascii_downcase))
                    | {agent_id, status, health_status, verified, datacenter, deployed_app, vm_name, verification_error}]'
                exit 1
              fi

              echo "Booting a new baremetal $size agent VM..."
              python3 infra/tdx_cli.py vm new \
                --size "$size" \
                --cloud-provider baremetal \
                --availability-zone github-runner \
                --easyenclave-url "$CP_URL" \
                --intel-api-key "$ita_key" \
                --wait \
                >"/tmp/new_${size}_vm.json"
              cat "/tmp/new_${size}_vm.json" || true

              for i in {1..60}; do
                count="$(count_deployable "$size" || echo 0)"
                if [ "${count:-0}" -ge "$required" ]; then
                  break
                fi
                if [ $((i % 6)) -eq 0 ]; then
                  echo "Still waiting for deployable baremetal $size capacity... ($i/60)"
                fi
                sleep 5
              done

              count="$(count_deployable "$size" || echo 0)"
              echo "Deployable baremetal $size candidates now: $count (required: $required)"
            done
          }

          ensure_capacity tiny 1 2
          ensure_capacity llm 1 3

  deploy-hello-tdx:
    name: Deploy hello-tdx (baremetal tiny)
    runs-on: [self-hosted, tdx]
    needs: [ensure-baremetal-capacity]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_ref || github.event.inputs.source_ref || github.sha }}

      - name: Deploy hello-tdx
        uses: ./.github/actions/deploy-example
        with:
          app_name: hello-tdx
          compose_file: examples/hello-tdx/docker-compose.yml
          service_name: hello-tdx
          health_endpoint: /
          control_plane_url: ${{ env.CP_URL }}
          node_size: tiny
          allowed_clouds: baremetal
          allowed_datacenters: baremetal:github-runner

  deploy-private-llm:
    name: Deploy private-llm (baremetal llm)
    runs-on: [self-hosted, tdx]
    needs: [ensure-baremetal-capacity]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_ref || github.event.inputs.source_ref || github.sha }}

      - name: Deploy private-llm
        id: deploy
        uses: ./.github/actions/deploy-example
        with:
          app_name: private-llm
          compose_file: examples/private-llm/docker-compose.yml
          service_name: private-llm
          health_endpoint: /
          control_plane_url: ${{ env.CP_URL }}
          agent_admin_password: ${{ secrets.AGENT_ADMIN_PASSWORD }}
          github_owner: ${{ github.repository_owner }}
          node_size: llm
          allowed_clouds: baremetal
          allowed_datacenters: baremetal:github-runner

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install SDK and OpenAI client
        run: pip install ./sdk/ openai

      - name: Smoke test private-llm (OpenAI-compatible)
        env:
          SERVICE_URL: ${{ steps.deploy.outputs.service_url }}
          EASYENCLAVE_URL: ${{ env.CP_URL }}
        run: python3 examples/private-llm/test.py
