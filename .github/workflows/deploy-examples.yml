# Deploy Examples
#
# Deploys example apps after CI passes, using the shared control plane.

name: Deploy Examples

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  workflow_dispatch: {}

concurrency:
  # This workflow mutates the shared control plane (apps + deployments); do not overlap with other CP-mutating runs.
  group: easyenclave-shared-control-plane
  cancel-in-progress: false

env:
  CP_URL: https://app.easyenclave.com
  CP_EXPECTED_GIT_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}

jobs:
  test-unregistered-app-fails:
    name: Test - Unregistered app deploy fails
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Wait for control plane bootstrap (git_sha match)
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for $CP_URL/health git_sha=$CP_EXPECTED_GIT_SHA"
          deadline=$(( $(date +%s) + 900 ))
          while :; do
            body="$(curl -fsS "$CP_URL/health" 2>/dev/null || true)"
            sha="$(echo "${body:-}" | jq -r '.git_sha // empty' 2>/dev/null || true)"
            if [ -n "${sha:-}" ] && [ "$sha" = "$CP_EXPECTED_GIT_SHA" ]; then
              echo "Control plane ready: git_sha=$sha"
              break
            fi
            now="$(date +%s)"
            if [ "$now" -ge "$deadline" ]; then
              echo "::error::Timed out waiting for control plane git_sha=$CP_EXPECTED_GIT_SHA"
              echo "Last /health:"
              echo "${body:-<empty>}"
              exit 1
            fi
            sleep 5
          done

      - name: Deploy unregistered app (should fail)
        id: deploy
        uses: ./.github/actions/deploy
        continue-on-error: true
        with:
          app_name: unregistered-test-app
          compose_file: examples/hello-tdx/docker-compose.yml
          service_name: hello-tdx
          health_endpoint: /

      - name: Verify deploy failed
        run: |
          if [ "${{ steps.deploy.outcome }}" != "failure" ]; then
            echo "::error::Expected deploy to fail for unregistered app, but it succeeded"
            exit 1
          fi
          echo "Deploy correctly failed for unregistered app"

  register-hello-tdx:
    name: Register Hello TDX
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Wait for control plane bootstrap (git_sha match)
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for $CP_URL/health git_sha=$CP_EXPECTED_GIT_SHA"
          deadline=$(( $(date +%s) + 900 ))
          while :; do
            body="$(curl -fsS "$CP_URL/health" 2>/dev/null || true)"
            sha="$(echo "${body:-}" | jq -r '.git_sha // empty' 2>/dev/null || true)"
            if [ -n "${sha:-}" ] && [ "$sha" = "$CP_EXPECTED_GIT_SHA" ]; then
              echo "Control plane ready: git_sha=$sha"
              break
            fi
            now="$(date +%s)"
            if [ "$now" -ge "$deadline" ]; then
              echo "::error::Timed out waiting for control plane git_sha=$CP_EXPECTED_GIT_SHA"
              echo "Last /health:"
              echo "${body:-<empty>}"
              exit 1
            fi
            sleep 5
          done

      - name: Register app
        uses: ./.github/actions/register-app
        with:
          name: hello-tdx
          description: "Hello TDX - Example app demonstrating TDX attestation"

  deploy-hello-tdx-clouds:
    name: Deploy Hello TDX (default)
    runs-on: ubuntu-latest
    needs: register-hello-tdx
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Wait for control plane bootstrap (git_sha match)
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for $CP_URL/health git_sha=$CP_EXPECTED_GIT_SHA"
          deadline=$(( $(date +%s) + 900 ))
          while :; do
            body="$(curl -fsS "$CP_URL/health" 2>/dev/null || true)"
            sha="$(echo "${body:-}" | jq -r '.git_sha // empty' 2>/dev/null || true)"
            if [ -n "${sha:-}" ] && [ "$sha" = "$CP_EXPECTED_GIT_SHA" ]; then
              echo "Control plane ready: git_sha=$sha"
              break
            fi
            now="$(date +%s)"
            if [ "$now" -ge "$deadline" ]; then
              echo "::error::Timed out waiting for control plane git_sha=$CP_EXPECTED_GIT_SHA"
              echo "Last /health:"
              echo "${body:-<empty>}"
              exit 1
            fi
            sleep 5
          done

      - name: Deploy to EasyEnclave
        uses: ./.github/actions/deploy-example
        with:
          app_name: hello-tdx
          compose_file: examples/hello-tdx/docker-compose.yml
          service_name: hello-tdx
          health_endpoint: /
          agent_admin_password: ${{ secrets.AGENT_ADMIN_PASSWORD }}
          github_owner: ${{ github.repository_owner }}
          node_size: tiny
          allowed_clouds: baremetal

  inventory-local-tdx:
    name: Inventory/Cleanup - Local TDX measurement VMs
    runs-on: [self-hosted, tdx]
    needs: [deploy-hello-tdx-clouds]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Local VM inventory (before)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== virsh list --all ==="
          virsh list --all || true
          echo ""
          echo "=== tdx_cli vm list ==="
          python3 infra/tdx_cli.py vm list || true
          echo ""
          echo "=== /var/tmp/tdvirsh disk usage ==="
          sudo du -sh /var/tmp/tdvirsh 2>/dev/null || du -sh /var/tmp/tdvirsh 2>/dev/null || true

      - name: Destroy leaked measurement domains (trust_domain_verity)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v virsh >/dev/null 2>&1; then
            echo "::warning::virsh not found; skipping measurement domain cleanup"
            exit 0
          fi
          mapfile -t domains < <(virsh list --all --name | grep '^tdvirsh-trust_domain_verity-' || true)
          if [ "${#domains[@]}" -eq 0 ]; then
            echo "No leaked trust_domain_verity domains found."
            exit 0
          fi
          echo "Cleaning leaked measurement domains:"
          printf '  - %s\n' "${domains[@]}"
          for d in "${domains[@]}"; do
            virsh destroy "$d" >/dev/null 2>&1 || true
            virsh undefine "$d" --nvram >/dev/null 2>&1 || virsh undefine "$d" >/dev/null 2>&1 || true
          done

      - name: Local VM inventory (after)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== virsh list --all ==="
          virsh list --all || true
          echo ""
          echo "=== tdx_cli vm list ==="
          python3 infra/tdx_cli.py vm list || true
