# Bootstrap EasyEnclave Network
#
# This workflow bootstraps the entire EasyEnclave infrastructure:
# 1. Launches the control plane in a TDX VM (app.easyenclave.com)
# 2. Adds trusted MRTDs to the allowlist
# 3. Launches agent VMs that register with the control plane
#
# Prerequisites:
# - Self-hosted runner with TDX enabled (label: tdx)
# - TDX VM image with launcher pre-installed

name: Bootstrap

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'sdk/**'
      - 'examples/**'
      - 'infra/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - bootstrap-all
          - control-plane-only
          - add-agents
          - add-trusted-mrtd
          - deploy-demo
          - cleanup-vms
      agent_count:
        description: 'Number of agents to launch (for bootstrap-all or add-agents)'
        default: '1'
      mrtd:
        description: 'MRTD to add (for add-trusted-mrtd action)'
        required: false
      mrtd_description:
        description: 'Description for trusted MRTD'
        default: 'TDX runner image'

env:
  CONTROL_PLANE_PORT: 8080
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
  EASYENCLAVE_DOMAIN: easyenclave.com

jobs:
  bootstrap:
    runs-on: [self-hosted, tdx]

    outputs:
      control_plane_url: ${{ steps.control-plane.outputs.url }}
      control_plane_ip: ${{ steps.control-plane.outputs.ip }}
      agent_ids: ${{ steps.agents.outputs.agent_ids }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =================================================================
      # AUTO-UPDATE CONTROL PLANE (on push to app/**)
      # =================================================================
      - name: Update Control Plane
        id: update-cp
        if: github.event_name == 'push'
        run: |
          echo "Looking for running control plane VM..."

          # Find control plane VM
          VM=$(python3 infra/tdx_cli.py vm list 2>/dev/null | grep -E "trust_domain.*control" | head -1 || true)
          if [ -z "$VM" ]; then
            # Try alternative pattern
            VM=$(python3 infra/tdx_cli.py vm list 2>/dev/null | grep "trust_domain" | head -1 || true)
          fi

          if [ -z "$VM" ]; then
            echo "No running control plane VM found - skipping update"
            echo "Run 'bootstrap-all' or 'control-plane-only' to launch one"
            exit 0
          fi

          echo "Found control plane VM: $VM"

          # Get VM IP
          IP=$(virsh --connect qemu:///system domifaddr "$VM" 2>/dev/null | grep ipv4 | awk '{print $4}' | cut -d/ -f1)
          if [ -z "$IP" ]; then
            echo "::error::Could not get IP for VM $VM"
            exit 1
          fi

          echo "Control plane IP: $IP"
          echo "ip=$IP" >> "$GITHUB_OUTPUT"

          # Wait for SSH to be available
          echo "Waiting for SSH..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o BatchMode=yes "ubuntu@${IP}" "echo ok" 2>/dev/null; then
              echo "SSH is available"
              break
            fi
            echo "  Waiting... ($i/30)"
            sleep 2
          done

          # Update the control plane
          echo "Updating control plane..."
          ssh -o StrictHostKeyChecking=no "ubuntu@${IP}" << 'ENDSSH'
            set -e
            cd /home/ubuntu/easyenclave || cd /workload

            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "Rebuilding and restarting control plane..."
            docker compose down || true
            docker compose up --build -d

            echo "Control plane updated!"
          ENDSSH

          # Wait for health
          URL="http://${IP}:${CONTROL_PLANE_PORT}"
          echo "Waiting for control plane health at $URL..."
          for i in {1..60}; do
            if curl -sf "${URL}/health" > /dev/null 2>&1; then
              echo "Control plane is healthy!"
              curl -s "${URL}/health" | jq .
              exit 0
            fi
            echo "  Waiting... ($i/60)"
            sleep 3
          done

          echo "::error::Control plane did not become healthy after update"
          exit 1

      # =================================================================
      # CONTROL PLANE
      # =================================================================
      - name: Launch Control Plane
        id: control-plane
        if: inputs.action == 'bootstrap-all' || inputs.action == 'control-plane-only'
        run: |
          echo "Launching control plane in TDX VM..."

          # Launch control plane and wait for it to be ready
          RESULT=$(python3 infra/tdx_cli.py control-plane new --wait --port "$CONTROL_PLANE_PORT")

          # Parse result
          VM_NAME=$(echo "$RESULT" | jq -r '.name')
          IP=$(echo "$RESULT" | jq -r '.ip // empty')
          URL=$(echo "$RESULT" | jq -r '.control_plane_url // empty')

          if [ -z "$IP" ]; then
            echo "::error::Failed to get control plane IP"
            exit 1
          fi

          if [ -z "$URL" ]; then
            URL="http://${IP}:${CONTROL_PLANE_PORT}"
          fi

          {
            echo "vm_name=$VM_NAME"
            echo "ip=$IP"
            echo "url=$URL"
          } >> "$GITHUB_OUTPUT"

          echo ""
          echo "Control plane launched!"
          echo "  VM Name: $VM_NAME"
          echo "  IP: $IP"
          echo "  URL: $URL"

      - name: Wait for Control Plane Health
        if: inputs.action == 'bootstrap-all' || inputs.action == 'control-plane-only'
        run: |
          URL="${{ steps.control-plane.outputs.url }}"
          echo "Waiting for control plane at $URL..."

          for i in {1..60}; do
            if curl -sf "${URL}/health" > /dev/null 2>&1; then
              echo "Control plane is healthy!"
              curl -s "${URL}/health" | jq .
              exit 0
            fi
            echo "  Waiting... ($i/60)"
            sleep 5
          done

          echo "::error::Control plane did not become healthy"
          exit 1

      # =================================================================
      # TRUSTED MRTD
      # =================================================================
      - name: Get Control Plane URL
        id: get-url
        run: |
          # Use the launched control plane URL or discover existing one
          if [ -n "${{ steps.control-plane.outputs.url }}" ]; then
            echo "url=${{ steps.control-plane.outputs.url }}" >> "$GITHUB_OUTPUT"
          else
            # Try to find running control plane VM
            VM=$(python3 infra/tdx_cli.py vm list | grep "trust_domain" | head -1)
            if [ -n "$VM" ]; then
              IP=$(virsh --connect qemu:///system domifaddr "$VM" 2>/dev/null | grep ipv4 | awk '{print $4}' | cut -d/ -f1)
              if [ -n "$IP" ]; then
                echo "url=http://${IP}:${CONTROL_PLANE_PORT}" >> "$GITHUB_OUTPUT"
                echo "Found existing control plane at http://${IP}:${CONTROL_PLANE_PORT}"
              fi
            fi
          fi

          # Fallback to environment or default
          if [ -z "${{ steps.control-plane.outputs.url }}" ]; then
            echo "url=${EASYENCLAVE_URL:-https://app.easyenclave.com}" >> "$GITHUB_OUTPUT"
          fi

      - name: Add Trusted MRTD (manual)
        if: inputs.action == 'add-trusted-mrtd' && inputs.mrtd != ''
        run: |
          URL="${{ steps.get-url.outputs.url }}"
          MRTD="${{ inputs.mrtd }}"
          DESC="${{ inputs.mrtd_description }}"

          echo "Adding trusted MRTD: ${MRTD:0:32}..."

          RESPONSE=$(curl -sf -X POST "${URL}/api/v1/trusted-mrtds" \
            -H "Content-Type: application/json" \
            -d "{
              \"mrtd\": \"$MRTD\",
              \"description\": \"$DESC\"
            }" 2>&1) || {
            echo "::warning::Failed to add MRTD (may already exist)"
            echo "$RESPONSE"
          }

          echo "Trusted MRTD added"

      - name: Add VM Image MRTD
        if: inputs.action == 'bootstrap-all'
        run: |
          URL="${{ steps.get-url.outputs.url }}"

          # Get the MRTD from the control plane VM's attestation
          SHARE_DIR=$(find /var/tmp/tdvirsh -maxdepth 1 -type d -name 'share.*' -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2-)
          if [ -f "${SHARE_DIR}/attestation.json" ]; then
            MRTD=$(jq -r '.tdx.measurements.mrtd // empty' "${SHARE_DIR}/attestation.json")
            if [ -n "$MRTD" ]; then
              echo "Adding control plane VM MRTD to trusted list..."
              curl -sf -X POST "${URL}/api/v1/trusted-mrtds" \
                -H "Content-Type: application/json" \
                -d "{
                  \"mrtd\": \"$MRTD\",
                  \"description\": \"TDX runner image (auto-added)\"
                }" || echo "::warning::MRTD may already exist"
              echo "Added MRTD: ${MRTD:0:32}..."
            fi
          fi

      # =================================================================
      # REGISTER EXAMPLE APPS
      # =================================================================
      - name: Register Example Apps
        if: inputs.action == 'bootstrap-all'
        run: |
          URL="${{ steps.get-url.outputs.url }}"

          echo "Registering example apps in the app catalog..."

          # Register private-llm app
          echo "Registering private-llm app..."
          curl -sf -X POST "${URL}/api/v1/apps" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "private-llm",
              "description": "Private LLM with E2E encryption",
              "source_repo": "easyenclave/easyenclave"
            }' 2>/dev/null || echo "::warning::App 'private-llm' may already exist"

          echo "Example apps registered"

      # =================================================================
      # AGENTS
      # =================================================================
      - name: Launch Agents
        id: agents
        if: inputs.action == 'bootstrap-all' || inputs.action == 'add-agents'
        run: |
          URL="${{ steps.get-url.outputs.url }}"
          COUNT="${{ inputs.agent_count }}"
          AGENT_IDS=""

          echo "Launching $COUNT agent(s)..."

          for i in $(seq 1 "$COUNT"); do
            echo ""
            echo "=== Launching agent $i of $COUNT ==="

            # Launch agent VM with control plane URL
            RESULT=$(python3 infra/tdx_cli.py vm new --easyenclave-url "$URL" --wait)
            VM_NAME=$(echo "$RESULT" | jq -r '.name')
            IP=$(echo "$RESULT" | jq -r '.ip // empty')

            echo "Launched: $VM_NAME (IP: $IP)"

            # Wait for agent to register with control plane
            echo "Waiting for agent registration..."
            for j in {1..60}; do
              AGENTS=$(curl -sf "${URL}/api/v1/agents?vm_name=${VM_NAME}" 2>/dev/null || echo '{"agents":[]}')
              AGENT_ID=$(echo "$AGENTS" | jq -r '.agents[0].agent_id // empty')

              if [ -n "$AGENT_ID" ]; then
                echo "Agent registered: $AGENT_ID"
                AGENT_IDS="${AGENT_IDS}${AGENT_ID},"
                break
              fi
              echo "  Waiting for registration... ($j/60)"
              sleep 5
            done

            if [ -z "$AGENT_ID" ]; then
              echo "::warning::Agent $VM_NAME did not register within timeout"
            fi
          done

          # Remove trailing comma
          AGENT_IDS="${AGENT_IDS%,}"
          echo "agent_ids=$AGENT_IDS" >> "$GITHUB_OUTPUT"
          echo ""
          echo "Launched agents: $AGENT_IDS"

      # =================================================================
      # CLEANUP
      # =================================================================
      - name: Cleanup VMs
        if: inputs.action == 'cleanup-vms'
        run: |
          echo "Listing running VMs..."
          python3 infra/tdx_cli.py vm list

          echo ""
          echo "Deleting all TDX VMs..."
          python3 infra/tdx_cli.py vm delete all

          echo ""
          echo "Cleanup complete. Remaining VMs:"
          python3 infra/tdx_cli.py vm list || echo "(none)"

      # =================================================================
      # SUMMARY
      # =================================================================
      - name: Summary
        run: |
          echo ""
          echo "========================================="
          echo "EasyEnclave Bootstrap Complete"
          echo "========================================="
          echo ""
          echo "Control Plane:"
          echo "  URL: ${{ steps.get-url.outputs.url }}"
          echo "  Health: ${{ steps.get-url.outputs.url }}/health"
          echo "  API Docs: ${{ steps.get-url.outputs.url }}/docs"
          echo ""
          if [ -n "${{ steps.agents.outputs.agent_ids }}" ]; then
            echo "Agents: ${{ steps.agents.outputs.agent_ids }}"
            echo ""
          fi
          echo "To deploy an app via the app catalog flow:"
          echo ""
          echo "1. Register app (one-time):"
          echo "   curl -X POST ${{ steps.get-url.outputs.url }}/api/v1/apps \\"
          echo "     -H 'Content-Type: application/json' \\"
          echo "     -d '{\"name\": \"my-app\", \"source_repo\": \"org/repo\"}'"
          echo ""
          echo "2. Publish version:"
          echo "   curl -X POST ${{ steps.get-url.outputs.url }}/api/v1/apps/my-app/versions \\"
          echo "     -H 'Content-Type: application/json' \\"
          echo "     -d '{\"version\": \"1.0.0\", \"compose\": \"<base64>\", \"source_commit\": \"<sha>\"}'"
          echo ""
          echo "3. Deploy version:"
          echo "   curl -X POST ${{ steps.get-url.outputs.url }}/api/v1/apps/my-app/versions/1.0.0/deploy \\"
          echo "     -H 'Content-Type: application/json' \\"
          echo "     -d '{\"agent_id\": \"<agent_id>\"}'"
          echo ""
          echo "Or use the GitHub Action:"
          echo "   uses: easyenclave/easyenclave/.github/actions/deploy@main"
          echo "   with:"
          echo "     app_name: my-app"
          echo "     compose_file: docker-compose.yml"
          echo ""
          echo "========================================="

      - name: Save bootstrap info
        run: |
          mkdir -p bootstrap-info
          cat > bootstrap-info/bootstrap.json << EOF
          {
            "control_plane_url": "${{ steps.get-url.outputs.url }}",
            "control_plane_ip": "${{ steps.control-plane.outputs.ip }}",
            "control_plane_vm": "${{ steps.control-plane.outputs.vm_name }}",
            "agent_ids": "${{ steps.agents.outputs.agent_ids }}",
            "bootstrapped_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "github_run_id": "${{ github.run_id }}",
            "github_sha": "${{ github.sha }}"
          }
          EOF
          cat bootstrap-info/bootstrap.json

      - name: Upload bootstrap info
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-info
          path: bootstrap-info/
          retention-days: 90
