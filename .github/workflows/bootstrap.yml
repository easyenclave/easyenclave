# Bootstrap EasyEnclave Network
#
# This workflow bootstraps the entire EasyEnclave infrastructure:
# 1. Launches the control plane in a TDX VM (app.easyenclave.com)
# 2. Adds trusted MRTDs to the allowlist
# 3. Launches agent VMs that register with the control plane
#
# Prerequisites:
# - Self-hosted runner with TDX enabled (label: tdx)
# - TDX VM image with launcher pre-installed

name: Bootstrap

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'sdk/**'
      - 'examples/**'
      - 'infra/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - bootstrap-all
          - control-plane-only
          - add-agents
          - add-trusted-mrtd
          - deploy-demo
          - cleanup-vms
      agent_count:
        description: 'Number of agents to launch (for bootstrap-all or add-agents)'
        default: '1'
      mrtd:
        description: 'MRTD to add (for add-trusted-mrtd action)'
        required: false
      mrtd_description:
        description: 'Description for trusted MRTD'
        default: 'TDX runner image'

env:
  CONTROL_PLANE_PORT: 8080
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
  EASYENCLAVE_DOMAIN: easyenclave.com

jobs:
  bootstrap:
    runs-on: [self-hosted, tdx]

    outputs:
      control_plane_url: ${{ steps.control-plane.outputs.url }}
      control_plane_ip: ${{ steps.control-plane.outputs.ip }}
      agent_ids: ${{ steps.agents.outputs.agent_ids }}

    steps:
      - name: Fix workspace permissions
        run: |
          # Fix root-owned files from previous build_image.sh runs
          if [ -d "infra/output" ]; then
            sudo chown -R "$(id -u):$(id -g)" infra/output/ || true
          fi

      - name: Checkout
        uses: actions/checkout@v4

      # =================================================================
      # BUILD IMAGE (on infra changes)
      # =================================================================
      - name: Rebuild VM Image
        if: github.event_name == 'push'
        run: |
          echo "Rebuilding TDX VM image with latest infra changes..."

          # Use --customize-only if base exists (faster)
          if [ -f "infra/output/tdx-runner-base.qcow2" ]; then
            sudo bash infra/build_image.sh --customize-only
          else
            sudo bash infra/build_image.sh
          fi

          # Fix ownership so checkout can clean up later
          sudo chown -R "$(id -u):$(id -g)" infra/output/

          echo "Image rebuilt: infra/output/tdx-runner.qcow2"

      # =================================================================
      # AUTO-UPDATE CONTROL PLANE (on push to infra/**)
      # =================================================================
      - name: Update Control Plane
        id: update-cp
        if: github.event_name == 'push'
        run: |
          echo "Redeploying control plane with new image..."

          # Delete existing control plane VM
          VM=$(python3 infra/tdx_cli.py vm list 2>/dev/null | grep -E "trust_domain" | head -1 || true)
          if [ -n "$VM" ]; then
            echo "Deleting existing control plane: $VM"
            python3 infra/tdx_cli.py vm delete "$VM"
          fi

          # Launch fresh control plane with rebuilt image
          echo "Launching control plane..."
          RESULT=$(python3 infra/tdx_cli.py control-plane new --wait --port "$CONTROL_PLANE_PORT")

          IP=$(echo "$RESULT" | jq -r '.ip // empty')
          echo "ip=$IP" >> "$GITHUB_OUTPUT"

          URL="http://${IP}:${CONTROL_PLANE_PORT}"

          # Wait for tunnel
          echo "Waiting for Cloudflare tunnel..."
          for i in {1..30}; do
            if curl -sf "https://app.easyenclave.com/health" > /dev/null 2>&1; then
              echo "Control plane ready at https://app.easyenclave.com"
              exit 0
            fi
            sleep 10
          done

          echo "::warning::Tunnel not ready, but internal health may be OK"

      # =================================================================
      # CONTROL PLANE
      # =================================================================
      - name: Launch Control Plane
        id: control-plane
        if: inputs.action == 'bootstrap-all' || inputs.action == 'control-plane-only'
        run: |
          echo "Launching control plane in TDX VM..."

          # Launch control plane and wait for it to be ready
          RESULT=$(python3 infra/tdx_cli.py control-plane new --wait --port "$CONTROL_PLANE_PORT")

          # Parse result
          VM_NAME=$(echo "$RESULT" | jq -r '.name')
          IP=$(echo "$RESULT" | jq -r '.ip // empty')
          URL=$(echo "$RESULT" | jq -r '.control_plane_url // empty')

          if [ -z "$IP" ]; then
            echo "::error::Failed to get control plane IP"
            exit 1
          fi

          if [ -z "$URL" ]; then
            URL="http://${IP}:${CONTROL_PLANE_PORT}"
          fi

          {
            echo "vm_name=$VM_NAME"
            echo "ip=$IP"
            echo "url=$URL"
          } >> "$GITHUB_OUTPUT"

          echo ""
          echo "Control plane launched!"
          echo "  VM Name: $VM_NAME"
          echo "  IP: $IP"
          echo "  URL: $URL"

      - name: Wait for Control Plane Health
        if: inputs.action == 'bootstrap-all' || inputs.action == 'control-plane-only'
        run: |
          URL="${{ steps.control-plane.outputs.url }}"
          echo "Waiting for control plane at $URL..."

          for i in {1..60}; do
            if curl -sf "${URL}/health" > /dev/null 2>&1; then
              echo "Control plane is healthy!"
              curl -s "${URL}/health" | jq .
              exit 0
            fi
            echo "  Waiting... ($i/60)"
            sleep 5
          done

          echo "::error::Control plane did not become healthy"
          exit 1

      # =================================================================
      # TRUSTED MRTD
      # =================================================================
      - name: Get Control Plane URL
        id: get-url
        run: |
          # Use the launched control plane URL or discover existing one
          if [ -n "${{ steps.control-plane.outputs.url }}" ]; then
            echo "url=${{ steps.control-plane.outputs.url }}" >> "$GITHUB_OUTPUT"
          else
            # Try to find running control plane VM
            VM=$(python3 infra/tdx_cli.py vm list | grep "trust_domain" | head -1)
            if [ -n "$VM" ]; then
              IP=$(virsh --connect qemu:///system domifaddr "$VM" 2>/dev/null | grep ipv4 | awk '{print $4}' | cut -d/ -f1)
              if [ -n "$IP" ]; then
                echo "url=http://${IP}:${CONTROL_PLANE_PORT}" >> "$GITHUB_OUTPUT"
                echo "Found existing control plane at http://${IP}:${CONTROL_PLANE_PORT}"
              fi
            fi
          fi

          # Fallback to environment or default
          if [ -z "${{ steps.control-plane.outputs.url }}" ]; then
            echo "url=${EASYENCLAVE_URL:-https://app.easyenclave.com}" >> "$GITHUB_OUTPUT"
          fi

      - name: Add Trusted MRTD (manual)
        if: inputs.action == 'add-trusted-mrtd' && inputs.mrtd != ''
        run: |
          URL="${{ steps.get-url.outputs.url }}"
          MRTD="${{ inputs.mrtd }}"
          DESC="${{ inputs.mrtd_description }}"

          echo "Adding trusted MRTD: ${MRTD:0:32}..."

          RESPONSE=$(curl -sf -X POST "${URL}/api/v1/trusted-mrtds" \
            -H "Content-Type: application/json" \
            -d "{
              \"mrtd\": \"$MRTD\",
              \"description\": \"$DESC\"
            }" 2>&1) || {
            echo "::warning::Failed to add MRTD (may already exist)"
            echo "$RESPONSE"
          }

          echo "Trusted MRTD added"

      # =================================================================
      # REGISTER EXAMPLE APPS
      # =================================================================
      - name: Register Example Apps
        if: inputs.action == 'bootstrap-all'
        run: |
          URL="${{ steps.get-url.outputs.url }}"

          echo "Registering example apps in the app catalog..."

          # Register private-llm app
          echo "Registering private-llm app..."
          curl -sf -X POST "${URL}/api/v1/apps" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "private-llm",
              "description": "Private LLM with E2E encryption",
              "source_repo": "easyenclave/easyenclave"
            }' 2>/dev/null || echo "::warning::App 'private-llm' may already exist"

          echo "Example apps registered"

      # =================================================================
      # AGENTS
      # =================================================================
      - name: Launch Agents
        id: agents
        if: inputs.action == 'bootstrap-all' || inputs.action == 'add-agents'
        run: |
          URL="${{ steps.get-url.outputs.url }}"
          COUNT="${{ inputs.agent_count }}"
          AGENT_IDS=""

          echo "Launching $COUNT agent(s)..."

          for i in $(seq 1 "$COUNT"); do
            echo ""
            echo "=== Launching agent $i of $COUNT ==="

            # Launch agent VM with control plane URL
            RESULT=$(python3 infra/tdx_cli.py vm new --easyenclave-url "$URL" --wait)
            VM_NAME=$(echo "$RESULT" | jq -r '.name')
            IP=$(echo "$RESULT" | jq -r '.ip // empty')

            echo "Launched: $VM_NAME (IP: $IP)"

            # Wait for agent to register with control plane
            echo "Waiting for agent registration..."
            for j in {1..60}; do
              AGENTS=$(curl -sf "${URL}/api/v1/agents?vm_name=${VM_NAME}" 2>/dev/null || echo '{"agents":[]}')
              AGENT_ID=$(echo "$AGENTS" | jq -r '.agents[0].agent_id // empty')

              if [ -n "$AGENT_ID" ]; then
                echo "Agent registered: $AGENT_ID"
                AGENT_IDS="${AGENT_IDS}${AGENT_ID},"
                break
              fi
              echo "  Waiting for registration... ($j/60)"
              sleep 5
            done

            if [ -z "$AGENT_ID" ]; then
              echo "::warning::Agent $VM_NAME did not register within timeout"
            fi
          done

          # Remove trailing comma
          AGENT_IDS="${AGENT_IDS%,}"
          echo "agent_ids=$AGENT_IDS" >> "$GITHUB_OUTPUT"
          echo ""
          echo "Launched agents: $AGENT_IDS"

      - name: Add Trusted MRTD for Agents
        if: inputs.action == 'bootstrap-all' || inputs.action == 'add-agents'
        run: |
          URL="${{ steps.get-url.outputs.url }}"

          # Get MRTDs from all registered agents
          echo "Getting MRTDs from registered agents..."
          AGENT_DATA=$(curl -sf "${URL}/api/v1/agents" 2>/dev/null || echo '{"agents":[]}')

          # Extract unique MRTDs
          MRTDS=$(echo "$AGENT_DATA" | jq -r '.agents[].mrtd // empty' | sort -u)

          if [ -z "$MRTDS" ]; then
            echo "::warning::No agents found with MRTDs"
            exit 0
          fi

          for MRTD in $MRTDS; do
            if [ -z "$MRTD" ] || [ "$MRTD" == "null" ]; then
              continue
            fi

            # Check if MRTD already exists
            EXISTING=$(curl -sf "${URL}/api/v1/trusted-mrtds/${MRTD}" 2>/dev/null || echo "")
            if [ -n "$EXISTING" ]; then
              echo "MRTD ${MRTD:0:32}... already in trusted list"
              continue
            fi

            # Add MRTD with GitHub attestation
            echo "Adding MRTD ${MRTD:0:32}... with GitHub attestation"
            curl -sf -X POST "${URL}/api/v1/trusted-mrtds" \
              -H "Content-Type: application/json" \
              -d "{
                \"mrtd\": \"$MRTD\",
                \"type\": \"agent\",
                \"description\": \"TDX VM image from GitHub Actions\",
                \"source_repo\": \"${{ github.repository }}\",
                \"source_commit\": \"${{ github.sha }}\",
                \"build_workflow\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
              }" || echo "::warning::Failed to add MRTD (may already exist)"
          done

          echo "Trusted MRTDs added"

      # =================================================================
      # CLEANUP
      # =================================================================
      - name: Cleanup VMs
        if: inputs.action == 'cleanup-vms'
        run: |
          echo "Listing running VMs..."
          python3 infra/tdx_cli.py vm list

          echo ""
          echo "Deleting all TDX VMs..."
          python3 infra/tdx_cli.py vm delete all

          echo ""
          echo "Cleanup complete. Remaining VMs:"
          python3 infra/tdx_cli.py vm list || echo "(none)"

      # =================================================================
      # SUMMARY
      # =================================================================
      - name: Summary
        run: |
          echo ""
          echo "========================================="
          echo "EasyEnclave Bootstrap Complete"
          echo "========================================="
          echo ""
          echo "Control Plane:"
          echo "  URL: ${{ steps.get-url.outputs.url }}"
          echo "  Health: ${{ steps.get-url.outputs.url }}/health"
          echo "  API Docs: ${{ steps.get-url.outputs.url }}/docs"
          echo ""
          if [ -n "${{ steps.agents.outputs.agent_ids }}" ]; then
            echo "Agents: ${{ steps.agents.outputs.agent_ids }}"
            echo ""
          fi
          echo "To deploy an app via the app catalog flow:"
          echo ""
          echo "1. Register app (one-time):"
          echo "   curl -X POST ${{ steps.get-url.outputs.url }}/api/v1/apps \\"
          echo "     -H 'Content-Type: application/json' \\"
          echo "     -d '{\"name\": \"my-app\", \"source_repo\": \"org/repo\"}'"
          echo ""
          echo "2. Publish version:"
          echo "   curl -X POST ${{ steps.get-url.outputs.url }}/api/v1/apps/my-app/versions \\"
          echo "     -H 'Content-Type: application/json' \\"
          echo "     -d '{\"version\": \"1.0.0\", \"compose\": \"<base64>\", \"source_commit\": \"<sha>\"}'"
          echo ""
          echo "3. Deploy version:"
          echo "   curl -X POST ${{ steps.get-url.outputs.url }}/api/v1/apps/my-app/versions/1.0.0/deploy \\"
          echo "     -H 'Content-Type: application/json' \\"
          echo "     -d '{\"agent_id\": \"<agent_id>\"}'"
          echo ""
          echo "Or use the GitHub Action:"
          echo "   uses: easyenclave/easyenclave/.github/actions/deploy@main"
          echo "   with:"
          echo "     app_name: my-app"
          echo "     compose_file: docker-compose.yml"
          echo ""
          echo "========================================="

      - name: Save bootstrap info
        run: |
          mkdir -p bootstrap-info
          cat > bootstrap-info/bootstrap.json << EOF
          {
            "control_plane_url": "${{ steps.get-url.outputs.url }}",
            "control_plane_ip": "${{ steps.control-plane.outputs.ip }}",
            "control_plane_vm": "${{ steps.control-plane.outputs.vm_name }}",
            "agent_ids": "${{ steps.agents.outputs.agent_ids }}",
            "bootstrapped_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "github_run_id": "${{ github.run_id }}",
            "github_sha": "${{ github.sha }}"
          }
          EOF
          cat bootstrap-info/bootstrap.json

      - name: Upload bootstrap info
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-info
          path: bootstrap-info/
          retention-days: 90
