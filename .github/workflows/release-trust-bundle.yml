# Release Trust Bundle
#
# Computes deterministic trusted measurements for a release tag and publishes
# a versioned trust bundle asset on that GitHub Release.

name: Release Trust Bundle

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (e.g. v0.4.0)"
        required: true
        default: ""

concurrency:
  group: easyenclave-release-trust-bundle-${{ github.event.release.tag_name || github.event.inputs.release_tag || github.ref }}
  cancel-in-progress: false

jobs:
  resolve:
    name: Resolve release tag
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      release_tag: ${{ steps.resolve.outputs.release_tag }}
    steps:
      - name: Resolve tag
        id: resolve
        shell: bash
        env:
          EVENT_TAG: ${{ github.event.release.tag_name || '' }}
          INPUT_TAG: ${{ github.event.inputs.release_tag || '' }}
        run: |
          set -euo pipefail
          tag="${INPUT_TAG:-${EVENT_TAG:-}}"
          if [ -z "$tag" ]; then
            echo "::error::release_tag is required (event release tag or workflow_dispatch input)."
            exit 1
          fi
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"

  build:
    name: Build deterministic trust bundle
    runs-on: ubuntu-latest
    needs: [resolve]
    permissions:
      contents: read
    env:
      GCP_PROJECT_ID: ${{ secrets.PRODUCTION_GCP_PROJECT_ID }}
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.PRODUCTION_GCP_SERVICE_ACCOUNT_KEY }}
    outputs:
      bundle_name: ${{ steps.bundle.outputs.bundle_name }}
    steps:
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ needs.resolve.outputs.release_tag }}

      - name: Validate required GCP config
        shell: bash
        run: |
          set -euo pipefail
          for v in GCP_PROJECT_ID GCP_SERVICE_ACCOUNT_KEY; do
            if [ -z "${!v:-}" ]; then
              echo "::error::Missing required value: $v"
              exit 1
            fi
          done

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Resolve release image selector for trust measurement
        shell: bash
        env:
          RELEASE_TAG: ${{ needs.resolve.outputs.release_tag }}
        run: |
          set -euo pipefail
          source_sha="$(git rev-parse HEAD)"
          safe_tag="$(echo "$RELEASE_TAG" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//')"
          [ -n "$safe_tag" ] || safe_tag="release"
          tag_hash="$(printf '%s' "$safe_tag" | sha256sum | awk '{print $1}' | cut -c1-8)"
          if [ "${#safe_tag}" -gt 32 ]; then
            safe_tag="${safe_tag:0:23}-${tag_hash}"
          fi
          sha12="$(echo "$source_sha" | cut -c1-12)"
          image_name="easyenclave-agent-${safe_tag}-${sha12}"
          image_family="easyenclave-agent-${safe_tag}"

          {
            echo "EE_GCP_IMAGE_PROJECT=${GCP_PROJECT_ID}"
            echo "EE_GCP_IMAGE_NAME=${image_name}"
            echo "EE_GCP_IMAGE_FAMILY=${image_family}"
          } >> "$GITHUB_ENV"

          for attempt in $(seq 1 60); do
            if gcloud compute images describe "${image_name}" --project "${GCP_PROJECT_ID}" >/dev/null 2>&1; then
              echo "Using release image for trust measurement: ${GCP_PROJECT_ID}/${image_name}"
              exit 0
            fi
            if [ "$attempt" -lt 60 ]; then
              echo "Release image not available yet: ${image_name} (${attempt}/60)"
              sleep 15
            fi
          done

          echo "::error::Timed out waiting for release image '${image_name}' in project '${GCP_PROJECT_ID}'."
          echo "::error::Release GCP Image workflow must complete first."
          exit 1

      - name: Run strict reproducibility check
        run: ./scripts/ci-reproducibility-check.sh

      - name: Build release trust bundle payload
        id: bundle
        shell: bash
        env:
          RELEASE_TAG: ${{ needs.resolve.outputs.release_tag }}
        run: |
          set -euo pipefail
          src="infra/output/reproducibility/trusted_values.json"
          if [ ! -f "$src" ]; then
            echo "::error::Missing trusted values output: $src"
            exit 1
          fi

          git_sha="$(git rev-parse HEAD)"
          out="/tmp/trusted_values.${RELEASE_TAG}.json"
          jq -c \
            --arg release_tag "$RELEASE_TAG" \
            --arg git_sha "$git_sha" \
            --arg generated_at "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            '. + {release_tag: $release_tag, git_sha: $git_sha, generated_at: $generated_at}' \
            "$src" > "$out"

          jq -e '.digest | type == "string"' "$out" >/dev/null
          jq -e '.mrtds | type == "string" and length > 0' "$out" >/dev/null
          jq -e '.mrtds_by_size | type == "object"' "$out" >/dev/null
          jq -e '.rtmrs | type == "object"' "$out" >/dev/null
          jq -e '.rtmrs_by_size | type == "object"' "$out" >/dev/null

          echo "bundle_name=trusted_values.${RELEASE_TAG}.json" >> "$GITHUB_OUTPUT"
          cp "$out" ./trusted_values.release.json

      - name: Upload trust bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-trust-bundle
          if-no-files-found: error
          path: trusted_values.release.json

  publish:
    name: Publish trust bundle release assets
    runs-on: ubuntu-latest
    needs: [resolve, build]
    permissions:
      contents: write
    steps:
      - name: Download trust bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: release-trust-bundle
          path: /tmp

      - name: Upload release assets (versioned + canonical)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          RELEASE_TAG: ${{ needs.resolve.outputs.release_tag }}
          VERSIONED_NAME: ${{ needs.build.outputs.bundle_name }}
        run: |
          set -euo pipefail
          bundle="/tmp/trusted_values.release.json"
          if [ ! -f "$bundle" ]; then
            echo "::error::Trust bundle artifact missing"
            exit 1
          fi

          versioned="/tmp/${VERSIONED_NAME}"
          canonical="/tmp/trusted_values.json"
          cp "$bundle" "$versioned"
          cp "$bundle" "$canonical"

          gh release upload "$RELEASE_TAG" "$versioned" --clobber
          gh release upload "$RELEASE_TAG" "$canonical" --clobber
          echo "Published release assets: $VERSIONED_NAME, trusted_values.json"
