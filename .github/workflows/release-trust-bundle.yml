# Release Trust Bundle
#
# Computes deterministic trusted measurements for a release tag and publishes
# a versioned trust bundle asset on that GitHub Release.

name: Release Trust Bundle

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (e.g. v0.4.0)"
        required: true
        default: ""

concurrency:
  group: easyenclave-release-trust-bundle-${{ github.event.release.tag_name || github.event.inputs.release_tag || github.ref }}
  cancel-in-progress: false

jobs:
  resolve:
    name: Resolve release tag
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      release_tag: ${{ steps.resolve.outputs.release_tag }}
      source_sha: ${{ steps.sha.outputs.source_sha }}
    steps:
      - name: Resolve tag
        id: resolve
        shell: bash
        env:
          EVENT_TAG: ${{ github.event.release.tag_name || '' }}
          INPUT_TAG: ${{ github.event.inputs.release_tag || '' }}
        run: |
          set -euo pipefail
          tag="${INPUT_TAG:-${EVENT_TAG:-}}"
          if [ -z "$tag" ]; then
            echo "::error::release_tag is required (event release tag or workflow_dispatch input)."
            exit 1
          fi
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ steps.resolve.outputs.release_tag }}

      - name: Resolve release commit sha
        id: sha
        shell: bash
        run: |
          set -euo pipefail
          echo "source_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

  build:
    name: Promote trust bundle from CI artifact
    runs-on: ubuntu-latest
    needs: [resolve]
    permissions:
      actions: read
      contents: read
    outputs:
      bundle_name: ${{ steps.bundle.outputs.bundle_name }}
    steps:
      - name: Fetch trust bundle from commit rollout artifact
        id: bundle
        shell: bash
        env:
          RELEASE_TAG: ${{ needs.resolve.outputs.release_tag }}
          SOURCE_SHA: ${{ needs.resolve.outputs.source_sha }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          runs="$(gh api -H "Accept: application/vnd.github+json" "/repos/${GITHUB_REPOSITORY}/actions/runs?event=push&head_sha=${SOURCE_SHA}&per_page=100")"
          run_id="$(echo "$runs" | jq -r '[.workflow_runs[] | select(.name == "CI" and .conclusion == "success")] | sort_by(.created_at) | last | .id // empty')"
          if [ -z "$run_id" ]; then
            echo "::error::Could not find successful CI run for ${SOURCE_SHA}."
            exit 1
          fi

          artifacts="$(gh api -H "Accept: application/vnd.github+json" "/repos/${GITHUB_REPOSITORY}/actions/runs/${run_id}/artifacts?per_page=100")"
          artifact_name="rollout-artifacts-${SOURCE_SHA}"
          artifact_id="$(echo "$artifacts" | jq -r --arg n "$artifact_name" '[.artifacts[] | select(.name == $n and .expired == false)] | sort_by(.created_at) | last | .id // empty')"
          if [ -z "$artifact_id" ]; then
            echo "::error::CI run ${run_id} missing artifact '${artifact_name}'."
            exit 1
          fi

          zip_path="/tmp/rollout-artifacts.zip"
          out_dir="/tmp/rollout-artifacts"
          rm -rf "$out_dir"
          gh api -H "Accept: application/vnd.github+json" "/repos/${GITHUB_REPOSITORY}/actions/artifacts/${artifact_id}/zip" > "$zip_path"
          unzip -q "$zip_path" -d "$out_dir"
          src="$(find "$out_dir" -type f -name 'trusted_values.commit.json' | head -n1)"
          if [ -z "${src:-}" ] || [ ! -f "$src" ]; then
            echo "::error::trusted_values.commit.json missing in rollout artifact."
            exit 1
          fi

          artifact_sha="$(jq -r '.git_sha // empty' "$src")"
          if [ "$artifact_sha" != "$SOURCE_SHA" ]; then
            echo "::error::Trust bundle git_sha mismatch: expected ${SOURCE_SHA}, got ${artifact_sha:-<empty>}"
            exit 1
          fi

          out="/tmp/trusted_values.${RELEASE_TAG}.json"
          jq -c --arg release_tag "$RELEASE_TAG" '. + {release_tag: $release_tag}' "$src" > "$out"

          jq -e '.digest | type == "string"' "$out" >/dev/null
          jq -e '.mrtds | type == "string" and length > 0' "$out" >/dev/null
          jq -e '.mrtds_by_size | type == "object"' "$out" >/dev/null
          jq -e '.rtmrs | type == "object"' "$out" >/dev/null
          jq -e '.rtmrs_by_size | type == "object"' "$out" >/dev/null

          echo "bundle_name=trusted_values.${RELEASE_TAG}.json" >> "$GITHUB_OUTPUT"
          cp "$out" ./trusted_values.release.json

      - name: Upload trust bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-trust-bundle
          if-no-files-found: error
          path: trusted_values.release.json

  publish:
    name: Publish trust bundle release assets
    runs-on: ubuntu-latest
    needs: [resolve, build]
    permissions:
      contents: write
    steps:
      - name: Download trust bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: release-trust-bundle
          path: /tmp

      - name: Upload release assets (versioned + canonical)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          RELEASE_TAG: ${{ needs.resolve.outputs.release_tag }}
          VERSIONED_NAME: ${{ needs.build.outputs.bundle_name }}
        run: |
          set -euo pipefail
          bundle="/tmp/trusted_values.release.json"
          if [ ! -f "$bundle" ]; then
            echo "::error::Trust bundle artifact missing"
            exit 1
          fi

          versioned="/tmp/${VERSIONED_NAME}"
          canonical="/tmp/trusted_values.json"
          cp "$bundle" "$versioned"
          cp "$bundle" "$canonical"

          gh release upload "$RELEASE_TAG" "$versioned" --clobber
          gh release upload "$RELEASE_TAG" "$canonical" --clobber
          echo "Published release assets: $VERSIONED_NAME, trusted_values.json"
