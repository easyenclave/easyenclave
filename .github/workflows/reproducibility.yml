name: Reproducibility

on:
  workflow_dispatch: {}

concurrency:
  group: reproducibility-${{ github.ref }}
  cancel-in-progress: false

jobs:
  determinism:
    # Run after CI completes successfully (and allow manual runs)
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: [self-hosted, tdx]

    steps:
      - name: Fix workspace permissions
        run: |
          if [ -d "infra/output" ]; then
            sudo chown -R "$(id -u):$(id -g)" infra/output/ || true
          fi
          if [ -d "infra/image/output" ]; then
            sudo chown -R "$(id -u):$(id -g)" infra/image/output/ || true
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Reproducibility and trusted measurements (strict)
        run: ./scripts/ci-reproducibility-check.sh

      - name: Publish reproducibility summary
        if: always()
        run: |
          SUMMARY_FILE="infra/output/reproducibility/summary.md"
          if [ -f "$SUMMARY_FILE" ]; then
            cat "$SUMMARY_FILE" >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "## Determinism Report"
              echo ""
              echo "- Status: **missing report**"
              echo "- Reason: reproducibility script did not emit \`$SUMMARY_FILE\`"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload reproducibility artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reproducibility-report
          if-no-files-found: warn
          path: |
            infra/output/reproducibility/report.json
            infra/output/reproducibility/summary.md
            infra/output/reproducibility/build1.sha256.txt
            infra/output/reproducibility/build2.sha256.txt
            infra/output/reproducibility/build1.sizes.tsv
            infra/output/reproducibility/build2.sizes.tsv
            infra/output/reproducibility/build1.measure.json
            infra/output/reproducibility/build2.measure.json
            infra/output/reproducibility/build1.timing.json
            infra/output/reproducibility/build2.timing.json
            infra/output/reproducibility/artifact.diff
            infra/output/reproducibility/measurement.diff
            infra/output/reproducibility/trusted_values.json
