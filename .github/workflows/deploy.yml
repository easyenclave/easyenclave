# Deploy EasyEnclave Demo
#
# This workflow deploys the private-llm demo on every push to main.
# It updates the control plane and deploys the demo to an available agent.

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  CONTROL_PLANE_URL: https://app.easyenclave.com
  # TDX VM image MRTD - update when VM image changes
  TRUSTED_MRTD: "91eb2b44d141d4ece09f0c75c2c53d247a3c68edd7fafe8a3520c942a604a407de03ae6dc5f87f27428b2538873118b7"

jobs:
  deploy-demo:
    runs-on: [self-hosted, tdx]
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Private LLM Demo
        run: |
          ensure_trusted_mrtd() {
            # Add the known MRTD to trusted list (idempotent)
            echo "Ensuring MRTD is trusted: ${TRUSTED_MRTD:0:32}..."
            curl -sf -X POST "$CONTROL_PLANE_URL/api/v1/trusted-mrtds" \
              -H "Content-Type: application/json" \
              -d "{\"mrtd\": \"$TRUSTED_MRTD\", \"description\": \"TDX runner image\"}" 2>/dev/null || true
          }

          # Check if agent exists and is available (not deploying)
          # Returns 0 if available, 1 if not found, 2 if busy
          check_agent_available() {
            local agent_id="$1"
            local status
            local http_code
            http_code=$(curl -s -o /tmp/agent_status.json -w "%{http_code}" \
              "$CONTROL_PLANE_URL/api/v1/agents/$agent_id" 2>/dev/null) || true

            if [ "$http_code" != "200" ]; then
              return 1  # Agent doesn't exist
            fi

            status=$(cat /tmp/agent_status.json)
            local deploy_status
            deploy_status=$(echo "$status" | jq -r '.status // "unknown"')
            if [ "$deploy_status" = "deploying" ]; then
              return 2  # Agent is busy
            fi
            return 0  # Agent is available
          }

          # Find an available verified agent
          find_available_agent() {
            local agents_json
            agents_json=$(curl -sf "$CONTROL_PLANE_URL/api/v1/agents" 2>/dev/null || echo '{"agents":[]}')
            local agent_ids
            agent_ids=$(echo "$agents_json" | jq -r '[.agents[] | select(.verified == true)] | .[].agent_id')

            for agent_id in $agent_ids; do
              echo "  Checking agent $agent_id..." >&2
              check_agent_available "$agent_id"
              local result=$?
              if [ $result -eq 0 ]; then
                echo "$agent_id"
                return 0
              elif [ $result -eq 2 ]; then
                echo "    Agent is busy deploying, skipping" >&2
              else
                echo "    Agent not found in API, skipping" >&2
              fi
            done
            return 1
          }

          launch_agent() {
            echo "Launching new agent..." >&2
            VM_OUTPUT=$(python3 infra/tdx_cli.py vm new --easyenclave-url "$CONTROL_PLANE_URL" --wait)
            echo "$VM_OUTPUT" >&2

            # Wait for agent to register and be verified
            echo "Waiting for agent registration and verification..." >&2
            for i in {1..90}; do
              AGENT_ID=$(find_available_agent)
              if [ -n "$AGENT_ID" ]; then
                echo "Agent available: $AGENT_ID" >&2
                echo "$AGENT_ID"
                return 0
              fi
              echo "  Waiting for verified agent... ($i/90)" >&2
              sleep 5
            done
            return 1
          }

          # Ensure the known MRTD is trusted
          ensure_trusted_mrtd

          # Wait for an available agent (with retries)
          echo "Looking for available verified agent..."
          AGENT_ID=""
          for attempt in {1..6}; do
            AGENT_ID=$(find_available_agent) || true
            if [ -n "$AGENT_ID" ]; then
              # Double-check the agent is still available
              check_agent_available "$AGENT_ID"
              if [ $? -eq 0 ]; then
                echo "Found available agent: $AGENT_ID"
                break
              fi
              echo "Agent $AGENT_ID became unavailable, retrying..."
              AGENT_ID=""
            fi

            if [ $attempt -lt 6 ]; then
              echo "No available agents, waiting 30s before retry ($attempt/6)..."
              sleep 30
            fi
          done

          if [ -z "$AGENT_ID" ]; then
            echo "No available agents after retries, launching new agent..."
            AGENT_ID=$(launch_agent) || {
              echo "::error::Agent did not register within timeout"
              exit 1
            }
          fi

          echo "Using agent: $AGENT_ID"

          # Deploy demo
          COMPOSE_B64=$(base64 -w0 examples/private-llm/docker-compose.yml)
          HTTP_CODE=$(curl -s -o /tmp/deploy_response.json -w "%{http_code}" \
            -X POST "$CONTROL_PLANE_URL/api/v1/deployments" \
            -H "Content-Type: application/json" \
            -d "{
              \"agent_id\": \"$AGENT_ID\",
              \"compose\": \"$COMPOSE_B64\",
              \"config\": {
                \"service_name\": \"private-llm\",
                \"health_endpoint\": \"/health\"
              }
            }")

          RESPONSE=$(cat /tmp/deploy_response.json)
          echo "HTTP $HTTP_CODE: $RESPONSE"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Deployment failed with HTTP $HTTP_CODE: $RESPONSE"
            if echo "$RESPONSE" | grep -q "MRTD not in trusted list"; then
              echo "::error::The agent's MRTD is not trusted. Run the Bootstrap workflow with 'add-trusted-mrtd' action first."
            fi
            exit 1
          fi

          DEPLOYMENT_ID=$(echo "$RESPONSE" | jq -r '.deployment_id')
          echo "Deployment triggered: $DEPLOYMENT_ID"

          # Wait for deployment to be ready
          echo "Waiting for deployment to complete..."
          for i in {1..60}; do
            AGENT_STATUS=$(curl -sf "$CONTROL_PLANE_URL/api/v1/agents/$AGENT_ID" 2>/dev/null || echo '{}')
            DEPLOY_STATUS=$(echo "$AGENT_STATUS" | jq -r '.current_deployment_id // empty')
            HEALTH=$(echo "$AGENT_STATUS" | jq -r '.health_status // "unknown"')
            SERVICE_URL=$(echo "$AGENT_STATUS" | jq -r '.service_url // empty')

            if [ "$HEALTH" = "healthy" ] && [ -n "$SERVICE_URL" ]; then
              echo "Deployment healthy at $SERVICE_URL"
              break
            fi
            echo "  Status: $HEALTH ($i/60)"
            sleep 5
          done

          # Test the deployed service
          if [ -n "$SERVICE_URL" ]; then
            echo "Testing service at $SERVICE_URL..."
            if curl -sf "${SERVICE_URL}/health" > /dev/null 2>&1; then
              echo "Health check passed!"
            else
              echo "::warning::Health check failed, but deployment was accepted"
            fi
          fi

          echo "Demo deployment complete"
