# Deploy EasyEnclave to TDX VM
#
# This workflow deploys the EasyEnclave discovery service as a persistent TDX VM.
#
# Prerequisites:
# - Self-hosted runner with TDX enabled (label: tdx)
# - TDX VM image built with infra/build_image.sh

name: Deploy to TDX

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: 'Name for the VM'
        default: 'easyenclave'
        required: true
      service_url:
        description: 'Public service URL'
        default: 'https://app.easyenclave.com'
        required: true

jobs:
  deploy:
    runs-on: [self-hosted, tdx]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy with TDX attestation and registration
        id: tdx
        uses: ./.github/actions/deploy-tdx
        with:
          service_name: ${{ github.event.inputs.vm_name }}
          service_url: ${{ github.event.inputs.service_url }}
          docker_compose_path: './docker-compose.yml'
          intel_api_key: ${{ secrets.INTEL_API_KEY }}

      - name: Display deployment information
        run: |
          echo "========================================="
          echo "EasyEnclave Deployed to TDX VM"
          echo "========================================="
          echo "VM Name:    ${{ steps.tdx.outputs.vm_name }}"
          echo "Service ID: ${{ steps.tdx.outputs.service_id }}"
          echo "MRTD:       ${{ steps.tdx.outputs.mrtd }}"
          echo ""
          echo "Delete with:"
          echo "  virsh destroy ${{ steps.tdx.outputs.vm_name }}"
          echo ""
          echo "Service available at:"
          echo "  ${{ github.event.inputs.service_url }}"
          echo "  ${{ github.event.inputs.service_url }}/docs (API documentation)"

      - name: Save deployment info
        run: |
          mkdir -p deployment-info
          cat > deployment-info/deployment.json << EOF
          {
            "vm_name": "${{ steps.tdx.outputs.vm_name }}",
            "service_id": "${{ steps.tdx.outputs.service_id }}",
            "mrtd": "${{ steps.tdx.outputs.mrtd }}",
            "service_url": "${{ github.event.inputs.service_url }}",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "github_run_id": "${{ github.run_id }}",
            "github_sha": "${{ github.sha }}"
          }
          EOF

      - name: Upload deployment info
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment-info/
          retention-days: 30
