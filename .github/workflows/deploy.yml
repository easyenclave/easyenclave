# Deploy EasyEnclave Demo
#
# This workflow deploys the private-llm demo on every push to main.
# It updates the control plane and deploys the demo to an available agent.

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  CONTROL_PLANE_URL: https://app.easyenclave.com

jobs:
  deploy-control-plane:
    runs-on: [self-hosted, tdx]
    steps:
      - uses: actions/checkout@v4

      - name: Update Control Plane
        run: |
          # Trigger control plane update (pull latest code)
          curl -sf -X POST "$CONTROL_PLANE_URL/api/v1/admin/update" || true

  deploy-demo:
    runs-on: [self-hosted, tdx]
    needs: deploy-control-plane
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Private LLM Demo
        run: |
          trust_mrtd_from_share() {
            local SHARE_DIR="$1"
            echo "Waiting for attestation in $SHARE_DIR..." >&2
            for i in {1..30}; do
              if [ -f "${SHARE_DIR}/attestation.json" ]; then
                MRTD=$(jq -r '.tdx.measurements.mrtd // empty' "${SHARE_DIR}/attestation.json")
                if [ -n "$MRTD" ]; then
                  echo "Adding MRTD to trusted list: ${MRTD:0:32}..." >&2
                  curl -sf -X POST "$CONTROL_PLANE_URL/api/v1/trusted-mrtds" \
                    -H "Content-Type: application/json" \
                    -d "{\"mrtd\": \"$MRTD\", \"description\": \"CI auto-trusted\"}" || true
                  return 0
                fi
              fi
              sleep 2
            done
            echo "::warning::Could not find attestation.json" >&2
            return 1
          }

          launch_agent() {
            echo "Launching new agent..." >&2
            VM_OUTPUT=$(python3 infra/tdx_cli.py vm new --easyenclave-url "$CONTROL_PLANE_URL" --wait)
            echo "$VM_OUTPUT" >&2

            # Extract share_dir from VM output
            SHARE_DIR=$(echo "$VM_OUTPUT" | jq -r '.share_dir // empty' | tail -1)
            echo "Share dir: $SHARE_DIR" >&2

            # Trust the agent's MRTD (wait for attestation)
            trust_mrtd_from_share "$SHARE_DIR"

            # Wait for agent to register and be verified
            echo "Waiting for agent registration..." >&2
            for i in {1..60}; do
              # Get the most recently registered agent
              AGENT_DATA=$(curl -sf "$CONTROL_PLANE_URL/api/v1/agents" 2>/dev/null)
              AGENT_ID=$(echo "$AGENT_DATA" | jq -r '.agents[-1].agent_id // empty')
              AGENT_VERIFIED=$(echo "$AGENT_DATA" | jq -r '.agents[-1].verified // false')

              if [ -n "$AGENT_ID" ] && [ "$AGENT_VERIFIED" = "true" ]; then
                echo "Agent registered and verified: $AGENT_ID" >&2
                echo "$AGENT_ID"
                return 0
              elif [ -n "$AGENT_ID" ]; then
                echo "  Agent $AGENT_ID registered but not yet verified ($i/60)" >&2
              else
                echo "  Waiting for registration... ($i/60)" >&2
              fi
              sleep 5
            done
            return 1
          }

          # Always launch a fresh agent for CI/CD deployments
          AGENT_ID=$(launch_agent) || {
            echo "::error::Agent did not register within timeout"
            exit 1
          }

          echo "Using agent: $AGENT_ID"

          # Deploy demo
          COMPOSE_B64=$(base64 -w0 examples/private-llm/docker-compose.yml)
          HTTP_CODE=$(curl -s -o /tmp/deploy_response.json -w "%{http_code}" \
            -X POST "$CONTROL_PLANE_URL/api/v1/deployments" \
            -H "Content-Type: application/json" \
            -d "{
              \"agent_id\": \"$AGENT_ID\",
              \"compose\": \"$COMPOSE_B64\",
              \"config\": {
                \"service_name\": \"private-llm\",
                \"health_endpoint\": \"/health\"
              }
            }")

          RESPONSE=$(cat /tmp/deploy_response.json)
          echo "HTTP $HTTP_CODE: $RESPONSE"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Deployment failed with HTTP $HTTP_CODE: $RESPONSE"
            exit 1
          fi

          echo "Demo deployment triggered successfully"
