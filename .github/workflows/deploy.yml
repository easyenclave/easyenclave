# Deploy EasyEnclave to TDX VM
#
# This workflow deploys the EasyEnclave discovery service as a persistent TDX VM.
# Uses the two-step flow: launch agent, then deploy via control plane API.
#
# Prerequisites:
# - Self-hosted runner with TDX enabled (label: tdx)
# - TDX VM image built with infra/build_image.sh

name: Deploy to TDX

on:
  workflow_dispatch:
    inputs:
      agent_id:
        description: 'Agent ID (leave empty to launch new agent)'
        required: false
      service_url:
        description: 'Public service URL'
        default: 'https://app.easyenclave.com'
        required: true

jobs:
  deploy:
    runs-on: [self-hosted, tdx]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 1: Launch new agent if not provided
      - name: Launch TDX Agent
        if: ${{ github.event.inputs.agent_id == '' }}
        id: launch
        uses: ./.github/actions/launch-agent
        with:
          easyenclave_api_url: ${{ github.event.inputs.service_url }}

      # Step 2: Deploy workload to agent via control plane API
      - name: Deploy to TDX Agent
        id: deploy
        uses: ./.github/actions/deploy-tdx
        with:
          agent_id: ${{ github.event.inputs.agent_id || steps.launch.outputs.agent_id }}
          easyenclave_api_url: ${{ github.event.inputs.service_url }}
          docker_compose_path: './docker-compose.yml'
          service_name: 'easyenclave'
          service_url: ${{ github.event.inputs.service_url }}
          intel_api_key: ${{ secrets.INTEL_API_KEY }}
          health_endpoint: '/health'
          compose_up_args: '--build -d'
          tags: '["easyenclave", "discovery", "tdx"]'

      - name: Display deployment information
        run: |
          echo "========================================="
          echo "EasyEnclave Deployed to TDX"
          echo "========================================="
          echo ""
          echo "Agent ID:      ${{ github.event.inputs.agent_id || steps.launch.outputs.agent_id }}"
          echo "VM Name:       ${{ steps.launch.outputs.vm_name || 'existing agent' }}"
          echo "Deployment ID: ${{ steps.deploy.outputs.deployment_id }}"
          echo "Service ID:    ${{ steps.deploy.outputs.service_id }}"
          echo "MRTD:          ${{ steps.deploy.outputs.mrtd }}"
          echo ""
          echo "Service available at:"
          echo "  ${{ github.event.inputs.service_url }}"
          echo "  ${{ github.event.inputs.service_url }}/docs (API documentation)"

      - name: Save deployment info
        run: |
          mkdir -p deployment-info
          cat > deployment-info/deployment.json << EOF
          {
            "agent_id": "${{ github.event.inputs.agent_id || steps.launch.outputs.agent_id }}",
            "vm_name": "${{ steps.launch.outputs.vm_name || 'existing' }}",
            "deployment_id": "${{ steps.deploy.outputs.deployment_id }}",
            "service_id": "${{ steps.deploy.outputs.service_id }}",
            "mrtd": "${{ steps.deploy.outputs.mrtd }}",
            "service_url": "${{ github.event.inputs.service_url }}",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "github_run_id": "${{ github.run_id }}",
            "github_sha": "${{ github.sha }}"
          }
          EOF

      - name: Upload deployment info
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment-info/
          retention-days: 30
