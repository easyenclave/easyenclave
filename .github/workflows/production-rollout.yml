# Production Rollout
#
# Strict release pipeline.
#
# Production profile:
# - strict attestation policy
# - billing enabled (no simulation)
# - optional builtin deploy example verification

name: Production Rollout

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      cp_url:
        description: "Production control plane URL"
        required: false
        default: ""
      source_ref:
        description: "Git ref to checkout for deploy examples"
        required: false
        default: ""
      control_plane_image:
        description: "Control plane image override"
        required: false
        default: ""
      expected_git_sha:
        description: "Expected git SHA in /health (optional)"
        required: false
        default: ""
      run_builtin_examples:
        description: "Run builtin deploy examples after rollout"
        required: false
        type: boolean
        default: true

concurrency:
  group: easyenclave-production-rollout
  cancel-in-progress: false

jobs:
  resolve:
    name: Resolve production rollout config
    runs-on: ubuntu-latest
    outputs:
      cp_url: ${{ steps.resolve.outputs.cp_url }}
      cp_expected_git_sha: ${{ steps.resolve.outputs.cp_expected_git_sha }}
      source_ref: ${{ steps.resolve.outputs.source_ref }}
      production_domain: ${{ steps.resolve.outputs.production_domain }}
    steps:
      - name: Resolve URLs and refs
        id: resolve
        shell: bash
        env:
          INPUT_CP_URL: ${{ github.event.inputs.cp_url || '' }}
          INPUT_EXPECTED_SHA: ${{ github.event.inputs.expected_git_sha || '' }}
          INPUT_SOURCE_REF: ${{ github.event.inputs.source_ref || '' }}
          WORKFLOW_RUN_SHA: ${{ github.event.workflow_run.head_sha || '' }}
          DEFAULT_DOMAIN: ${{ vars.PRODUCTION_EASYENCLAVE_DOMAIN || 'easyenclave.com' }}
          DEFAULT_CP_URL: ${{ vars.PRODUCTION_CP_URL || '' }}
          STAGING_DEFAULT_DOMAIN: ${{ vars.STAGING_EASYENCLAVE_DOMAIN || 'staging.easyenclave.com' }}
          STAGING_DEFAULT_CP_URL: ${{ vars.STAGING_CP_URL || '' }}
        run: |
          set -euo pipefail
          source_ref="${INPUT_SOURCE_REF:-}"
          if [ -z "$source_ref" ]; then
            source_ref="${WORKFLOW_RUN_SHA:-${GITHUB_SHA}}"
          fi
          expected_sha="${INPUT_EXPECTED_SHA:-}"
          if [ -z "$expected_sha" ] && [ -n "${WORKFLOW_RUN_SHA:-}" ]; then
            expected_sha="${WORKFLOW_RUN_SHA}"
          fi
          domain="${DEFAULT_DOMAIN:-easyenclave.com}"
          cp_url="${INPUT_CP_URL:-}"
          if [ -z "$cp_url" ]; then
            cp_url="${DEFAULT_CP_URL:-}"
          fi
          if [ -z "$cp_url" ]; then
            cp_url="https://app.${domain}"
          fi

          staging_domain="${STAGING_DEFAULT_DOMAIN:-staging.easyenclave.com}"
          staging_cp_url="${STAGING_DEFAULT_CP_URL:-}"
          if [ -z "$staging_cp_url" ]; then
            staging_cp_url="https://app.${staging_domain}"
          fi
          if [ "$cp_url" = "$staging_cp_url" ]; then
            echo "::error::Production and staging CP URLs resolve to the same value: $cp_url"
            echo "::error::Set distinct vars: PRODUCTION_CP_URL/PRODUCTION_EASYENCLAVE_DOMAIN and STAGING_CP_URL/STAGING_EASYENCLAVE_DOMAIN."
            exit 1
          fi

          {
            echo "source_ref=${source_ref}"
            echo "cp_expected_git_sha=${expected_sha}"
            echo "production_domain=${domain}"
            echo "cp_url=${cp_url}"
          } >> "$GITHUB_OUTPUT"

  bootstrap:
    name: Bootstrap production control plane
    needs: [resolve]
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    uses: ./.github/workflows/bootstrap-control-plane.yml
    secrets: inherit
    with:
      control_plane_image: ${{ github.event.inputs.control_plane_image || format('ghcr.io/{0}/control-plane:{1}', github.repository, needs.resolve.outputs.source_ref) }}
      cp_bootstrap_sizes: tiny,llm
      num_tiny_agents: '2'
      num_standard_agents: '0'
      num_llm_agents: '1'
      easyenclave_domain: ${{ needs.resolve.outputs.production_domain }}
      easyenclave_env: production
      tcb_enforcement_mode: strict
      allowed_tcb_statuses: UpToDate
      nonce_enforcement_mode: required
      nonce_ttl_seconds: '300'
      rtmr_enforcement_mode: strict
      signature_verification_mode: strict
      cp_to_agent_attestation_mode: required
      auth_require_github_oauth_in_production: ${{ 'true' }}
      password_login_enabled: ${{ 'true' }}
      auth_allow_password_login_in_production: ${{ 'false' }}
      billing_enabled: ${{ 'true' }}
      billing_capacity_request_dev_simulation: ${{ 'false' }}
      billing_platform_account_id: ${{ vars.BILLING_PLATFORM_ACCOUNT_ID || '' }}
      billing_contributor_pool_bps: ${{ vars.BILLING_CONTRIBUTOR_POOL_BPS || '5000' }}

  deploy-baremetal:
    name: Builtin deploy examples (baremetal)
    if: github.event_name == 'workflow_run' || github.event.inputs.run_builtin_examples == 'true'
    needs: [resolve, bootstrap]
    uses: ./.github/workflows/deploy-examples.yml
    secrets: inherit
    with:
      cp_url: ${{ needs.resolve.outputs.cp_url }}
      cp_expected_git_sha: ${{ needs.resolve.outputs.cp_expected_git_sha }}
      source_ref: ${{ needs.resolve.outputs.source_ref }}

  deploy-gcp:
    name: Builtin deploy examples (gcp)
    if: github.event_name == 'workflow_run' || github.event.inputs.run_builtin_examples == 'true'
    needs: [resolve, bootstrap]
    uses: ./.github/workflows/deploy-examples-gcp.yml
    secrets: inherit
    with:
      cp_url: ${{ needs.resolve.outputs.cp_url }}
      cp_expected_git_sha: ${{ needs.resolve.outputs.cp_expected_git_sha }}
      source_ref: ${{ needs.resolve.outputs.source_ref }}
