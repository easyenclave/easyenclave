# Deploy Example - Private LLM
#
# Purpose: Demonstrate the LLM flow independently from deploy-examples:
# 1) add/update llm measurement baseline + measurer app
# 2) deploy and smoke-test the private-llm example.

name: Deploy Example - Private LLM

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      cp_url:
        description: "Control plane URL"
        required: false
        default: "https://app.easyenclave.com"
      keep_new_vms:
        description: "Keep any newly-created VMs (capacity) instead of deleting them at the end"
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-example-private-llm-${{ github.ref }}
  cancel-in-progress: false

jobs:
  bootstrap:
    runs-on: [self-hosted, tdx]
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read

    env:
      CP_URL: ${{ github.event.inputs.cp_url || 'https://app.easyenclave.com' }}
      INTEL_API_KEY: ${{ secrets.INTEL_API_KEY }}
      CP_ADMIN_PASSWORD: ${{ secrets.CP_ADMIN_PASSWORD }}
      AGENT_ADMIN_PASSWORD: ${{ secrets.AGENT_ADMIN_PASSWORD }}
      # Use :latest so the shared CP can be bootstrapped without needing the exact SHA image.
      MEASURER_IMAGE: ghcr.io/${{ github.repository }}/measuring-enclave:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Validate required secrets
        run: |
          set -euo pipefail
          if [ -z "${INTEL_API_KEY:-}" ]; then
            echo "::error::Missing INTEL_API_KEY secret"
            exit 1
          fi
          if [ -z "${CP_ADMIN_PASSWORD:-}" ]; then
            echo "::warning::CP_ADMIN_PASSWORD secret is empty; bootstrap will fall back to /auth/methods generated_password"
          fi

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Cleanup stale CI LLM VMs (preflight, best effort)
        run: |
          set -euo pipefail
          bash ./scripts/cleanup_ci_llm_vms.sh || true

      - name: Build and measure trusted values (llm)
        id: measure
        env:
          MEASURE_SIZES: llm
        run: ./scripts/ci-build-measure.sh

      - name: Bootstrap trusted agent baseline (llm)
        env:
          CP_URL: ${{ env.CP_URL }}
          ADMIN_TOKEN: ${{ secrets.CP_ADMIN_TOKEN }}
          ADMIN_PASSWORD: ${{ env.CP_ADMIN_PASSWORD }}
          NODE_SIZE: llm
          TRUSTED_AGENT_MRTDS_BY_SIZE: ${{ steps.measure.outputs.mrtds_by_size }}
          NOTE: ci:bootstrap:llm
        run: |
          set -euo pipefail
          chmod +x ./scripts/bootstrap_trusted_agent_mrtd.sh
          ./scripts/bootstrap_trusted_agent_mrtd.sh

      - name: Ensure baremetal LLM capacity for measurer + private-llm
        id: ensure_agents
        shell: bash
        run: |
          set -euo pipefail
          created=()
          max_boots=3
          boots=0

          count_non_measurer() {
            curl -sSf "${CP_URL}/api/v1/agents" | jq -r '
              [.agents[]
                | select(.verified == true)
                | select((.health_status // "" | ascii_downcase) == "healthy")
                | select(((.status // "" | ascii_downcase) == "undeployed" or (.status // "" | ascii_downcase) == "deployed"))
                | select((.node_size // "" | ascii_downcase) == "llm")
                | select((.datacenter // "" | ascii_downcase) == "baremetal:github-runner")
                | select(((.deployed_app // "") | startswith("measuring-enclave")) | not)
              ] | length'
          }

          count_measurer() {
            curl -sSf "${CP_URL}/api/v1/agents" | jq -r '
              [.agents[]
                | select(.verified == true)
                | select((.health_status // "" | ascii_downcase) == "healthy")
                | select((.status // "" | ascii_downcase) == "deployed")
                | select((.node_size // "" | ascii_downcase) == "llm")
                | select((.datacenter // "" | ascii_downcase) == "baremetal:github-runner")
                | select((.deployed_app // "") == "measuring-enclave-llm")
              ] | length'
          }

          non_measurer="$(count_non_measurer || echo 0)"
          measurer="$(count_measurer || echo 0)"
          required_non_measurer=2
          if [ "${measurer:-0}" -ge 1 ]; then
            required_non_measurer=1
          fi
          echo "Baremetal llm non-measurer candidates: $non_measurer (required: $required_non_measurer)"
          echo "Baremetal llm measurer agents: $measurer"

          while [ "${non_measurer:-0}" -lt "${required_non_measurer}" ]; do
            boots=$((boots + 1))
            if [ "$boots" -gt "$max_boots" ]; then
              echo "::error::Exceeded max LLM boot attempts ($max_boots) while waiting for verified capacity."
              curl -sSf "${CP_URL}/api/v1/agents" | jq -r '
                [.agents[] | select((.node_size // "" | ascii_downcase) == "llm")
                  | {agent_id, status, health_status, verified, datacenter, deployed_app, vm_name}]'
              exit 1
            fi
            echo "Booting a new baremetal llm agent VM..."
            vm_json="$(python3 infra/tdx_cli.py vm new --size llm --cloud-provider baremetal --availability-zone github-runner --easyenclave-url "${CP_URL}" --intel-api-key "${INTEL_API_KEY}" --wait)"
            name="$(echo "$vm_json" | jq -r '.name // empty')"
            if [ -n "$name" ]; then
              created+=("$name")
            fi

            # Give the agent time to register and pass verification.
            for _ in {1..60}; do
              non_measurer="$(count_non_measurer || echo 0)"
              if [ "${non_measurer:-0}" -ge "${required_non_measurer}" ]; then
                break
              fi
              sleep 5
            done

            non_measurer="$(count_non_measurer || echo 0)"
            measurer="$(count_measurer || echo 0)"
            if [ "${measurer:-0}" -ge 1 ]; then
              required_non_measurer=1
            fi
            echo "Baremetal llm non-measurer candidates now: $non_measurer (required: $required_non_measurer)"
            echo "Baremetal llm measurer agents now: $measurer"
          done

          printf '%s\n' "${created[@]:-}" > /tmp/new_llm_vms.txt || true
          echo "created_vms=$(paste -sd, /tmp/new_llm_vms.txt 2>/dev/null || true)" >> "$GITHUB_OUTPUT"

      - name: Bootstrap measuring-enclave-llm on shared control plane
        env:
          ADMIN_TOKEN: ${{ secrets.CP_ADMIN_TOKEN }}
          ADMIN_PASSWORD: ${{ env.CP_ADMIN_PASSWORD }}
          NODE_SIZE: llm
          ALLOWED_CLOUDS: baremetal
          ALLOWED_DATACENTERS: baremetal:github-runner
          TRUSTED_AGENT_MRTDS_BY_SIZE: ${{ steps.measure.outputs.mrtds_by_size }}
          TRUSTED_AGENT_RTMRS_BY_SIZE: ${{ steps.measure.outputs.rtmrs_by_size }}
        run: |
          set -euo pipefail
          chmod +x ./scripts/bootstrap_shared_measuring_enclave.sh
          CP_URL="${CP_URL}" \
          ADMIN_TOKEN="${ADMIN_TOKEN}" \
          ADMIN_PASSWORD="${ADMIN_PASSWORD}" \
          NODE_SIZE="${NODE_SIZE}" \
          MEASURER_IMAGE="${MEASURER_IMAGE}" \
          ALLOWED_CLOUDS="${ALLOWED_CLOUDS}" \
          ALLOWED_DATACENTERS="${ALLOWED_DATACENTERS}" \
          TRUSTED_AGENT_MRTDS_BY_SIZE="${TRUSTED_AGENT_MRTDS_BY_SIZE}" \
          TRUSTED_AGENT_RTMRS_BY_SIZE="${TRUSTED_AGENT_RTMRS_BY_SIZE}" \
          ./scripts/bootstrap_shared_measuring_enclave.sh

      - name: Verify deployable baremetal llm agent exists
        run: |
          set -euo pipefail
          count="$(curl -sSf "${CP_URL}/api/v1/agents" | jq -r '
            [.agents[]
              | select(.verified == true)
              | select((.health_status // "" | ascii_downcase) == "healthy")
              | select(((.status // "" | ascii_downcase) == "undeployed" or (.status // "" | ascii_downcase) == "deployed"))
              | select((.node_size // "" | ascii_downcase) == "llm")
              | select((.datacenter // "" | ascii_downcase) == "baremetal:github-runner")
              | select(((.deployed_app // "") | startswith("measuring-enclave")) | not)
            ] | length
          ')"
          echo "Deployable baremetal llm candidates: $count"
          if [ "${count:-0}" -lt 1 ]; then
            echo "::error::No deployable baremetal llm agent available for private-llm"
            curl -sSf "${CP_URL}/api/v1/agents" | jq -r '
              [.agents[] | select((.node_size // "" | ascii_downcase) == "llm")
                | {agent_id, status, health_status, verified, datacenter, deployed_app, vm_name}]'
            exit 1
          fi

      - name: Register private-llm app
        uses: ./.github/actions/register-app
        with:
          name: private-llm
          description: "Private LLM - Ollama running in a TDX enclave"

      - name: Deploy private-llm (llm)
        id: deploy
        uses: ./.github/actions/deploy-example
        with:
          app_name: private-llm
          compose_file: examples/private-llm/docker-compose.yml
          service_name: private-llm
          health_endpoint: /
          control_plane_url: ${{ env.CP_URL }}
          agent_admin_password: ${{ env.AGENT_ADMIN_PASSWORD }}
          github_owner: ${{ github.repository_owner }}
          node_size: llm
          allowed_clouds: baremetal
          allowed_datacenters: baremetal:github-runner

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install SDK and OpenAI client
        run: pip install ./sdk/ openai

      - name: Smoke test LLM query (direct + proxy)
        env:
          SERVICE_URL: ${{ steps.deploy.outputs.service_url }}
          EASYENCLAVE_URL: ${{ env.CP_URL }}
        run: python3 examples/private-llm/test.py

      - name: Cleanup newly-created VMs (optional)
        if: always() && github.event.inputs.keep_new_vms != 'true'
        run: |
          set -euo pipefail
          if [ ! -s /tmp/new_llm_vms.txt ]; then
            echo "No new VMs were created; nothing to clean up."
            exit 0
          fi

          # Best-effort: also delete agent registration when possible.
          ADMIN_TOKEN="$(
            curl -sf "${CP_URL}/admin/login" \
              -H "Content-Type: application/json" \
              -d "{\"password\": \"${CP_ADMIN_PASSWORD}\"}" \
            | jq -r '.token'
          )" || ADMIN_TOKEN=""

          while IFS= read -r vm; do
            [ -n "$vm" ] || continue
            echo "Deleting VM: $vm"
            python3 infra/tdx_cli.py vm delete "$vm" --easyenclave-url "${CP_URL}" --admin-token "${ADMIN_TOKEN}" || true
          done < /tmp/new_llm_vms.txt

      - name: Cleanup stale CI LLM VMs (post, best effort)
        if: always() && github.event.inputs.keep_new_vms != 'true'
        run: |
          set -euo pipefail
          bash ./scripts/cleanup_ci_llm_vms.sh || true
