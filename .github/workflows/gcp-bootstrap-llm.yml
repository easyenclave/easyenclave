# GCP Bootstrap LLM (deprecated measurer-free flow)
#
# This workflow used to bootstrap measuring-enclave-llm.
# The control plane now measures app versions directly (digest resolution + optional cosign),
# so the only remaining requirement is verified GCP LLM agent capacity.

name: GCP Bootstrap LLM

on:
  workflow_dispatch:
    inputs:
      cp_url:
        description: "Control plane URL"
        required: false
        default: "https://app.easyenclave.com"
      gcp_datacenter:
        description: "Preferred GCP datacenter label"
        required: false
        default: "gcp:us-central1-a"
      gcp_zone:
        description: "Fallback zone list used only to derive datacenter when unset"
        required: false
        default: "us-central1-a,us-central1-b,us-central1-c,us-central1-f,us-east4-a,us-west1-b"
      wait_seconds:
        description: "Seconds to wait for CP-dispatched GCP capacity"
        required: false
        default: "1800"

concurrency:
  group: gcp-bootstrap-llm-${{ github.ref }}
  cancel-in-progress: false

jobs:
  bootstrap-llm:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      CP_URL: ${{ github.event.inputs.cp_url || 'https://app.easyenclave.com' }}
      GCP_ZONE_LIST: ${{ github.event.inputs.gcp_zone || 'us-central1-a,us-central1-b,us-central1-c,us-central1-f,us-east4-a,us-west1-b' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve GCP datacenter target
        id: target
        shell: bash
        run: |
          set -euo pipefail
          dc="$(echo "${{ github.event.inputs.gcp_datacenter || '' }}" | tr '[:upper:]' '[:lower:]' | xargs)"
          if [ -z "$dc" ]; then
            first_zone="$(echo "${GCP_ZONE_LIST}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d' | head -n1 | tr '[:upper:]' '[:lower:]')"
            if [ -z "$first_zone" ]; then
              echo "::error::Unable to resolve GCP datacenter (gcp_datacenter and gcp_zone are empty)."
              exit 1
            fi
            dc="gcp:${first_zone}"
          fi
          case "$dc" in
            gcp:*) ;;
            gcp) ;;
            *) dc="gcp:${dc}" ;;
          esac
          echo "datacenter=$dc" >> "$GITHUB_OUTPUT"
          echo "Resolved datacenter: $dc"

      - name: Ensure GCP llm capacity for private-llm
        id: preflight_llm
        uses: ./.github/actions/preflight-gcp
        with:
          control_plane_url: ${{ env.CP_URL }}
          node_size: llm
          wait_seconds: ${{ github.event.inputs.wait_seconds || '1800' }}
          billing_account_id: ${{ secrets.CP_DEPLOYER_ACCOUNT_ID }}
          billing_api_key: ${{ secrets.CP_DEPLOYER_API_KEY }}
          billing_months: "1"
          gcp_datacenter: ${{ steps.target.outputs.datacenter }}
          gcp_zone: ${{ env.GCP_ZONE_LIST }}

      - name: Register private-llm app
        uses: ./.github/actions/register-app
        with:
          name: private-llm
          description: "Private LLM - Ollama running in a TDX enclave"
          control_plane_url: ${{ env.CP_URL }}

      - name: Deploy private-llm on GCP
        id: deploy
        uses: ./.github/actions/gcp-deploy-example
        with:
          app_name: private-llm
          compose_file: examples/private-llm/docker-compose.yml
          service_name: private-llm
          health_endpoint: /
          control_plane_url: ${{ env.CP_URL }}
          agent_admin_password: ${{ secrets.AGENT_ADMIN_PASSWORD }}
          github_owner: ${{ github.repository_owner }}
          node_size: llm
          gcp_datacenter: ${{ steps.target.outputs.datacenter }}
          billing_account_id: ${{ secrets.CP_DEPLOYER_ACCOUNT_ID }}
          billing_api_key: ${{ secrets.CP_DEPLOYER_API_KEY }}
          billing_months: "1"
          gcp_zone: ${{ env.GCP_ZONE_LIST }}
          wait_seconds: ${{ github.event.inputs.wait_seconds || '1800' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install SDK and OpenAI client
        run: pip install ./sdk/ openai

      - name: Smoke test private-llm
        env:
          SERVICE_URL: ${{ steps.deploy.outputs.service_url }}
          EASYENCLAVE_URL: ${{ env.CP_URL }}
        run: python3 examples/private-llm/test.py

      - name: Summary
        run: |
          echo "gcp_datacenter=${{ steps.target.outputs.datacenter }}"
          echo "preflight_gcp_eligible_agents=${{ steps.preflight_llm.outputs.gcp_eligible_agents }}"
          echo "preflight_gcp_provisioned=${{ steps.preflight_llm.outputs.gcp_provisioned }}"
          echo "deployment_id=${{ steps.deploy.outputs.deployment_id }}"
          echo "agent_id=${{ steps.deploy.outputs.agent_id }}"
          echo "service_url=${{ steps.deploy.outputs.service_url }}"
          echo "gcp_eligible_agents=${{ steps.deploy.outputs.gcp_eligible_agents }}"
          echo "gcp_provisioned=${{ steps.deploy.outputs.gcp_provisioned }}"
