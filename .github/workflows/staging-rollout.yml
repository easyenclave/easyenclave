# Staging Rollout
#
# Canonical staging network pipeline:
# 1) Bootstrap staging control plane from latest CI image on main
# 2) Run builtin deploy examples in parallel (baremetal + gcp)
#
# Staging profile is intentionally no-cost:
# - billing disabled
# - billing simulation enabled

name: Staging Rollout

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      cp_url:
        description: "Staging control plane URL"
        required: false
        default: ""
      cp_expected_git_sha:
        description: "Expected git SHA in /health (optional; empty skips check)"
        required: false
        default: ""
      source_ref:
        description: "Git ref to checkout for deploy examples"
        required: false
        default: ""
      control_plane_image:
        description: "Control plane image override"
        required: false
        default: ""

concurrency:
  group: easyenclave-staging-rollout
  cancel-in-progress: true

jobs:
  resolve:
    name: Resolve staging rollout config
    runs-on: ubuntu-latest
    outputs:
      cp_url: ${{ steps.resolve.outputs.cp_url }}
      cp_expected_git_sha: ${{ steps.resolve.outputs.cp_expected_git_sha }}
      source_ref: ${{ steps.resolve.outputs.source_ref }}
      staging_domain: ${{ steps.resolve.outputs.staging_domain }}
      staging_network_name: ${{ steps.resolve.outputs.staging_network_name }}
      staging_release_tag: ${{ steps.resolve.outputs.staging_release_tag }}
      should_run: ${{ steps.resolve.outputs.should_run }}
      skip_reason: ${{ steps.resolve.outputs.skip_reason }}
    steps:
      - name: Resolve URLs and refs
        id: resolve
        shell: bash
        env:
          INPUT_CP_URL: ${{ github.event.inputs.cp_url || '' }}
          INPUT_EXPECTED_SHA: ${{ github.event.inputs.cp_expected_git_sha || '' }}
          INPUT_SOURCE_REF: ${{ github.event.inputs.source_ref || '' }}
          WORKFLOW_RUN_SHA: ${{ github.event.workflow_run.head_sha || '' }}
          WORKFLOW_RUN_CONCLUSION: ${{ github.event.workflow_run.conclusion || '' }}
          DEFAULT_DOMAIN: ${{ vars.STAGING_EASYENCLAVE_DOMAIN || 'easyenclave.com' }}
          DEFAULT_NETWORK_NAME: ${{ vars.STAGING_NETWORK_NAME || '' }}
          DEFAULT_CP_URL: ${{ vars.STAGING_CP_URL || '' }}
          PROD_DEFAULT_DOMAIN: ${{ vars.PRODUCTION_EASYENCLAVE_DOMAIN || 'easyenclave.com' }}
          PROD_DEFAULT_CP_URL: ${{ vars.PRODUCTION_CP_URL || '' }}
        run: |
          set -euo pipefail
          make_network_name() {
            local seed="$1"
            local hash adjective_idx noun_idx suffix
            local -a adjectives=(trippy lucid nebula prism velvet cosmic solar ember aurora nova)
            local -a nouns=(voyager horizon drifter comet pulse atlas relay beacon vertex spectrum)
            hash="$(printf '%s' "$seed" | sha256sum | awk '{print $1}')"
            adjective_idx=$((16#${hash:0:2} % ${#adjectives[@]}))
            noun_idx=$((16#${hash:2:2} % ${#nouns[@]}))
            suffix="${hash:4:6}"
            printf '%s-%s-%s' "${adjectives[$adjective_idx]}" "${nouns[$noun_idx]}" "$suffix"
          }

          normalize_network_name() {
            printf '%s' "$1" \
              | tr '[:upper:]' '[:lower:]' \
              | sed -E 's/[^a-z0-9-]+/-/g; s/^-+//; s/-+$//; s/-{2,}/-/g'
          }

          source_ref="${INPUT_SOURCE_REF:-}"
          if [ -z "$source_ref" ]; then
            source_ref="${WORKFLOW_RUN_SHA:-${GITHUB_SHA}}"
          fi

          event_name="${GITHUB_EVENT_NAME:-}"
          workflow_run_conclusion="$(echo "${WORKFLOW_RUN_CONCLUSION:-}" | tr '[:upper:]' '[:lower:]')"
          if [ "$event_name" = "workflow_run" ] && [ "$workflow_run_conclusion" != "success" ]; then
            echo "::error::Upstream CI did not succeed (conclusion='${WORKFLOW_RUN_CONCLUSION:-unknown}'); refusing no-op green staging rollout."
            exit 1
          fi

          expected_sha="${INPUT_EXPECTED_SHA:-}"
          if [ -z "$expected_sha" ] && [ -n "${WORKFLOW_RUN_SHA:-}" ]; then
            expected_sha="${WORKFLOW_RUN_SHA}"
          fi
          release_seed="${expected_sha:-$source_ref}"
          release_seed="$(normalize_network_name "${release_seed}")"
          if [ -z "$release_seed" ]; then
            release_seed="${GITHUB_RUN_ID}"
          fi
          staging_release_tag="staging-${release_seed:0:20}"

          domain="${DEFAULT_DOMAIN:-easyenclave.com}"
          network_name="$(normalize_network_name "${DEFAULT_NETWORK_NAME:-}")"
          if [ -z "$network_name" ]; then
            network_name="$(make_network_name "staging:${source_ref}:${expected_sha}")"
          fi
          network_name="$(normalize_network_name "$network_name")"
          if [ -z "$network_name" ]; then
            echo "::error::Failed to resolve staging network name"
            exit 1
          fi
          network_name="${network_name:0:48}"
          cp_url="${INPUT_CP_URL:-}"
          if [ -z "$cp_url" ]; then
            cp_url="${DEFAULT_CP_URL:-}"
          fi
          if [ -z "$cp_url" ]; then
            cp_url="https://app-staging.${domain}"
          fi

          prod_domain="${PROD_DEFAULT_DOMAIN:-easyenclave.com}"
          prod_cp_url="${PROD_DEFAULT_CP_URL:-}"
          if [ -z "$prod_cp_url" ]; then
            prod_cp_url="https://app.${prod_domain}"
          fi
          if [ "$cp_url" = "$prod_cp_url" ]; then
            echo "::error::Staging and production CP URLs resolve to the same value: $cp_url"
            echo "::error::Set distinct vars: STAGING_CP_URL/STAGING_EASYENCLAVE_DOMAIN and PRODUCTION_CP_URL/PRODUCTION_EASYENCLAVE_DOMAIN."
            exit 1
          fi
          echo "::notice::Resolved staging network name: ${network_name}"

          should_run="true"
          skip_reason=""

          {
            echo "source_ref=${source_ref}"
            echo "cp_expected_git_sha=${expected_sha}"
            echo "staging_domain=${domain}"
            echo "staging_network_name=${network_name}"
            echo "staging_release_tag=${staging_release_tag}"
            echo "cp_url=${cp_url}"
            echo "should_run=${should_run}"
            echo "skip_reason=${skip_reason}"
          } >> "$GITHUB_OUTPUT"

  cleanup-staging-gcp:
    name: Cleanup stale staging GCP capacity
    needs: [resolve]
    if: needs.resolve.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      GCP_PROJECT_ID: ${{ secrets.STAGING_GCP_PROJECT_ID }}
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.STAGING_GCP_SERVICE_ACCOUNT_KEY }}
      SOURCE_IMAGE_PROJECT: ${{ vars.STAGING_GCP_SOURCE_IMAGE_PROJECT || vars.EE_GCP_SOURCE_IMAGE_PROJECT || secrets.PRODUCTION_GCP_PROJECT_ID }}
      SOURCE_IMAGE_FAMILY: ${{ vars.STAGING_GCP_SOURCE_IMAGE_FAMILY || vars.EE_GCP_SOURCE_IMAGE_FAMILY || 'easyenclave-agent' }}
    steps:
      - name: Validate staging GCP config
        id: cfg
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${GCP_PROJECT_ID:-}" ] || [ -z "${GCP_SERVICE_ACCOUNT_KEY:-}" ]; then
            echo "::notice::Skipping staging GCP cleanup: STAGING_GCP_PROJECT_ID / STAGING_GCP_SERVICE_ACCOUNT_KEY not configured."
            echo "configured=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "configured=true" >> "$GITHUB_OUTPUT"

      - name: Authenticate to GCP (staging)
        if: steps.cfg.outputs.configured == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up gcloud (staging)
        if: steps.cfg.outputs.configured == 'true'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Delete previous staging managed instances
        if: steps.cfg.outputs.configured == 'true'
        shell: bash
        run: |
          set -euo pipefail
          echo "Project: ${GCP_PROJECT_ID}"
          mapfile -t instances < <(gcloud compute instances list \
            --project "${GCP_PROJECT_ID}" \
            --filter "labels.easyenclave=managed" \
            --format "value(name,zone.basename())")
          if [ "${#instances[@]}" -eq 0 ]; then
            echo "No managed staging instances to delete."
            exit 0
          fi
          for row in "${instances[@]}"; do
            [ -n "$row" ] || continue
            name="$(echo "$row" | awk '{print $1}')"
            zone="$(echo "$row" | awk '{print $2}')"
            [ -n "$name" ] || continue
            [ -n "$zone" ] || continue
            echo "Deleting stale staging instance: ${name} (${zone})"
            gcloud compute instances delete "${name}" \
              --project "${GCP_PROJECT_ID}" \
              --zone "${zone}" \
              --quiet
          done

      - name: Ensure staging seed image exists for CP-native GCP provisioning
        if: steps.cfg.outputs.configured == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${SOURCE_IMAGE_PROJECT:-}" ] || [ -z "${SOURCE_IMAGE_FAMILY:-}" ]; then
            echo "::error::Missing SOURCE_IMAGE_PROJECT/SOURCE_IMAGE_FAMILY for staging seed image creation."
            exit 1
          fi

          # Validate source family exists before attempting to create a new seed.
          if ! gcloud compute images describe-from-family "${SOURCE_IMAGE_FAMILY}" \
            --project "${SOURCE_IMAGE_PROJECT}" >/dev/null 2>&1; then
            echo "::error::Source image family '${SOURCE_IMAGE_FAMILY}' not found in project '${SOURCE_IMAGE_PROJECT}'."
            exit 1
          fi

          image_name="easyenclave-agent-seed-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "Creating staging seed image '${image_name}' from ${SOURCE_IMAGE_PROJECT}/${SOURCE_IMAGE_FAMILY}"
          gcloud compute images create "${image_name}" \
            --project "${GCP_PROJECT_ID}" \
            --source-image-family "${SOURCE_IMAGE_FAMILY}" \
            --source-image-project "${SOURCE_IMAGE_PROJECT}" \
            --family "easyenclave-agent" \
            --labels "easyenclave=managed,easyenclave_env=staging"

      - name: Keep only latest staging seed image
        if: steps.cfg.outputs.configured == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t seeds < <(gcloud compute images list \
            --project "${GCP_PROJECT_ID}" \
            --filter "name~^easyenclave-agent-seed-" \
            --sort-by "~creationTimestamp" \
            --format "value(name)")
          if [ "${#seeds[@]}" -le 1 ]; then
            echo "Seed image cleanup not required."
            exit 0
          fi
          for old in "${seeds[@]:1}"; do
            [ -n "$old" ] || continue
            echo "Deleting stale staging seed image: ${old}"
            gcloud compute images delete "${old}" \
              --project "${GCP_PROJECT_ID}" \
              --quiet
          done

  bootstrap:
    name: Bootstrap staging control plane
    needs: [resolve, cleanup-staging-gcp]
    if: needs.resolve.outputs.should_run == 'true'
    uses: ./.github/workflows/bootstrap-control-plane.yml
    secrets: inherit
    with:
      source_ref: ${{ needs.resolve.outputs.source_ref }}
      control_plane_image: ${{ github.event.inputs.control_plane_image || format('ghcr.io/{0}/control-plane:{1}', github.repository, needs.resolve.outputs.source_ref) }}
      cp_bootstrap_sizes: tiny
      # Keep staging warm spare footprint small.
      num_tiny_agents: '1'
      num_standard_agents: '0'
      num_llm_agents: '0'
      easyenclave_domain: ${{ needs.resolve.outputs.staging_domain }}
      easyenclave_network_name: ${{ needs.resolve.outputs.staging_network_name }}
      easyenclave_release_tag: ${{ needs.resolve.outputs.staging_release_tag }}
      easyenclave_env: staging
      tcb_enforcement_mode: warn
      allowed_tcb_statuses: UpToDate
      # Staging is intentionally non-production: keep nonce enforcement permissive
      # so bootstrap can proceed even when attester-held-data propagation is flaky.
      nonce_enforcement_mode: optional
      nonce_ttl_seconds: '300'
      rtmr_enforcement_mode: warn
      signature_verification_mode: warn
      cp_to_agent_attestation_mode: optional
      auth_require_github_oauth_in_production: ${{ 'false' }}
      password_login_enabled: ${{ 'true' }}
      auth_allow_password_login_in_production: ${{ 'true' }}
      billing_enabled: ${{ 'false' }}
      billing_capacity_request_dev_simulation: ${{ 'true' }}
      billing_platform_account_id: ''
      billing_contributor_pool_bps: '0'

  deploy-baremetal:
    name: Builtin deploy examples (baremetal)
    needs: [resolve, bootstrap]
    uses: ./.github/workflows/deploy-examples.yml
    secrets: inherit
    with:
      cp_url: ${{ needs.bootstrap.outputs.cp_internal_url || needs.bootstrap.outputs.cp_url || needs.resolve.outputs.cp_url }}
      cp_expected_git_sha: ${{ needs.resolve.outputs.cp_expected_git_sha }}
      source_ref: ${{ needs.resolve.outputs.source_ref }}
      easyenclave_env: staging

  deploy-gcp:
    name: Builtin deploy examples (gcp)
    needs: [resolve, bootstrap]
    uses: ./.github/workflows/deploy-examples-gcp.yml
    secrets: inherit
    with:
      cp_url: ${{ needs.bootstrap.outputs.cp_public_url || needs.bootstrap.outputs.cp_url || needs.resolve.outputs.cp_url }}
      cp_expected_git_sha: ${{ needs.resolve.outputs.cp_expected_git_sha }}
      source_ref: ${{ needs.resolve.outputs.source_ref }}
      easyenclave_env: staging

  assert-rollout-executed:
    name: Assert staging rollout executed
    needs: [resolve, bootstrap, deploy-baremetal, deploy-gcp]
    if: always() && needs.resolve.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Fail if any rollout stage was skipped/failed
        shell: bash
        run: |
          set -euo pipefail
          bootstrap="${{ needs.bootstrap.result }}"
          baremetal="${{ needs['deploy-baremetal'].result }}"
          gcp="${{ needs['deploy-gcp'].result }}"
          echo "bootstrap=${bootstrap} baremetal=${baremetal} gcp=${gcp}"
          if [ "$bootstrap" != "success" ] || [ "$baremetal" != "success" ] || [ "$gcp" != "success" ]; then
            echo "::error::Staging rollout did not fully execute: bootstrap=${bootstrap}, baremetal=${baremetal}, gcp=${gcp}"
            exit 1
          fi
          echo "Staging rollout executed all required stages."
