# PR Staging Checks
#
# Pull-request checks plus rust-staging smoke validation.
# Smoke job runs only for same-repo PRs (secrets are not exposed to forks).

name: PR Staging Checks

on:
  pull_request:
    branches: [main]
    paths:
      - "app/**"
      - "infra/**"
      - "scripts/**"
      - "tests/**"
      - "sdk/**"
      - "docs/**"
      - "www/**"
      - ".github/actions/**"
      - ".github/workflows/**"
      - "Dockerfile"
      - "Dockerfile.ee-cp"
      - "docker-compose.yml"
      - "requirements.txt"
      - "pyproject.toml"

concurrency:
  group: easyenclave-pr-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  workflow-policy:
    name: Workflow policy checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install actionlint
        run: |
          set -euo pipefail
          curl -sL https://github.com/rhysd/actionlint/releases/download/v1.7.10/actionlint_1.7.10_linux_amd64.tar.gz | tar xz
          sudo mv actionlint /usr/local/bin/

      - name: Lint workflows
        run: actionlint

      - name: Enforce canonical rollout triggers
        shell: bash
        run: |
          set -euo pipefail
          # Deploy-example workflows are reusable/manual components only.
          if rg -n "workflow_run:" .github/workflows/deploy-examples.yml .github/workflows/deploy-examples-gcp.yml -S; then
            echo "::error::deploy-examples workflows must not have workflow_run triggers. Use staging-rollout.yml as orchestrator."
            exit 1
          fi

          # Production rollout must be release-gated + manual dispatch.
          if rg -n "pull_request:|push:" .github/workflows/production-rollout.yml -S; then
            echo "::error::production-rollout.yml must not trigger on pull_request/push."
            exit 1
          fi
          if rg -n "workflow_run:" .github/workflows/production-rollout.yml -S >/dev/null; then
            echo "::error::production-rollout.yml must not include workflow_run trigger."
            exit 1
          fi
          if ! rg -n "workflow_dispatch:" .github/workflows/production-rollout.yml -S >/dev/null; then
            echo "::error::production-rollout.yml must include workflow_dispatch trigger."
            exit 1
          fi
          if ! rg -n "release:" .github/workflows/release-trust-bundle.yml -S >/dev/null; then
            echo "::error::release-trust-bundle.yml must include release trigger."
            exit 1
          fi
          if ! rg -n "release:" .github/workflows/release-gcp-image.yml -S >/dev/null; then
            echo "::error::release-gcp-image.yml must include release trigger."
            exit 1
          fi

  rust-staging-smoke-pr:
    name: Rust staging smoke (PR)
    if: github.event.pull_request.head.repo.full_name == github.repository
    needs: [workflow-policy]
    runs-on: ubuntu-latest
    env:
      CP_URL: ${{ vars.STAGING_CP_URL || 'https://app-staging.easyenclave.com' }}
    steps:
      - name: Verify staging rust CP health + agents
        shell: bash
        run: |
          set -euo pipefail
          health="$(curl -fsS "$CP_URL/health")"
          echo "$health" | jq -e '.ok == true' >/dev/null
          agents="$(curl -fsS "$CP_URL/api/v1/agents")"
          total="$(echo "$agents" | jq -r '(if type == "array" then . else (.agents // []) end) | length')"
          verified="$(echo "$agents" | jq -r '(if type == "array" then . else (.agents // []) end) | [ .[] | select(.verified == true) ] | length')"
          echo "rust staging snapshot: verified=${verified} total=${total}"
