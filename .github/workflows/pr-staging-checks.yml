# PR Staging Checks
#
# Pull-request checks plus staging deploy-example validation.
# Deploy jobs run only for same-repo PRs (secrets are not exposed to forks).

name: PR Staging Checks

on:
  pull_request:
    branches: [main]
    paths:
      - "app/**"
      - "infra/**"
      - "scripts/**"
      - "tests/**"
      - "sdk/**"
      - "docs/**"
      - "www/**"
      - ".github/actions/**"
      - ".github/workflows/**"
      - "Dockerfile"
      - "docker-compose.yml"
      - "requirements.txt"
      - "pyproject.toml"

concurrency:
  group: easyenclave-pr-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  workflow-policy:
    name: Workflow policy checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install actionlint
        run: |
          set -euo pipefail
          curl -sL https://github.com/rhysd/actionlint/releases/download/v1.7.10/actionlint_1.7.10_linux_amd64.tar.gz | tar xz
          sudo mv actionlint /usr/local/bin/

      - name: Lint workflows
        run: actionlint

      - name: Enforce canonical rollout triggers
        shell: bash
        run: |
          set -euo pipefail
          has_match() {
            local pattern="$1"
            shift
            if command -v rg >/dev/null 2>&1; then
              rg -n "$pattern" "$@" -S >/dev/null
            else
              grep -nE "$pattern" "$@" >/dev/null
            fi
          }
          print_matches() {
            local pattern="$1"
            shift
            if command -v rg >/dev/null 2>&1; then
              rg -n "$pattern" "$@" -S
            else
              grep -nE "$pattern" "$@"
            fi
          }

          # Deploy-example workflows are reusable/manual components only.
          if print_matches "workflow_run:" .github/workflows/deploy-examples.yml .github/workflows/deploy-examples-gcp.yml; then
            echo "::error::deploy-examples workflows must not have workflow_run triggers. Use staging-rollout.yml as orchestrator."
            exit 1
          fi

          # Production rollout must be release-gated + manual dispatch.
          if print_matches "pull_request:|push:" .github/workflows/production-rollout.yml; then
            echo "::error::production-rollout.yml must not trigger on pull_request/push."
            exit 1
          fi
          if has_match "workflow_run:" .github/workflows/production-rollout.yml; then
            echo "::error::production-rollout.yml must not include workflow_run trigger."
            exit 1
          fi
          if ! has_match "workflow_dispatch:" .github/workflows/production-rollout.yml; then
            echo "::error::production-rollout.yml must include workflow_dispatch trigger."
            exit 1
          fi
          if ! has_match "release:" .github/workflows/release-trust-bundle.yml; then
            echo "::error::release-trust-bundle.yml must include release trigger."
            exit 1
          fi
          if ! has_match "release:" .github/workflows/release-gcp-image.yml; then
            echo "::error::release-gcp-image.yml must include release trigger."
            exit 1
          fi
          if ! has_match "release:" .github/workflows/release-example-images.yml; then
            echo "::error::release-example-images.yml must include release trigger."
            exit 1
          fi

  staging-readiness:
    name: Staging readiness (no-cost)
    runs-on: ubuntu-latest
    needs: [workflow-policy]
    env:
      CP_URL: ${{ vars.STAGING_CP_URL || 'https://app-staging.easyenclave.com' }}
      CP_ADMIN_TOKEN: ${{ secrets.CP_ADMIN_TOKEN }}
      CLOUDS: baremetal,gcp
      NODE_SIZE: tiny
      DC_BAREMETAL: ${{ vars.BAREMETAL_DATACENTER || 'baremetal:github-runner' }}
      DC_GCP: ${{ vars.GCP_DATACENTER || 'gcp:us-central1-a' }}
      SKIP_MISSING_DATACENTER: true
      FAIL_ON_UNSUPPORTED_CLOUDS: false
    steps:
      - uses: actions/checkout@v4

      - name: Verify staging cloud readiness
        run: ./scripts/verify-tdx-clouds.sh

  deploy-baremetal-pr:
    name: Builtin deploy examples (baremetal, PR)
    if: github.event.pull_request.head.repo.full_name == github.repository
    needs: [staging-readiness]
    uses: ./.github/workflows/deploy-examples.yml
    secrets: inherit
    with:
      cp_url: ${{ vars.STAGING_CP_URL || 'https://app-staging.easyenclave.com' }}
      cp_expected_git_sha: ""
      source_ref: ${{ github.event.pull_request.head.sha }}
      easyenclave_env: staging

  deploy-gcp-pr:
    name: Builtin deploy examples (gcp, PR)
    if: github.event.pull_request.head.repo.full_name == github.repository
    needs: [staging-readiness]
    uses: ./.github/workflows/deploy-examples-gcp.yml
    secrets: inherit
    with:
      cp_url: ${{ vars.STAGING_CP_URL || 'https://app-staging.easyenclave.com' }}
      cp_expected_git_sha: ""
      source_ref: ${{ github.event.pull_request.head.sha }}
      easyenclave_env: staging
