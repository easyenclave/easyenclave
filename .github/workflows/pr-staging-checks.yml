# PR Staging Checks
#
# No-cost, non-mutating checks for pull requests.
# This does not provision infrastructure or request paid capacity.

name: PR Staging Checks

on:
  pull_request:
    branches: [main]
    paths:
      - "app/**"
      - "infra/**"
      - "scripts/**"
      - "tests/**"
      - "sdk/**"
      - "docs/**"
      - "www/**"
      - ".github/actions/**"
      - ".github/workflows/**"
      - "README.md"
      - "Dockerfile"
      - "docker-compose.yml"
      - "requirements.txt"
      - "pyproject.toml"

concurrency:
  group: easyenclave-pr-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  workflow-policy:
    name: Workflow policy checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install actionlint
        run: |
          set -euo pipefail
          curl -sL https://github.com/rhysd/actionlint/releases/download/v1.7.10/actionlint_1.7.10_linux_amd64.tar.gz | tar xz
          sudo mv actionlint /usr/local/bin/

      - name: Lint workflows
        run: actionlint

      - name: Enforce canonical rollout triggers
        shell: bash
        run: |
          set -euo pipefail
          # Deploy-example workflows are reusable/manual components only.
          if rg -n "workflow_run:" .github/workflows/deploy-examples.yml .github/workflows/deploy-examples-gcp.yml -S; then
            echo "::error::deploy-examples workflows must not have workflow_run triggers. Use staging-rollout.yml as orchestrator."
            exit 1
          fi

          # Production rollout should remain manual-only.
          if rg -n "workflow_run:|pull_request:|push:" .github/workflows/production-rollout.yml -S; then
            echo "::error::production-rollout.yml must remain manual-only."
            exit 1
          fi

  staging-readiness:
    name: Staging readiness (no-cost)
    runs-on: ubuntu-latest
    needs: [workflow-policy]
    env:
      CP_URL: ${{ vars.STAGING_CP_URL || 'https://app.easyenclave.com' }}
      CLOUDS: baremetal,gcp
      NODE_SIZE: tiny
      DC_BAREMETAL: ${{ vars.BAREMETAL_DATACENTER || 'baremetal:github-runner' }}
      DC_GCP: ${{ vars.GCP_DATACENTER || 'gcp:us-central1-a' }}
      SKIP_MISSING_DATACENTER: true
      FAIL_ON_UNSUPPORTED_CLOUDS: false
    steps:
      - uses: actions/checkout@v4

      - name: Verify staging cloud readiness
        run: ./scripts/verify-tdx-clouds.sh
