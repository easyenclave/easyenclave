name: Cloud Confidential Agents
# TODO(azure): Re-enable Azure provisioning after confidential VM boot reliability is fixed.

on:
  workflow_dispatch:
    inputs:
      cp_url:
        description: "Control plane URL"
        required: false
        default: "https://app.easyenclave.com"
      enable_gcp:
        description: "Provision GCP confidential TDX agent"
        required: false
        type: boolean
        default: true
      keep_resources:
        description: "Keep cloud resources even on success (for a persistent cloud agent)"
        required: false
        type: boolean
        default: false
      keep_resources_on_failure:
        description: "Keep cloud resources when job fails (for debugging)"
        required: false
        type: boolean
        default: false
      cleanup_all_managed:
        description: "Cleanup ALL managed resources in the project (dangerous)"
        required: false
        type: boolean
        default: false
      node_size:
        description: "Agent node_size label"
        required: false
        default: "tiny"
      gcp_zone:
        description: "GCP zone"
        required: false
        default: "us-central1-a"
      gcp_region:
        description: "GCP region"
        required: false
        default: "us-central1"
      gcp_machine_type:
        description: "GCP machine type"
        required: false
        default: "c3-standard-4"
      wait_seconds:
        description: "Seconds to wait for agent registration before failing (diagnostics will be printed)"
        required: false
        default: "900"
      verify_app_name:
        description: "Optional app name for deploy preflight checks"
        required: false
        default: ""
      verify_app_version:
        description: "Optional app version for deploy preflight checks"
        required: false
        default: ""

concurrency:
  group: cloud-confidential-agents-${{ github.ref }}
  cancel-in-progress: false

jobs:
  provision-verify-cleanup:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      CP_URL: ${{ github.event.inputs.cp_url || 'https://app.easyenclave.com' }}
      NODE_SIZE: ${{ github.event.inputs.node_size || 'tiny' }}
      GCP_ZONE: ${{ github.event.inputs.gcp_zone || 'us-central1-a' }}
      GCP_REGION: ${{ github.event.inputs.gcp_region || 'us-central1' }}
      GCP_MACHINE_TYPE: ${{ github.event.inputs.gcp_machine_type || 'c3-standard-4' }}
      WAIT_SECONDS: ${{ github.event.inputs.wait_seconds || '900' }}
      VERIFY_APP_NAME: ${{ github.event.inputs.verify_app_name || '' }}
      VERIFY_APP_VERSION: ${{ github.event.inputs.verify_app_version || '' }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_WIF_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_WIF_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      GCP_SERVICE_ACCOUNT_KEY: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      INTEL_API_KEY: ${{ secrets.INTEL_API_KEY }}
      CP_ADMIN_TOKEN: ${{ secrets.CP_ADMIN_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Set run metadata
        run: |
          RUN_TAG="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          {
            echo "RUN_TAG=$RUN_TAG"
            echo "LAUNCHER_URL=https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${GITHUB_SHA}/infra/launcher/launcher.py"
            echo "CP_ADMIN_TOKEN=${CP_ADMIN_TOKEN:-}"
          } >> "$GITHUB_ENV"

      - name: Validate minimum secrets
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.enable_gcp || 'true' }}" != "true" ]; then
            echo "::error::enable_gcp is false; no active cloud targets remain"
            exit 1
          fi
          if [ -z "${INTEL_API_KEY:-}" ]; then
            echo "::error::Missing INTEL_API_KEY secret"
            exit 1
          fi
          if [ -z "${GCP_PROJECT_ID:-}" ]; then
            echo "::error::Missing GCP_PROJECT_ID secret"
            exit 1
          fi
          if [ -z "${CP_ADMIN_TOKEN:-}" ]; then
            echo "::warning::CP_ADMIN_TOKEN is not set; registration/verification checks will run unauthenticated"
          fi

      - name: Auth mode summary
        run: |
          set -euo pipefail
          if [ -n "${GCP_WIF_PROVIDER:-}" ] && [ -n "${GCP_WIF_SERVICE_ACCOUNT:-}" ]; then
            echo "GCP auth mode: OIDC"
          elif [ -n "${GCP_SERVICE_ACCOUNT_KEY:-}" ]; then
            echo "::warning::GCP OIDC not configured; using service-account-key fallback"
          else
            echo "::error::GCP auth is not configured (missing OIDC inputs and service-account key)"
            exit 1
          fi

      - name: Authenticate to Google Cloud (OIDC)
        if: env.GCP_WIF_PROVIDER != '' && env.GCP_WIF_SERVICE_ACCOUNT != ''
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Authenticate to Google Cloud (service account key fallback)
        if: env.GCP_WIF_PROVIDER == '' && env.GCP_SERVICE_ACCOUNT_KEY != ''
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Optional preflight cleanup (all managed)
        if: github.event.inputs.cleanup_all_managed == 'true'
        run: |
          set -euo pipefail
          echo "::warning::cleanup_all_managed=true: deleting ALL managed GCP resources in project=$GCP_PROJECT_ID zone=$GCP_ZONE"
          python3 scripts/cloud_provisioner.py cleanup \
            --provider gcp \
            --all-managed \
            --gcp-project "$GCP_PROJECT_ID" \
            --gcp-zone "$GCP_ZONE" \
            --gcp-region "$GCP_REGION"

      - name: Provision GCP agent
        run: |
          set -euo pipefail
          python3 scripts/cloud_provisioner.py provision \
            --provider gcp \
            --run-id "$RUN_TAG" \
            --cp-url "$CP_URL" \
            --cp-admin-token "$CP_ADMIN_TOKEN" \
            --intel-api-key "$INTEL_API_KEY" \
            --node-size "$NODE_SIZE" \
            --launcher-url "$LAUNCHER_URL" \
            --gcp-project "$GCP_PROJECT_ID" \
            --gcp-zone "$GCP_ZONE" \
            --gcp-region "$GCP_REGION" \
            --gcp-machine-type "$GCP_MACHINE_TYPE" \
            --gcp-count 1 \
            --wait-registration \
            --wait-seconds "$WAIT_SECONDS"

      - name: Verify cloud readiness
        run: |
          set -euo pipefail
          CP_URL="$CP_URL" \
          CP_ADMIN_TOKEN="$CP_ADMIN_TOKEN" \
          CLOUDS="gcp" \
          NODE_SIZE="$NODE_SIZE" \
          VERIFY_APP_NAME="$VERIFY_APP_NAME" \
          VERIFY_APP_VERSION="$VERIFY_APP_VERSION" \
          DC_GCP="gcp:${GCP_ZONE}" \
          SKIP_MISSING_DATACENTER="false" \
          FAIL_ON_UNSUPPORTED_CLOUDS="false" \
          ./scripts/verify-tdx-clouds.sh

      - name: Preserve resources note (keep_resources)
        if: github.event.inputs.keep_resources == 'true'
        run: |
          echo "::warning::Skipping cleanup because keep_resources=true"
          echo "Inspect resources in project $GCP_PROJECT_ID (zone=$GCP_ZONE)."

      - name: Preserve resources note
        if: failure() && (github.event.inputs.keep_resources_on_failure == 'true')
        run: |
          echo "::warning::Skipping cleanup because keep_resources_on_failure=true"
          echo "Inspect resources in project $GCP_PROJECT_ID"

      - name: Cleanup managed cloud resources
        if: always() && (github.event.inputs.keep_resources != 'true') && ((github.event.inputs.keep_resources_on_failure || 'false') != 'true' || success())
        run: |
          set -euo pipefail
          python3 scripts/cloud_provisioner.py cleanup \
            --provider gcp \
            --run-id "$RUN_TAG" \
            --gcp-project "$GCP_PROJECT_ID" \
            --gcp-zone "$GCP_ZONE" \
            --gcp-region "$GCP_REGION" || true
