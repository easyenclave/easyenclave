<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyEnclave Admin</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        :root {
            --bg: #f2f6f3;
            --bg-grad-a: #d8ebe2;
            --bg-grad-b: #dce9f5;
            --surface: #ffffff;
            --surface-2: #f8fcfa;
            --text: #12231e;
            --muted: #5a7068;
            --line: #d7e4dd;
            --accent: #0f766e;
            --accent-strong: #115e59;
            --accent-soft: #ccfbf1;
            --danger: #b91c1c;
            --warning: #b45309;
            --info: #155e75;
            --success: #166534;
            --shadow: 0 16px 36px rgba(18, 35, 30, 0.08);
            --radius: 14px;
        }

        body {
            font-family: "IBM Plex Sans", "Avenir Next", "Trebuchet MS", "Segoe UI", sans-serif;
            background:
                radial-gradient(circle at 0% 0%, var(--bg-grad-a) 0%, transparent 32%),
                radial-gradient(circle at 100% 0%, var(--bg-grad-b) 0%, transparent 28%),
                linear-gradient(180deg, var(--bg) 0%, #edf4f0 100%);
            color: var(--text);
            line-height: 1.45;
            min-height: 100vh;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .hidden { display: none !important; }

        .login-container {
            max-width: 470px;
            margin: 74px auto;
            padding: 28px;
            background: var(--surface);
            border-radius: 20px;
            border: 1px solid var(--line);
            box-shadow: var(--shadow);
        }

        .login-container h1 {
            font-family: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace;
            font-size: 1.25rem;
            letter-spacing: 0.02em;
            margin-bottom: 20px;
        }

        .login-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 18px;
            display: none;
            font-size: 0.9rem;
        }

        .admin-header {
            position: sticky;
            top: 0;
            z-index: 40;
            border-bottom: 1px solid var(--line);
            background: rgba(242, 246, 243, 0.9);
            backdrop-filter: blur(10px);
        }

        header h1 {
            font-family: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace;
            letter-spacing: 0.03em;
            margin: 0 0 4px;
        }

        header .subtitle {
            margin: 0;
            color: var(--muted);
            font-size: 0.86rem;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            min-height: 82px;
        }

        .header-links {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 18px;
        }

        .header-links a {
            text-decoration: none;
            color: var(--info);
            font-weight: 600;
            border: 1px solid #cfe2dc;
            background: #f4fbf8;
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 0.8rem;
        }

        .header-links a:hover {
            background: #e9f7f2;
            border-color: #b8dbcf;
        }

        .user-info {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 7px 10px;
            border-radius: 999px;
            background: #f3fbf8;
            border: 1px solid #cde5db;
        }

        .user-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 2px solid #bde3d6;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 0;
        }

        .user-name {
            color: var(--text);
            font-weight: 700;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .user-method {
            color: var(--muted);
            font-size: 0.72rem;
            white-space: nowrap;
        }

        main.container {
            padding-top: 18px;
            padding-bottom: 28px;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 14px;
            border-bottom: 0;
            padding-bottom: 0;
        }

        .tab {
            border: 1px solid #d4e5de;
            border-radius: 10px;
            background: #f7fcf9;
            color: var(--muted);
            padding: 9px 14px;
            font-size: 0.86rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .tab:hover {
            color: var(--text);
            border-color: #bfd9cf;
            background: #edf8f3;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
            color: #f0fdfa;
            border-color: transparent;
            box-shadow: 0 8px 18px rgba(15, 118, 110, 0.28);
        }

        .tab-content {
            background: var(--surface);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 18px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .section-header h2 {
            font-size: 1.05rem;
            margin: 0;
        }

        .section-card {
            background: var(--surface-2);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(18, 35, 30, 0.03);
        }

        .section-card h3 {
            margin: 0 0 10px;
            font-size: 0.95rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 10px;
        }

        .stat-card {
            background: #f1f8f5;
            border: 1px solid #d5e7df;
            border-radius: 10px;
            padding: 12px;
        }

        .stat-card .stat-label {
            font-size: 0.74rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
            font-weight: 700;
        }

        .stat-card .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text);
        }

        .stat-card .stat-detail {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 2px;
        }

        .data-table,
        .deployments-table,
        .versions-table,
        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--line);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }

        .data-table th,
        .data-table td,
        .deployments-table th,
        .deployments-table td,
        .versions-table th,
        .versions-table td,
        table th,
        table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e1ebe6;
            vertical-align: top;
            font-size: 0.84rem;
        }

        .data-table th,
        .deployments-table th,
        .versions-table th,
        table th {
            background: #edf6f2;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-size: 0.72rem;
        }

        .data-table code,
        .deployments-table code,
        .versions-table code,
        code {
            background: #edf6f2;
            border: 1px solid #d6e5de;
            border-radius: 7px;
            padding: 2px 6px;
            font-family: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace;
            font-size: 0.75rem;
            overflow-wrap: anywhere;
        }

        .btn-primary,
        .btn-secondary,
        .btn-danger,
        .btn-warning,
        .btn-info,
        .btn-small {
            border: none;
            border-radius: 9px;
            cursor: pointer;
            font-weight: 700;
            transition: transform 0.14s ease, opacity 0.14s ease;
        }

        .btn-primary,
        .btn-secondary,
        .btn-danger,
        .btn-warning,
        .btn-info {
            padding: 9px 14px;
            font-size: 0.84rem;
        }

        .btn-small {
            padding: 7px 11px;
            font-size: 0.78rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
            color: #f0fdfa;
        }

        .btn-primary:hover { transform: translateY(-1px); }

        .btn-secondary {
            background: #e6f0ec;
            color: #1f3c35;
            border: 1px solid #c9ddd4;
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        .btn-warning {
            background: #f59e0b;
            color: #fff;
        }

        .btn-info {
            background: #0e7490;
            color: #fff;
        }

        .add-form {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr auto;
            gap: 8px;
        }

        .add-form input,
        .add-form select,
        select,
        .setting-input,
        .wizard-form input,
        .login-container input {
            width: 100%;
            padding: 9px 10px;
            border: 1px solid var(--line);
            border-radius: 9px;
            font-size: 0.85rem;
            color: var(--text);
            background: #fbfdfc;
        }

        .add-form input:focus,
        .add-form select:focus,
        select:focus,
        .setting-input:focus,
        .wizard-form input:focus,
        .login-container input:focus {
            outline: 2px solid rgba(15, 118, 110, 0.22);
            border-color: var(--accent);
        }

        .log-viewer {
            background: #0b1220;
            color: #dbeafe;
            border: 1px solid #111827;
            border-radius: 12px;
            font-family: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace;
            font-size: 0.77rem;
            max-height: 440px;
            overflow-y: auto;
            padding: 13px;
            line-height: 1.45;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .log-entry { margin-bottom: 4px; }
        .log-entry.error { color: #fca5a5; }
        .log-entry.warning { color: #fcd34d; }
        .log-entry.info { color: #93c5fd; }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-dot.active { background: #22c55e; }
        .status-dot.inactive { background: #94a3b8; }

        .source-badge,
        .orphan-badge,
        .linked-badge,
        .status-badge,
        .verified-badge,
        .unverified-badge {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 3px 8px;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .source-badge.db { background: #0e7490; color: #e0f2fe; }
        .source-badge.env { background: #b45309; color: #fffbeb; }
        .source-badge.default { background: #64748b; color: #f8fafc; }

        .orphan-badge { background: #ef4444; color: #fff; }
        .linked-badge { background: #22c55e; color: #f0fdf4; }

        .status-badge.pending { background: #fef3c7; color: #92400e; }
        .status-badge.attested,
        .status-badge.completed,
        .status-badge.deployed { background: #dcfce7; color: #166534; }
        .status-badge.deploying,
        .status-badge.running { background: #ccfbf1; color: #115e59; }
        .status-badge.undeployed { background: #e2e8f0; color: #334155; }
        .status-badge.failed,
        .status-badge.error,
        .status-badge.rejected { background: #fee2e2; color: #991b1b; }

        .verified-badge { background: #dcfce7; color: #166534; }
        .unverified-badge { background: #fee2e2; color: #991b1b; }

        .attestation-link {
            color: var(--info);
            text-decoration: none;
            font-weight: 600;
        }

        .attestation-link:hover { text-decoration: underline; }

        .settings-group-btn {
            background: #ecf4f1;
            color: #34524a;
            border: 1px solid #cfe0d9;
        }

        .settings-group-btn.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
            color: #f0fdfa;
            border-color: transparent;
        }

        .setting-desc { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }
        .setting-env { font-size: 0.74rem; color: #6b8b80; }

        .github-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 700;
            color: #f8fafc;
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 14px;
        }

        .divider {
            text-align: center;
            margin: 16px 0;
            color: #6f8b80;
            position: relative;
            font-size: 0.78rem;
            letter-spacing: 0.04em;
        }

        .divider::before,
        .divider::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #d5e4dd;
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .wizard-container {
            max-width: 700px;
            margin: 54px auto;
            padding: 0 20px;
        }

        .wizard-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .wizard-step-indicator {
            width: 11px;
            height: 11px;
            border-radius: 50%;
            background: #c5d8d0;
        }

        .wizard-step-indicator.active { background: var(--accent); }
        .wizard-step-indicator.completed { background: #22c55e; }

        .wizard-panel {
            background: var(--surface);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 24px;
        }

        .wizard-panel h2 { margin-bottom: 10px; font-size: 1.15rem; }
        .wizard-panel p { color: var(--muted); margin-bottom: 12px; }

        .wizard-actions {
            display: flex;
            justify-content: flex-end;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 18px;
        }

        .wizard-instructions {
            background: #eff7f3;
            border: 1px solid #d5e6de;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .wizard-instructions ol { margin: 0; padding-left: 18px; color: #38564d; line-height: 1.7; }
        .wizard-instructions code { font-size: 0.76rem; }

        .wizard-callback-url {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wizard-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 12px;
            display: none;
            font-size: 0.86rem;
        }

        .wizard-success-icon {
            text-align: center;
            font-size: 44px;
            margin-bottom: 12px;
        }

        .modal,
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 1000;
        }

        .modal {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.hidden,
        .modal-overlay.hidden { display: none !important; }

        .modal > .modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.46);
            z-index: 0;
        }

        .modal .modal-content,
        .modal-overlay > .modal {
            position: relative;
            z-index: 1;
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 14px;
            box-shadow: var(--shadow);
            max-width: min(1020px, 96vw);
            width: 100%;
            max-height: 84vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--line);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            background: #f3faf7;
        }

        .modal-header h2 { margin: 0; font-size: 1rem; }

        .modal-body,
        #measurementDetails {
            padding: 14px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #64748b;
            font-size: 24px;
            line-height: 1;
            cursor: pointer;
        }

        .loading,
        .empty,
        .error {
            text-align: center;
            padding: 24px;
            color: var(--muted);
            background: #f4faf7;
            border: 1px dashed #cfe0d9;
            border-radius: 10px;
            font-size: 0.86rem;
        }

        .error { color: #991b1b; background: #fef2f2; border-color: #fecaca; }

        footer {
            margin-top: 20px;
            padding: 16px 0 24px;
            text-align: center;
            color: var(--muted);
            font-size: 0.8rem;
        }

        @media (max-width: 980px) {
            .header-row {
                align-items: flex-start;
                flex-direction: column;
                padding: 12px 0;
            }

            .header-links {
                margin-left: 0;
                flex-wrap: wrap;
            }

            .add-form {
                grid-template-columns: 1fr;
            }

            .tab-content { padding: 12px; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage">
        <div class="login-container">
            <h1>Admin Login</h1>
            <div id="loginError" class="login-error"></div>

            <!-- GitHub OAuth Button -->
            <div id="githubLoginSection">
                <button id="githubLoginBtn" class="github-btn">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    Sign in with GitHub
                </button>
            </div>

            <div id="passwordLoginSection">
                <div class="divider">OR</div>

                <!-- Password Login Form -->
                <form id="loginForm" onsubmit="login(event)">
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%">Login with Password</button>
                </form>
            </div>

            <p id="noLoginMethods" class="hidden" style="text-align: center; color: #991b1b;">No login methods available. Set PASSWORD_LOGIN_ENABLED=true or configure GitHub OAuth.</p>
        </div>
    </div>

    <!-- Setup Wizard -->
    <div id="setupWizard" class="hidden">
        <div class="wizard-container">
            <div class="wizard-steps">
                <div class="wizard-step-indicator active" data-step="1"></div>
                <div class="wizard-step-indicator" data-step="2"></div>
                <div class="wizard-step-indicator" data-step="3"></div>
                <div class="wizard-step-indicator" data-step="4"></div>
            </div>

            <!-- Step 1: Welcome -->
            <div id="wizardStep1" class="wizard-panel">
                <h2>Set up GitHub Authentication?</h2>
                <p>GitHub OAuth lets admins sign in with their GitHub account instead of a shared password. This is more secure and provides individual audit trails.</p>
                <p>This wizard will guide you through creating a GitHub OAuth App and connecting it to EasyEnclave. It only takes a couple of minutes.</p>
                <div class="wizard-actions">
                    <button class="btn-secondary" onclick="skipWizard()">Skip Setup</button>
                    <button class="btn-primary" onclick="wizardNext(2)">Set Up GitHub OAuth</button>
                </div>
            </div>

            <!-- Step 2: Create OAuth App + Enter Credentials -->
            <div id="wizardStep2" class="wizard-panel hidden">
                <h2>Create a GitHub OAuth App</h2>
                <div class="wizard-instructions">
                    <ol>
                        <li>Go to <a href="https://github.com/settings/developers" target="_blank">github.com/settings/developers</a></li>
                        <li>Click <strong>New OAuth App</strong></li>
                        <li>Set <strong>Application name</strong> to <code>EasyEnclave Admin</code></li>
                        <li>Set <strong>Homepage URL</strong> to your control plane URL</li>
                        <li>Set <strong>Authorization callback URL</strong> to the value below</li>
                        <li>Click <strong>Register application</strong>, then generate a client secret</li>
                    </ol>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 600; color: var(--gray-700); font-size: 0.9rem; display: block; margin-bottom: 4px;">Callback URL</label>
                    <div class="wizard-callback-url">
                        <input type="text" id="wizardCallbackUrl" readonly>
                        <button onclick="copyCallbackUrl()">Copy</button>
                    </div>
                </div>

                <div id="wizardOAuthError" class="wizard-error"></div>

                <div class="wizard-form">
                    <div class="form-group">
                        <label for="wizardClientId">Client ID</label>
                        <input type="text" id="wizardClientId" placeholder="Ov23li..." autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="wizardClientSecret">Client Secret</label>
                        <input type="password" id="wizardClientSecret" placeholder="Paste your client secret" autocomplete="off">
                    </div>
                </div>

                <div class="wizard-actions">
                    <button class="btn-secondary" onclick="wizardNext(1)">Back</button>
                    <button class="btn-secondary" onclick="skipWizard()">Skip</button>
                    <button class="btn-primary" onclick="wizardSaveOAuth()">Save &amp; Continue</button>
                </div>
            </div>

            <!-- Step 3: Link GitHub Account -->
            <div id="wizardStep3" class="wizard-panel hidden">
                <h2>Link Your GitHub Account</h2>
                <p>Test the configuration by linking your GitHub account to this admin session. This starts the OAuth flow you just configured.</p>
                <p>If the redirect works and you authorize the app, your admin session will be linked to your GitHub identity.</p>
                <div class="wizard-actions">
                    <button class="btn-secondary" onclick="wizardNext(4)">Skip This Step</button>
                    <button class="btn-primary" onclick="wizardLinkGitHub()">Link GitHub Account</button>
                </div>
            </div>

            <!-- Step 4: Done -->
            <div id="wizardStep4" class="wizard-panel hidden">
                <div class="wizard-success-icon">&#10003;</div>
                <h2 style="text-align: center;">Setup Complete</h2>
                <p id="wizardDoneMsg" style="text-align: center;">GitHub OAuth is configured. Admins can now sign in using their GitHub accounts.</p>
                <div id="wizardDisablePasswordOption" class="hidden" style="margin: 20px 0; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="wizardDisablePassword" style="margin-top: 3px;">
                        <div>
                            <strong>Disable password login</strong>
                            <p style="margin: 4px 0 0; font-size: 0.85rem; color: var(--gray-600);">Only GitHub OAuth will be allowed. You can re-enable this later in Settings &gt; Auth.</p>
                        </div>
                    </label>
                </div>
                <div class="wizard-actions" style="justify-content: center;">
                    <button class="btn-primary" onclick="finishWizard()">Go to Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="hidden">
        <header class="admin-header">
            <div class="container">
                <div class="header-row">
                    <div>
                        <h1>EasyEnclave Admin</h1>
                        <p class="subtitle">Control Plane Management</p>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div id="userInfo" class="user-info">
                            <img id="userAvatar" src="" alt="" class="user-avatar" style="display: none;">
                            <div class="user-details">
                                <span id="userName" class="user-name"></span>
                                <span id="userMethod" class="user-method"></span>
                            </div>
                        </div>
                        <div class="header-links">
                            <a href="/">Public UI</a>
                            <a href="/docs">API Docs</a>
                            <a href="#" onclick="logout()">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">
            <!-- Tabs -->
	            <div class="tabs">
	                <button class="tab active" onclick="showAdminTab('agents')">Agents</button>
	                <button class="tab" onclick="showAdminTab('apps')">Apps</button>
	                <button class="tab" onclick="showAdminTab('accounts')">Accounts</button>
	                <button class="tab" onclick="showAdminTab('stripe')">Stripe</button>
	                <button class="tab" onclick="showAdminTab('measurements')">Measurements</button>
	                <button class="tab" onclick="showAdminTab('settings')">Settings</button>
	                <button class="tab" onclick="showAdminTab('cloud')">Clouds</button>
	                <button class="tab" onclick="showAdminTab('cloudflare')">Cloudflare</button>
	                <button class="tab" onclick="showAdminTab('logs')">Logs</button>
	                <button class="tab" onclick="showAdminTab('system')">System</button>
	            </div>

            <!-- Agents Tab -->
            <section id="agents-admin-tab" class="tab-content">
                <div class="section-header">
                    <h2>Manage Agents</h2>
                    <button class="btn-primary refresh-btn" onclick="loadAgents()">Refresh</button>
                </div>
                <div class="section-card" style="margin-bottom: 16px;">
                    <div class="add-form" style="grid-template-columns: 2fr 1fr 1fr 1fr auto auto; align-items: center;">
                        <input type="text" id="agentFilterQuery" placeholder="Search (vm/app/owner/agent_id)" oninput="onAgentsFilterChanged()">
                        <select id="agentFilterDatacenter" onchange="onAgentsFilterChanged()">
                            <option value="">All datacenters</option>
                        </select>
                        <select id="agentFilterSize" onchange="onAgentsFilterChanged()">
                            <option value="">All sizes</option>
                        </select>
                        <label style="display:flex;gap:8px;align-items:center;white-space:nowrap;">
                            <input type="number" id="agentFilterActiveHours" min="0" step="0.5" value="2" onchange="onAgentsFilterChanged()" style="width:90px;">
                            <span style="color:var(--gray-600);">active (h)</span>
                        </label>
                        <button class="btn-small btn-secondary" onclick="resetAgentsFilters()">Reset Filters</button>
                        <button class="btn-small btn-warning" onclick="cleanupStaleAgentsNow()">Cleanup Stale</button>
                    </div>
                    <div style="margin-top: 10px; display:flex; gap:14px; flex-wrap:wrap; align-items:center;">
                        <label style="display:flex;gap:8px;align-items:center;">
                            <input type="checkbox" id="agentFilterOnlyEligible" checked onchange="onAgentsFilterChanged()">
                            <span>Only eligible (verified + healthy)</span>
                        </label>
                        <label style="display:flex;gap:8px;align-items:center;">
                            <input type="checkbox" id="agentFilterShowUnverified" onchange="onAgentsFilterChanged()">
                            <span>Show unverified</span>
                        </label>
                        <label style="display:flex;gap:8px;align-items:center;">
                            <input type="checkbox" id="agentFilterShowUnhealthy" onchange="onAgentsFilterChanged()">
                            <span>Show unhealthy</span>
                        </label>
                        <label style="display:flex;gap:8px;align-items:center;">
                            <input type="checkbox" id="agentFilterShowStale" onchange="onAgentsFilterChanged()">
                            <span>Show stale/offline</span>
                        </label>
                    </div>
                    <div id="agentsAdminSummary" style="margin-top: 10px; color: var(--gray-600); font-size: 0.9rem;"></div>
                </div>
                <div id="agentsAdminList">
                    <div class="loading">Loading agents...</div>
                </div>
            </section>

            <!-- Apps Tab -->
            <section id="apps-admin-tab" class="tab-content hidden">
                <div class="section-header">
                    <h2>App Catalog</h2>
                    <button class="btn-primary refresh-btn" onclick="loadApps()">Refresh</button>
                </div>
                <div id="appsAdminList">
                    <div class="loading">Loading apps...</div>
                </div>
            </section>

	            <!-- Accounts Tab -->
	            <section id="accounts-admin-tab" class="tab-content hidden">
	                <div class="section-header">
	                    <h2>Billing Accounts</h2>
	                    <button class="btn-primary refresh-btn" onclick="loadAccounts()">Refresh</button>
	                </div>
                <div class="section-card">
                    <h3>Create Account</h3>
                    <div class="add-form">
                        <input type="text" id="accountName" placeholder="Account name">
                        <select id="accountType">
                            <option value="deployer">Deployer</option>
                            <option value="agent">Agent</option>
                            <option value="contributor">Contributor</option>
                            <option value="launcher">Launcher</option>
                        </select>
                        <button class="btn-primary" onclick="createAccount()">Create</button>
                    </div>
                </div>
	                <div id="accountsAdminList">
	                    <div class="loading">Loading accounts...</div>
	                </div>
	            </section>

	            <!-- Stripe Tab -->
	            <section id="stripe-admin-tab" class="tab-content hidden">
	                <div class="section-header">
	                    <h2>Stripe</h2>
	                    <button class="btn-primary refresh-btn" onclick="loadStripeAdmin()">Refresh</button>
	                </div>
	                <div class="section-card">
	                    <p style="color: var(--gray-600); margin-bottom: 10px;">
	                        Configure billing in Stripe, then set <code>STRIPE_SECRET_KEY</code> and
	                        <code>STRIPE_WEBHOOK_SECRET</code> (or save them in Settings).
	                    </p>
	                    <div id="stripeAdminStatus">
	                        <div class="loading">Loading Stripe status...</div>
	                    </div>
	                </div>
	                <div class="section-card">
	                    <h3>Webhook Endpoint</h3>
	                    <div id="stripeAdminWebhook">
	                        <div class="loading">Loading webhook info...</div>
	                    </div>
	                </div>
	                <div class="section-card">
	                    <h3>Stripe Settings</h3>
	                    <div id="stripeAdminSettings">
	                        <div class="loading">Loading Stripe settings...</div>
	                    </div>
	                </div>
	            </section>

            <!-- Measurements Tab -->
            <section id="measurements-admin-tab" class="tab-content hidden">
                <div class="section-header">
                    <h2>Platform Measurements</h2>
                    <button class="btn-primary refresh-btn" onclick="loadMeasurements()">Refresh</button>
                </div>
                <div class="section-card">
                    <p style="color: var(--gray-600); margin-bottom: 10px;">
                        Trusted baselines are loaded from environment variables
                        (<code>TRUSTED_AGENT_MRTDS</code>, <code>TRUSTED_AGENT_RTMRS</code>).
                        Each node size has its own measuring enclave for per-size attestation.
                    </p>
                </div>
                <div id="measurementsAdminList">
                    <div class="loading">Loading measurements...</div>
                </div>
                <!-- Measurement visualizer modal -->
                <div id="measurementModal" class="modal hidden">
                    <div class="modal-overlay" onclick="closeMeasurementModal()"></div>
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2 id="measurementModalTitle">Measurements</h2>
                            <button class="modal-close" onclick="closeMeasurementModal()">&times;</button>
                        </div>
                        <div id="measurementDetails">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Tab -->
            <section id="settings-admin-tab" class="tab-content hidden">
                <div class="section-header">
                    <h2>Settings</h2>
                    <button class="btn-primary refresh-btn" onclick="loadSettings()">Refresh</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <button class="btn-small settings-group-btn active" data-group="" onclick="filterSettingsGroup('')">All</button>
                    <button class="btn-small settings-group-btn" data-group="cloudflare" onclick="filterSettingsGroup('cloudflare')">Cloudflare</button>
                    <button class="btn-small settings-group-btn" data-group="github_oauth" onclick="filterSettingsGroup('github_oauth')">GitHub OAuth</button>
                    <button class="btn-small settings-group-btn" data-group="stripe" onclick="filterSettingsGroup('stripe')">Stripe</button>
                    <button class="btn-small settings-group-btn" data-group="intel_ta" onclick="filterSettingsGroup('intel_ta')">Intel TA</button>
                    <button class="btn-small settings-group-btn" data-group="operational" onclick="filterSettingsGroup('operational')">Operational</button>
                    <button class="btn-small settings-group-btn" data-group="provisioner" onclick="filterSettingsGroup('provisioner')">Provisioner</button>
                    <button class="btn-small settings-group-btn" data-group="auth" onclick="filterSettingsGroup('auth')">Auth</button>
                </div>
                <div id="settingsAdminList">
                    <div class="loading">Loading settings...</div>
                </div>
            </section>

            <!-- Clouds Tab -->
            <section id="cloud-admin-tab" class="tab-content hidden">
                <div class="section-header">
                    <h2>Cloud Resources</h2>
                    <button class="btn-primary refresh-btn" onclick="loadCloudResources()">Refresh</button>
                </div>
                <div class="section-card">
                    <p style="color: var(--gray-600); margin-bottom: 10px;">
                        Observed cloud inventory derived from control-plane state (registered agents and deployments).
                    </p>
                    <div id="cloudSummaryCards" class="stats-grid">
                        <div class="loading">Loading cloud summary...</div>
                    </div>
                </div>
                <div class="section-card">
                    <h3>Per-Cloud Summary</h3>
                    <div id="cloudSummaryTable">
                        <div class="loading">Loading cloud rollups...</div>
                    </div>
                </div>
                <div class="section-card">
                    <h3>Agent Inventory</h3>
                    <div id="cloudAgentTable">
                        <div class="loading">Loading agent inventory...</div>
                    </div>
                </div>
                <div class="section-card">
                    <h3>Reconciliation (Control Plane vs Cloud)</h3>
                    <p style="color: var(--gray-600); margin: 10px 0;">
                        The control plane database is the source of truth for scheduling and shows agents that have registered.
                        External cloud inventory is queried separately (via the provisioner inventory webhook).
                        This view highlights mismatches (stale agents, or cloud VMs with no registered agent).
                    </p>
                    <div id="cloudReconcileSummary" class="stats-grid">
                        <div class="loading">Loading reconciliation...</div>
                    </div>
                    <div id="cloudReconcileTable">
                        <div class="loading">Loading reconciliation details...</div>
                    </div>
                </div>
	                <div class="section-card">
	                    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
	                        <h3 style="margin:0;">External Azure/GCP Inventory</h3>
	                        <div>
	                            <button id="externalCloudDryRunBtn" class="btn-small btn-secondary" onclick="externalCloudCleanup(true)">Dry Run Cleanup</button>
	                            <button id="externalCloudCleanupBtn" class="btn-small btn-danger" onclick="externalCloudCleanup(false)">Delete Orphaned Resources</button>
	                            <button id="unifiedOrphanDryRunBtn" class="btn-small btn-secondary" onclick="unifiedOrphanCleanup(true)">Dry Run All Orphans</button>
	                            <button id="unifiedOrphanCleanupBtn" class="btn-small btn-danger" onclick="unifiedOrphanCleanup(false)">Delete All Orphans</button>
	                        </div>
	                    </div>
                    <p style="color: var(--gray-600); margin: 10px 0;">
                        Live inventory from provisioner webhook (`AGENT_PROVISIONER_INVENTORY_URL`) cross-linked with registered agents.
                    </p>
                    <p style="color: var(--gray-600); margin: 10px 0;">
                        "All orphans" runs both: external cloud orphan cleanup and Cloudflare orphan cleanup (agent tunnels + DNS).
                    </p>
                    <div id="cloudExternalStatus" style="margin-bottom:10px;color:var(--gray-600);">Loading external inventory status...</div>
                    <div id="cloudExternalSummary" class="stats-grid">
                        <div class="loading">Loading external cloud summary...</div>
                    </div>
                    <div id="cloudExternalTable">
                        <div class="loading">Loading external cloud resources...</div>
                    </div>
                </div>
            </section>

            <!-- Cloudflare Tab -->
            <section id="cloudflare-admin-tab" class="tab-content hidden">
                <div class="section-header">
                    <h2>Cloudflare Resources</h2>
                    <button class="btn-primary refresh-btn" onclick="loadCloudflare()">Refresh</button>
                </div>
                <div id="cfNotConfigured" class="section-card hidden">
                    <p style="color: var(--gray-600);">Cloudflare is not configured. Set <code>CLOUDFLARE_ACCOUNT_ID</code>, <code>CLOUDFLARE_ZONE_ID</code>, and <code>CLOUDFLARE_API_TOKEN</code> environment variables.</p>
                </div>
                <div id="cfContent" class="hidden">
                    <div id="cfSummary" class="stats-grid"></div>
                    <p style="color: var(--gray-600); margin: 10px 0;">
                        Bulk cleanup only targets orphaned <code>agent-*</code> tunnels and their DNS records.
                        Control plane tunnels attached to <code>app.&lt;domain&gt;</code> or <code>app-staging.&lt;domain&gt;</code> are protected.
                        Older control plane tunnels not attached to those hostnames are treated as cleanup candidates.
                    </p>
                    <div id="cfCleanupBar" class="hidden" style="margin-bottom: 15px;">
                        <button class="btn-small btn-danger" onclick="cloudflareCleanup(this)">Cleanup All Orphaned Resources</button>
                    </div>
                    <div class="section-card">
                        <h3>Tunnels</h3>
                        <div id="cfTunnelsTable"><div class="loading">Loading tunnels...</div></div>
                    </div>
                    <div class="section-card">
                        <h3>DNS CNAME Records</h3>
                        <div id="cfDnsTable"><div class="loading">Loading DNS records...</div></div>
                    </div>
                </div>
            </section>

            <!-- Logs Tab -->
            <section id="logs-admin-tab" class="tab-content hidden">
                <div class="section-header">
                    <h2>Control Plane Logs</h2>
                    <div>
                        <select id="logLevelFilter" onchange="loadLogs()">
                            <option value="DEBUG">Debug+</option>
                            <option value="INFO" selected>Info+</option>
                            <option value="WARNING">Warning+</option>
                            <option value="ERROR">Error+</option>
                        </select>
                        <select id="logLinesFilter" onchange="loadLogs()">
                            <option value="100">100 lines</option>
                            <option value="200" selected>200 lines</option>
                            <option value="500">500 lines</option>
                            <option value="1000">1000 lines</option>
                        </select>
                        <label style="margin-left: 10px; cursor: pointer;">
                            <input type="checkbox" id="logAutoRefresh" onchange="toggleLogAutoRefresh()" checked> Auto-refresh
                        </label>
                        <button class="btn-primary" onclick="loadLogs()">Refresh</button>
                        <button class="btn-secondary" onclick="exportLogs()">Export</button>
                    </div>
                </div>
                <div id="logsViewer" class="log-viewer">
                    Loading logs...
                </div>

                <div class="section-header" style="margin-top: 20px;">
                    <h2>Container Logs</h2>
                    <div>
                        <select id="containerLogSince" onchange="loadContainerLogs()">
                            <option value="1m">Last 1 minute</option>
                            <option value="5m" selected>Last 5 minutes</option>
                            <option value="15m">Last 15 minutes</option>
                            <option value="1h">Last 1 hour</option>
                        </select>
                        <button class="btn-primary" onclick="loadContainerLogs()">Refresh</button>
                    </div>
                </div>
                <div id="containerLogsViewer" class="log-viewer">
                    Loading container logs...
                </div>
            </section>

            <!-- System Tab -->
            <section id="system-admin-tab" class="tab-content hidden">
                <div class="section-header">
                    <h2>System Status</h2>
                    <button class="btn-primary refresh-btn" onclick="loadSystem()">Refresh</button>
                </div>
                <div class="section-card">
                    <h3>Health Check</h3>
                    <div id="healthStatus">Loading...</div>
                </div>
                <div class="section-card">
                    <h3>Control Plane Info</h3>
                    <div id="systemInfo">Loading...</div>
                </div>
                <div class="section-card">
                    <h3>Danger Zone</h3>
                    <p style="color: var(--gray-600); margin-bottom: 15px;">These actions are destructive and cannot be undone.</p>
                    <button class="btn-small btn-danger" onclick="deleteAllAgents()">Delete All Agents</button>
                    <button class="btn-small btn-warning" onclick="resetFailedAgents()">Reset Failed Agents</button>
                </div>
            </section>
        </main>

        <footer>
            <div class="container">
                <p>EasyEnclave Admin Panel</p>
            </div>
        </footer>
    </div>

    <!-- Agent Details Modal -->
    <div id="agentModal" class="modal-overlay hidden" onclick="if(event.target===this)closeAgentModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="agentModalTitle">Agent Details</h2>
                <button class="modal-close" onclick="closeAgentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="agentStats" class="stats-grid"></div>
                <h3 style="margin-bottom: 10px;">Attestation</h3>
                <div id="agentAttestation" class="section-card" style="margin-bottom: 15px;">Loading attestation...</div>
                <h3 style="margin-bottom: 10px;">Container Logs</h3>
                <div style="margin-bottom: 10px;">
                    <select id="modalLogSince" onchange="refreshAgentLogs()">
                        <option value="1m">Last 1 minute</option>
                        <option value="5m" selected>Last 5 minutes</option>
                        <option value="15m">Last 15 minutes</option>
                        <option value="1h">Last 1 hour</option>
                    </select>
                    <button class="btn-small btn-secondary" onclick="refreshAgentLogs()">Refresh</button>
                </div>
                <div id="agentLogs" class="log-viewer" style="max-height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- App Version Details Modal -->
    <div id="appVersionModal" class="modal-overlay hidden" onclick="if(event.target===this)closeAppVersionModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="appVersionModalTitle">Version Details</h2>
                <button class="modal-close" onclick="closeAppVersionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="appVersionDetails"></div>
            </div>
        </div>
    </div>

    <script src="/static/admin.js?v=16"></script>
</body>
</html>
