# v2 Infra Decision - GCP Staging/Prod With Real TDX Nodes

Status: Locked

## Decision

Both staging and production run on GCP and must use real Intel TDX-capable nodes.

Local QEMU/KVM and synthetic fixtures remain valid for local development and CI, but they are not acceptable substitutes for staging or production validation.

## Environment Rules

- `dev/local`: emulation/mocks allowed
- `staging`: GCP only, real TDX-capable instances required
- `production`: GCP only, real TDX-capable instances required

## Platform Requirements

- Instance provisioning through GCP Compute APIs with service-account OAuth
- Confidential VM configuration compatible with Intel TDX attestation path
- Agent registration attestation validated end-to-end against Intel TA in staging/prod
- Cloud-init/bootstrap supports CP URL, bootstrap token, node size, datacenter, owner metadata

## Minimum Acceptance Gates

- Staging deploy job launches at least one real GCP TDX node and completes registration
- Staging smoke test verifies quote path, MRTD extraction, and workload deployment path
- Production rollout pipeline includes a preflight that confirms real TDX node type availability
- Capacity reconciler creates/fulfills launch orders against GCP real-node inventory

## Non-Goals

- Multi-cloud staging/prod in v2 initial rollout
- Emulated-node promotion to production

## Open Configuration Slots

These are required before rollout and intentionally remain unset in this doc:

- GCP project IDs for staging and production
- Quota targets per environment
- Service account identities and IAM scopes
- Network/subnet/firewall mappings

## Locked Zone Defaults

- Staging default zone: `us-central1-a`
- Production default zone: `us-central1-f`

These defaults are now used by the v2 scaffold unless environment overrides are set.

## Locked Machine Type Default

- Staging default machine type: `c3-standard-4`
- Production default machine type: `c3-standard-4`

## Current Network Default

- Default VPC network: `default`
- Default subnetwork: `default`

These remain the active defaults until explicit network names are provided.

## Attestation Enforcement Policy

- Staging: strict attestation enforcement required
- Production: strict attestation enforcement required
- Insecure attestation mode is allowed only for local/dev/test

## Cloudflare Hostname Policy (Locked)

- Hostname format: `<label>.<env-domain>`
- Staging env-domain: `stage.app.easyenclave.com`
- Production env-domain: `prod.app.easyenclave.com`
- `label` should come from caller-provided name when available and must be DNS-label-safe.
- Deploy API supports optional `agent_name` for selecting a specific pre-registered agent.
- If no label hint is provided during tunnel provisioning, runtime falls back to autogenerated label.

## Current GitHub Secret Naming

Observed naming in this repo (used by the v2 scaffold fallbacks):

- `STAGING_GCP_PROJECT_ID`
- `PRODUCTION_GCP_PROJECT_ID`
- `STAGING_GCP_SERVICE_ACCOUNT_KEY`
- `PRODUCTION_GCP_SERVICE_ACCOUNT_KEY`

Cloudflare values currently present in this repo:

- `CLOUDFLARE_ACCOUNT_ID`
- `CLOUDFLARE_ZONE_ID`
- `CLOUDFLARE_API_TOKEN`

Cloudflare env names accepted by v2 CP runtime:

- Generic: `CLOUDFLARE_ACCOUNT_ID`, `CLOUDFLARE_ZONE_ID`, `CLOUDFLARE_API_TOKEN`, `CLOUDFLARE_DOMAIN`
- Staging overrides: `STAGING_CLOUDFLARE_ACCOUNT_ID`, `STAGING_CLOUDFLARE_ZONE_ID`, `STAGING_CLOUDFLARE_API_TOKEN`, `STAGING_CLOUDFLARE_DOMAIN`
- Production overrides: `PRODUCTION_CLOUDFLARE_ACCOUNT_ID`, `PRODUCTION_CLOUDFLARE_ZONE_ID`, `PRODUCTION_CLOUDFLARE_API_TOKEN`, `PRODUCTION_CLOUDFLARE_DOMAIN`

Runtime guardrail:

- Staging/production startup now fails if Cloudflare tunnel config is missing.
- Staging/prod default domains are auto-applied when `*_CLOUDFLARE_DOMAIN` is not set.
- Local/dev/test may run without Cloudflare config and will return placeholder tunnel values.

Optional overrides for v2 runtime config:

- `STAGING_GCP_ZONE`
- `PRODUCTION_GCP_ZONE`
- `GCP_ZONE` (comma-separated fallback list)
- `GCP_NETWORK`
- `GCP_SUBNETWORK`
- `STAGING_GCP_SERVICE_ACCOUNT_EMAIL`
- `PRODUCTION_GCP_SERVICE_ACCOUNT_EMAIL`

## Phase Ownership

- Phase 11 owns core implementation and staging real-node smoke tests
- Phase 15 owns release pipeline enforcement for this decision
