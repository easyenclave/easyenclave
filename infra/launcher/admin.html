<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyEnclave Agent Console</title>
    <style>
        :root {
            --bg: #f2f5ef;
            --bg-2: #e8efe5;
            --card: #ffffff;
            --text: #10211b;
            --muted: #597067;
            --line: #d6e2db;
            --accent: #0f766e;
            --accent-2: #155e75;
            --danger: #b91c1c;
            --success: #166534;
            --warn: #92400e;
            --code-bg: #eef4f2;
            --shadow: 0 14px 30px rgba(16, 33, 27, 0.08);
            --radius: 14px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: "IBM Plex Sans", "Avenir Next", "Trebuchet MS", "Segoe UI", sans-serif;
            color: var(--text);
            background:
                radial-gradient(circle at 10% 0%, #d5ece6 0%, transparent 35%),
                radial-gradient(circle at 100% 0%, #d8e3f4 0%, transparent 30%),
                linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
            min-height: 100vh;
            line-height: 1.45;
        }

        .container {
            max-width: 1160px;
            margin: 0 auto;
            padding: 20px;
        }

        .hidden { display: none !important; }

        .login-shell {
            min-height: 100vh;
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .login-box {
            width: min(420px, 100%);
            background: var(--card);
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--line);
            overflow: hidden;
        }

        .login-head {
            padding: 24px;
            background: linear-gradient(135deg, #0f766e 0%, #155e75 100%);
            color: #ecfeff;
        }

        .login-head h1 {
            font-family: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace;
            letter-spacing: 0.03em;
            font-size: 1.2rem;
            margin-bottom: 6px;
        }

        .login-head p {
            color: rgba(236, 254, 255, 0.85);
            font-size: 0.9rem;
        }

        .login-body {
            padding: 22px;
        }

        .login-box input {
            width: 100%;
            padding: 11px 12px;
            border: 1px solid var(--line);
            border-radius: 10px;
            margin-bottom: 14px;
            font-size: 0.95rem;
            color: var(--text);
            background: #fbfdfc;
        }

        .login-box input:focus {
            outline: 2px solid rgba(15, 118, 110, 0.25);
            border-color: var(--accent);
        }

        .error-msg {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: none;
            font-size: 0.88rem;
        }

        .btn {
            border: none;
            border-radius: 10px;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            padding: 10px 14px;
            transition: transform 0.14s ease, background 0.14s ease, opacity 0.14s ease;
        }

        .btn:hover { transform: translateY(-1px); }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #f0fdfa;
        }

        .btn-primary:hover { background: linear-gradient(135deg, #115e59 0%, #164e63 100%); }

        .btn:disabled { opacity: 0.65; cursor: not-allowed; transform: none; }

        header {
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 1px solid var(--line);
            backdrop-filter: blur(8px);
            background: rgba(242, 245, 239, 0.9);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            padding: 14px 20px;
        }

        .title-wrap h1 {
            font-size: 1.2rem;
            font-family: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace;
            letter-spacing: 0.03em;
        }

        .title-wrap p {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .meta-chip {
            background: #e7f4f1;
            color: #0f766e;
            border: 1px solid #c8e8e2;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.78rem;
            font-weight: 600;
        }

        .page-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: 1.1fr 1fr;
            align-items: start;
            margin-top: 18px;
        }

        .full-width { grid-column: 1 / -1; }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 18px;
        }

        .card h2 {
            font-size: 1rem;
            letter-spacing: 0.01em;
        }

        .section-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        td {
            padding: 9px 6px;
            border-bottom: 1px solid var(--line);
            vertical-align: top;
            font-size: 0.92rem;
        }

        td:first-child {
            color: var(--muted);
            width: 170px;
            font-size: 0.82rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 600;
        }

        code {
            background: var(--code-bg);
            border: 1px solid var(--line);
            padding: 2px 6px;
            border-radius: 8px;
            font-family: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace;
            font-size: 0.8rem;
            overflow-wrap: anywhere;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .status::before {
            content: "";
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: currentColor;
            opacity: 0.85;
        }

        .status.healthy, .status.deployed {
            color: var(--success);
            background: #dcfce7;
            border: 1px solid #bbf7d0;
        }

        .status.deploying, .status.starting, .status.attesting, .status.registering, .status.waiting_for_health, .status.building, .status.setup, .status.undeploying {
            color: var(--warn);
            background: #fef3c7;
            border: 1px solid #fde68a;
        }

        .status.unhealthy, .status.error, .status.rejected {
            color: var(--danger);
            background: #fee2e2;
            border: 1px solid #fecaca;
        }

        .status.undeployed {
            color: #334155;
            background: #e2e8f0;
            border: 1px solid #cbd5e1;
        }

        #containers table td:first-child {
            text-transform: none;
            letter-spacing: 0;
            font-size: 0.9rem;
            color: var(--text);
            width: auto;
        }

        .empty {
            color: var(--muted);
            font-size: 0.9rem;
            font-style: italic;
            padding: 6px 0;
        }

        #statsGrid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }

        .metric-card {
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 12px;
            background: linear-gradient(180deg, #f9fcfb 0%, #f2f7f5 100%);
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 2px;
        }

        .metric-detail {
            font-size: 0.74rem;
            color: var(--muted);
        }

        #measurementMeta {
            font-size: 0.84rem;
            color: var(--muted);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .log-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        select {
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 8px 10px;
            background: #fff;
            color: var(--text);
            font-size: 0.86rem;
        }

        .log-viewer {
            border-radius: 12px;
            border: 1px solid #0f172a;
            background: #0b1220;
            color: #d8e4ff;
            padding: 14px;
            font-family: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace;
            font-size: 0.78rem;
            max-height: 420px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .log-entry { margin-bottom: 4px; }

        @media (max-width: 980px) {
            .page-grid { grid-template-columns: 1fr; }
            .header-row { padding: 12px 16px; }
            .container { padding: 16px; }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-shell">
        <div class="login-box">
            <div class="login-head">
                <h1>Agent Console</h1>
                <p>Authenticate to inspect deployment, attestation, and runtime state.</p>
            </div>
            <div class="login-body">
                <div id="loginError" class="error-msg"></div>
                <form onsubmit="login(event)">
                    <input type="password" id="password" placeholder="Admin password" required autofocus>
                    <button type="submit" class="btn btn-primary" style="width:100%">Open Console</button>
                </form>
            </div>
        </div>
    </div>

    <div id="adminPage" class="hidden">
        <header>
            <div class="container header-row">
                <div class="title-wrap">
                    <h1>EasyEnclave Agent Console</h1>
                    <p>Live node telemetry, deployment state, and attestation evidence.</p>
                </div>
                <span class="meta-chip">Auto refresh: 30s</span>
            </div>
        </header>

        <main class="container">
            <div class="page-grid">
                <section class="card">
                    <div class="section-head">
                        <h2>Identity & Deployment</h2>
                        <button class="btn btn-primary" onclick="refresh()">Refresh Now</button>
                    </div>
                    <table id="statusTable">
                        <tr><td>Loading...</td><td></td></tr>
                    </table>
                </section>

                <section class="card">
                    <div class="section-head">
                        <h2>Containers</h2>
                    </div>
                    <div id="containers" class="empty">Loading...</div>
                </section>

                <section class="card full-width">
                    <div class="section-head">
                        <h2>System Metrics</h2>
                    </div>
                    <div id="statsGrid">Loading...</div>
                </section>

                <section class="card full-width">
                    <div class="section-head">
                        <h2>TDX Measurements</h2>
                        <button id="reattestBtn" class="btn btn-primary" onclick="reattestNow()">Re-attest Now</button>
                    </div>
                    <div id="measurementMeta">Loading...</div>
                    <table id="measurementTable">
                        <tr><td>Loading...</td><td></td></tr>
                    </table>
                </section>

                <section class="card full-width">
                    <div class="section-head">
                        <h2>Container Logs</h2>
                        <div class="log-controls">
                            <select id="logSince" onchange="loadLogs()">
                                <option value="1m">Last 1m</option>
                                <option value="5m" selected>Last 5m</option>
                                <option value="15m">Last 15m</option>
                                <option value="1h">Last 1h</option>
                            </select>
                            <button class="btn btn-primary" onclick="loadLogs()">Refresh</button>
                        </div>
                    </div>
                    <div id="logViewer" class="log-viewer">Loading...</div>
                </section>
            </div>
        </main>
    </div>

    <script>
        let token = sessionStorage.getItem("agentToken");
        if (token) {
            showDashboard();
        } else {
            fetch("/api/auth/methods").then(r => r.json()).then(m => {
                if (m.generated_password) {
                    document.getElementById("password").value = m.generated_password;
                    const err = document.getElementById("loginError");
                    err.textContent = "Auto-generated password (set ADMIN_PASSWORD to use your own)";
                    err.style.display = "block";
                    err.style.color = "#0f766e";
                    err.style.background = "#ccfbf1";
                    err.style.borderColor = "#99f6e4";
                }
            }).catch(() => {});
        }

        async function login(e) {
            e.preventDefault();
            const pw = document.getElementById("password").value;
            const err = document.getElementById("loginError");
            try {
                const r = await fetch("/api/login", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({password: pw})
                });
                if (r.ok) {
                    const d = await r.json();
                    token = d.token;
                    sessionStorage.setItem("agentToken", token);
                    showDashboard();
                } else {
                    err.textContent = "Invalid password";
                    err.style.display = "block";
                }
            } catch (e) {
                err.textContent = "Connection error";
                err.style.display = "block";
            }
        }

        function showDashboard() {
            document.getElementById("loginPage").classList.add("hidden");
            document.getElementById("adminPage").classList.remove("hidden");
            refresh();
        }

        async function apiFetch(url, options = {}) {
            const headers = Object.assign({}, options.headers || {}, {"Authorization": "Bearer " + token});
            const r = await fetch(url, Object.assign({}, options, {headers}));
            if (r.status === 401) {
                sessionStorage.removeItem("agentToken");
                location.reload();
            }
            let data = {};
            try {
                data = await r.json();
            } catch (_e) {
                data = {};
            }
            if (!r.ok) {
                throw new Error(data.error || data.detail || ("HTTP " + r.status));
            }
            return data;
        }

        function fmtBytes(b) {
            if (!b) return "0 B";
            const u = ["B", "KB", "MB", "GB", "TB"];
            const i = Math.floor(Math.log(b) / Math.log(1024));
            return (b / Math.pow(1024, i)).toFixed(1) + " " + u[i];
        }

        function fmtUptime(s) {
            const d = Math.floor(s / 86400), h = Math.floor((s % 86400) / 3600), m = Math.floor((s % 3600) / 60);
            return d > 0 ? d + "d " + h + "h" : h > 0 ? h + "h " + m + "m" : m + "m";
        }

        function fmtAgo(seconds) {
            if (seconds == null || seconds < 0) return "unknown";
            if (seconds < 60) return seconds + "s ago";
            if (seconds < 3600) return Math.floor(seconds / 60) + "m ago";
            if (seconds < 86400) return Math.floor(seconds / 3600) + "h ago";
            return Math.floor(seconds / 86400) + "d ago";
        }

        function statCard(label, value, detail) {
            return `<div class="metric-card"><div class="metric-label">${label}</div><div class="metric-value">${value}</div>${detail ? '<div class="metric-detail">' + detail + '</div>' : ''}</div>`;
        }

        async function refresh() {
            try {
                const s = await apiFetch("/api/status");
                document.getElementById("statusTable").innerHTML = `
                    <tr><td>Agent ID</td><td><code>${s.agent_id || "N/A"}</code></td></tr>
                    <tr><td>VM Name</td><td>${s.vm_name || "N/A"}</td></tr>
                    <tr><td>Status</td><td><span class="status ${s.status}">${s.status}</span></td></tr>
                    <tr><td>Installed App</td><td>${s.deployed_app ? `<code>${s.deployed_app}</code>` : "None"}</td></tr>
                    <tr><td>Deployment ID</td><td>${s.deployment_id ? `<code>${s.deployment_id}</code>` : "None"}</td></tr>
                    <tr><td>Datacenter</td><td>${s.datacenter ? `<code>${s.datacenter}</code>` : "Unknown"}</td></tr>
                    <tr><td>Control Plane</td><td><code>${s.control_plane || "N/A"}</code></td></tr>
                `;

                const c = await apiFetch("/api/admin/containers");
                if (c.containers && c.containers.length > 0) {
                    document.getElementById("containers").innerHTML = "<table>" +
                        c.containers.map(x => `<tr><td><code>${x.name}</code></td><td><span class="status ${x.status}">${x.status}</span></td></tr>`).join("") +
                        "</table>";
                } else {
                    document.getElementById("containers").innerHTML = "<div class=\"empty\">No containers running</div>";
                }

                loadStats();
                loadMeasurements();
                loadLogs();
            } catch (e) {
                console.error(e);
            }
        }

        async function loadMeasurements() {
            const table = document.getElementById("measurementTable");
            const meta = document.getElementById("measurementMeta");
            try {
                const data = await apiFetch("/api/admin/measurements");
                const m = (data && data.measurements) ? data.measurements : {};
                const source = data.source || "none";
                const updatedAt = data.updated_at || "N/A";
                const age = fmtAgo(data.age_seconds);
                meta.innerHTML = `Source: <code>${source}</code> | Last update: <code>${updatedAt}</code> (${age}) | Refresh path: <code>${data.refresh_hint || "/api/health?attest=true"}</code>`;
                const rows = [];
                rows.push(`<tr><td>MRTD</td><td><code>${m.mrtd || "N/A"}</code></td></tr>`);
                rows.push(`<tr><td>RTMR0</td><td><code>${m.rtmr0 || "N/A"}</code></td></tr>`);
                rows.push(`<tr><td>RTMR1</td><td><code>${m.rtmr1 || "N/A"}</code></td></tr>`);
                rows.push(`<tr><td>RTMR2</td><td><code>${m.rtmr2 || "N/A"}</code></td></tr>`);
                rows.push(`<tr><td>RTMR3</td><td><code>${m.rtmr3 || "N/A"}</code></td></tr>`);
                table.innerHTML = rows.join("");
            } catch (e) {
                meta.textContent = "Failed to load measurement metadata";
                table.innerHTML = `<tr><td>Error</td><td>${e.message}</td></tr>`;
            }
        }

        async function reattestNow() {
            const btn = document.getElementById("reattestBtn");
            const original = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Re-attesting...";
            try {
                await apiFetch("/api/admin/reattest", {method: "POST"});
                await refresh();
            } catch (e) {
                alert("Re-attestation failed: " + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = original;
            }
        }

        async function loadStats() {
            try {
                const st = await apiFetch("/api/admin/stats");
                document.getElementById("statsGrid").innerHTML =
                    statCard("CPU", (st.cpu_percent || 0) + "%", "Load: " + (st.load_avg || []).map(x => x.toFixed(2)).join(", ")) +
                    statCard("Memory", (st.memory_percent || 0) + "%", (st.memory_used_gb || 0).toFixed(1) + " / " + (st.memory_total_gb || 0).toFixed(1) + " GB") +
                    statCard("Disk", (st.disk_percent || 0) + "%", (st.disk_used_gb || 0).toFixed(1) + " / " + (st.disk_total_gb || 0).toFixed(1) + " GB") +
                    statCard("Network", "↑ " + fmtBytes(st.net_bytes_sent), "↓ " + fmtBytes(st.net_bytes_recv)) +
                    statCard("Uptime", fmtUptime(st.uptime_seconds || 0), "");
            } catch (e) {
                document.getElementById("statsGrid").innerHTML = "<div class=\"empty\">Failed to load stats</div>";
            }
        }

        async function loadLogs() {
            const since = document.getElementById("logSince").value;
            const l = await apiFetch("/api/admin/logs?since=" + since);
            const viewer = document.getElementById("logViewer");
            if (l.logs && l.logs.length > 0) {
                viewer.innerHTML = l.logs.map(x => {
                    const name = x.container || "unknown";
                    return `<div class="log-entry">[${name}] ${x.line}</div>`;
                }).join("");
                viewer.scrollTop = viewer.scrollHeight;
            } else {
                viewer.innerHTML = "No logs";
            }
        }

        setInterval(refresh, 30000);
    </script>
</body>
</html>
