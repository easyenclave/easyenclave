# EasyEnclave TDX VM Image
#
# Builds a dm-verity protected rootfs for attestable TDX VMs.
# The root filesystem is read-only and cryptographically bound
# to the boot measurements via the roothash in the kernel cmdline.
#
# Usage: mkosi build (or `make build` from this directory)

[Distribution]
Distribution=ubuntu
Release=noble

[Output]
Format=disk
ImageId=easyenclave
CompressOutput=false
# Split output so we get separate kernel/initrd/rootfs artifacts
SplitArtifacts=true
# Make build reproducible
Seed=e4570c1a-2024-4e45-a8e0-c1a0e0000001

[Content]
# Base packages for a minimal TDX VM
Packages=
    systemd
    systemd-resolved
    udev
    dbus
    kmod
    iproute2
    ca-certificates
    curl
    jq
    python3
    python3-requests
    python3-psutil
    linux-image-generic
    docker-ce
    docker-ce-cli
    containerd.io
    docker-buildx-plugin
    docker-compose-plugin
    cloudflared

# Don't install recommended packages to keep image small
WithRecommends=false

# Clean up package cache
CleanPackageMetadata=true

# Inject third-party apt repos/GPG keys before package installation.
# The mkosi.pkg-manager/ tree is populated by the Makefile before build.
PackageManagerTrees=mkosi.pkg-manager

# Skeleton tree (fstab, systemd units, etc.)
SkeletonTrees=mkosi.skeleton

# Prepare script downloads optional non-apt binaries (runs with network access)
PrepareScripts=mkosi.prepare

# Post-install script for service enablement and config (no network)
PostInstallationScripts=mkosi.postinst

# Extra trees are populated by the Makefile (launcher files)
ExtraTrees=mkosi.extra

# Make build reproducible
SourceDateEpoch=0

[Validation]
# dm-verity is configured via mkosi.repart partition definitions
# (00-root.conf Verity=data, 10-root-verity.conf Verity=hash)
SignExpectedPcr=false
