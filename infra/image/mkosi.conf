# EasyEnclave TDX VM Image
#
# Builds a dm-verity protected rootfs for attestable TDX VMs.
# The root filesystem is read-only and cryptographically bound
# to the boot measurements via the roothash in the kernel cmdline.
#
# Usage: mkosi build (or `make build` from this directory)

[Distribution]
Distribution=ubuntu
Release=noble

[Output]
Format=disk
ImageId=easyenclave
CompressOutput=false
# Split UKI and disk so we get a separate .efi artifact for objcopy extraction
SplitArtifacts=true
# Make build reproducible
Seed=e4570c1a-2024-4e45-a8e0-c1a0e0000001

[Content]
# Build a UKI (Unified Kernel Image) that embeds kernel + initrd + cmdline
# with the roothash automatically derived from the verity partitions.
# We extract the boot artifacts from the UKI using objcopy at build time.
Bootable=yes
Bootloader=systemd-boot
Initrds=initrd
KernelCommandLine=console=tty0 console=ttyS0,115200
KernelModulesInitrdInclude=
    dm-verity
    dm-mod

# Base packages for a minimal TDX VM (from default Ubuntu repos only)
Packages=
    systemd
    systemd-resolved
    udev
    dbus
    kmod
    iproute2
    ca-certificates
    curl
    jq
    python3
    python3-requests
    python3-psutil
    linux-image-generic

# Don't install recommended packages to keep image small
WithRecommends=false

# Clean up package cache
CleanPackageMetadata=true

# Skeleton tree (fstab, systemd units, etc.)
SkeletonTrees=mkosi.skeleton

# Post-install script adds third-party repos and installs Docker/cloudflared
PostInstallationScripts=mkosi.postinst

# Extra trees are populated by the Makefile (launcher files)
ExtraTrees=mkosi.extra

# Make build reproducible
SourceDateEpoch=0

# Network access needed for PostInstallationScripts to add third-party apt repos
WithNetwork=true

[Validation]
# dm-verity is configured via mkosi.repart partition definitions
# (10-root.conf Verity=data, 20-root-verity.conf Verity=hash)
SignExpectedPcr=false
