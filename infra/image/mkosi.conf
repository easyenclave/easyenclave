# EasyEnclave TDX VM Image
#
# Builds a dm-verity protected rootfs for attestable TDX VMs.
# The root filesystem is read-only and cryptographically bound
# to the boot measurements via the roothash in the kernel cmdline.
#
# Usage: mkosi build (or `make build` from this directory)

[Distribution]
Distribution=ubuntu
Release=noble

[Output]
Format=disk
ImageId=easyenclave
CompressOutput=false
# Split output so we get separate kernel/initrd/rootfs artifacts
SplitArtifacts=true

[Content]
# Base packages for a minimal TDX VM
Packages=
    systemd
    systemd-resolved
    udev
    dbus
    kmod
    iproute2
    ca-certificates
    curl
    jq
    python3
    python3-requests
    python3-psutil
    linux-image-generic

# Don't install recommended packages to keep image small
WithRecommends=false

# Clean up package cache
CleanPackageMetadata=true

# Skeleton tree (fstab, systemd units, etc.)
SkeletonTrees=mkosi.skeleton

# Post-install script for Docker, cloudflared, etc.
PostInstallationScripts=mkosi.postinst

# Extra trees are populated by the Makefile (launcher files)
ExtraTrees=mkosi.extra

# Make build reproducible
Seed=easyenclave-2024
SourceDateEpoch=0

[Validation]
# Enable dm-verity for root filesystem integrity
Verity=data
# Sign with auto-generated key (roothash is what matters for attestation)
SignExpectedPcr=false
